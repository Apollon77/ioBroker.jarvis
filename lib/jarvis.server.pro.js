const _got=require("got");const _ip=require("ip");const _os=require("os");const _schedule=require("node-schedule");const _shajs=require("sha.js");const Encryption=require("./encryption");const{random}=require("./helpers");module.exports={renewProLicence(e,t){this.adapter.log.debug("Renew licence...");const i={...t,action:"getInvoicesBySubscriptionId",email:e.subscriber.email_address,subscriptionId:e.subscriptionId};return _got.post("https://www.zefau.net/jarvis/user/invoice.php",{json:i}).then(e=>{const t=e.body&&JSON.parse(e.body)||[];const i=t.pop();const s=i.expires*1e3;if(i.token&&s>Date.now()){this.adapter.setState("info.pro",JSON.stringify(i.token,null,3),true)}})},verifyProLicence(){return new Promise((m,w)=>{this.adapter.getState("info.pro",(e,s)=>{const t=random(1e3,9999);const i=Date.now();const r=_shajs("sha256").update(i+"-"+t+"-bfceea54-998e-4f30-adf0-d0ff894e4a54").digest("hex");const a={token:r,random:t,ts:i};if(!e&&s&&s.val){try{const n=JSON.parse(s.val);const{signature:o,ioBrokerId:c,...d}=n;const h=Encryption.verify(d,o,["-----BEGIN PUBLIC KEY-----","MIIBITANBgkqhkiG9w0BAQEFAAOCAQ4AMIIBCQKCAQB3DHXL321K/qm0H7pac0pZ","4hIBVgqOU3k6d8ti/gWRqrIvtC4BjFaZ5EtHD/tgPtb2eQKZFhxg/ZjQ7pgkWiqq","hs022REErUUtVFZDdovJkxQYkpqKYwjprjUMkEBna4hrugqpTfzTTOQShGULYEBB","gw9NFGff/NxTiOt4yyXFOkMJf7t8AYRWAoVpFYp5X+bI5mKEo8AzWZyKQY6n13Wx","ZWLUK9f8+ZEPgKU0LFiqMwEDwBO4af5Wqo8wdbnbWP7Ejo5qcrfOgEdGKXq9egza","ZuQy5K/b+mhtcDqtIVK1aAuGU/mBjjwCl0nft7PYMBd6pbq4c2rWCa4GRViC1reh","AgMBAAE=","-----END PUBLIC KEY-----"].join("\r\n"));if(h.verification===false){this.adapter.setState("info.connection",false,true);const u="Pro licence is invalid!";this.adapter.log.warn(u);setTimeout(()=>this.adapter.terminate?this.adapter.terminate(u,11):process.exit(11),2e3);return w(u)}else{const p=n.expires*1e3;const l=p+5*24*3600*1e3;const f=p-5*24*3600*1e3;const g=p-1*24*3600*1e3;if(l<Date.now()){this.adapter.log.debug("Removed outdated pro-licence");this.adapter.setState("info.pro","",true)}if(f<Date.now()){this.adapter.log.warn("Your Pro-Licence is about to expire ("+new Date(p).toISOString()+")! With an active PayPal subscription the licence will be renewed automatically!");this.adapter.log.warn("Die Pro-Lizenz läuft demnächst ab ("+new Date(p).toISOString()+")! Sofern ein aktives PayPal-Abo besteht, wird die Lizenz automatisch aktualisiert!")}if(g<Date.now()){this.renewProLicence(n,a)}this.adapter.getForeignObject("system.meta.uuid",(e,t)=>{if(!e&&t&&t.native){const i={...a,action:"setPro",intIp:_ip.address(),signature:n.signature,pro:s.val,version:this.adapter.version,ioBrokerId:t.native.uuid,system:JSON.stringify({hostname:_os.hostname(),architecture:_os.arch(),platform:_os.platform(),release:_os.release()})};_got.post("https://www.zefau.net/jarvis/user/details.php",{json:i}).catch(e=>{this.adapter.log.warn(e.message);return w(e.message)})}return m()})}}catch(e){this.adapter.log.warn(e.message);return w(e.message)}}})})},pro(){if(this.adapter.config.scheduledHour===undefined||this.adapter.config.scheduledMinute===undefined){this.adapter.getForeignObject("system.adapter."+this.adapter.namespace,(e,t)=>{if(e||!t||!t.native){return false}const i=random(0,59);const s=random(0,23);t.native={...t.native,scheduledHour:s,scheduledMinute:i};this.adapter.setForeignObject(t._id,t)})}else{this.adapter.log.debug("Scheduled for "+this.adapter.config.scheduledHour+":"+this.adapter.config.scheduledMinute);this.schedulers.verifyProLicence=_schedule.scheduleJob(this.adapter.config.scheduledMinute+" "+this.adapter.config.scheduledHour+" * * *",()=>this.verifyProLicence().catch(e=>{}));this.verifyProLicence().catch(e=>{})}}};