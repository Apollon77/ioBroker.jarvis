const{createHash}=require("crypto");const{random}=require("./helpers");const{verify}=require("./encryption");const axios=require("axios");const crypto=require("crypto");const ip=require("ip");const os=require("os");const schedule=require("node-schedule");module.exports={renewProLicence(e,t){this.adapter.log.debug("Renew licence...");const i={...t,action:"getInvoicesBySubscriptionId",email:e.subscriber.email_address,subscriptionId:e.subscriptionId};return axios.post("https://www.zefau.net/jarvis/user/invoice.php",i).then(e=>{const t=e.data&&JSON.parse(e.data)||[];const i=t.pop();const r=i.expires*1e3;if(i.token&&r>Date.now()){this.adapter.setState("info.pro",JSON.stringify(i.token,null,3),true)}}).catch(e=>{this.adapter.log.warn("Failed renewing licence: "+e.message);return e.message})},verifyProLicence(){return new Promise((m,w)=>{this.adapter.getState("info.pro",(e,r)=>{const t=random(1e3,9999);const i=Date.now();const a=crypto.createHash("sha256").update(i+"-"+t+"-bfceea54-998e-4f30-adf0-d0ff894e4a54").digest("hex");const s={token:a,random:t,ts:i};if(!e&&r&&r.val){try{const n=JSON.parse(r.val);const{signature:o,ioBrokerId:c,...d}=n;const h=verify(d,o,["-----BEGIN PUBLIC KEY-----","MIIBITANBgkqhkiG9w0BAQEFAAOCAQ4AMIIBCQKCAQB3DHXL321K/qm0H7pac0pZ","4hIBVgqOU3k6d8ti/gWRqrIvtC4BjFaZ5EtHD/tgPtb2eQKZFhxg/ZjQ7pgkWiqq","hs022REErUUtVFZDdovJkxQYkpqKYwjprjUMkEBna4hrugqpTfzTTOQShGULYEBB","gw9NFGff/NxTiOt4yyXFOkMJf7t8AYRWAoVpFYp5X+bI5mKEo8AzWZyKQY6n13Wx","ZWLUK9f8+ZEPgKU0LFiqMwEDwBO4af5Wqo8wdbnbWP7Ejo5qcrfOgEdGKXq9egza","ZuQy5K/b+mhtcDqtIVK1aAuGU/mBjjwCl0nft7PYMBd6pbq4c2rWCa4GRViC1reh","AgMBAAE=","-----END PUBLIC KEY-----"].join("\r\n"));if(h.verification===false){this.adapter.setState("info.connection",false,true);const p="Pro licence is invalid!";this.adapter.log.warn(p);setTimeout(()=>this.adapter.terminate?this.adapter.terminate(p,11):process.exit(11),2e3);return w(p)}else{const u=n.expires*1e3;const l=u+5*24*3600*1e3;const f=u-5*24*3600*1e3;const g=u-1*24*3600*1e3;if(l<Date.now()){this.adapter.log.debug("Removed outdated pro-licence");this.adapter.setState("info.pro","",true)}if(f<Date.now()){this.adapter.log.warn("Your Pro-Licence is about to expire ("+new Date(u).toISOString()+")! With an active PayPal subscription the licence will be renewed automatically!");this.adapter.log.warn("Die Pro-Lizenz läuft demnächst ab ("+new Date(u).toISOString()+")! Sofern ein aktives PayPal-Abo besteht, wird die Lizenz automatisch aktualisiert!")}if(g<Date.now()){this.renewProLicence(n,s)}this.adapter.getForeignObject("system.meta.uuid",(e,t)=>{if(!e&&t&&t.native){const i={...s,action:"setPro",intIp:ip.address(),signature:n.signature,pro:r.val,version:this.adapter.version,ioBrokerId:t.native.uuid,system:JSON.stringify({hostname:os.hostname(),architecture:os.arch(),platform:os.platform(),release:os.release()})};axios.post("https://www.zefau.net/jarvis/user/details.php",i).catch(e=>{this.adapter.log.warn("Failed: "+e.message);return w(e.message)})}return m()})}}catch(e){this.adapter.log.warn(e.message);return w(e.message)}}})})},pro(){this.verifyProLicence().catch(e=>{});if(this.adapter.config.scheduledHour===undefined||this.adapter.config.scheduledMinute===undefined){this.adapter.getForeignObject("system.adapter."+this.adapter.namespace,(e,t)=>{if(e||!t||!t.native){return false}const i=random(0,59);const r=random(0,23);t.native={...t.native,scheduledHour:r,scheduledMinute:i};this.adapter.setForeignObject(t._id,t)})}else{this.adapter.log.debug("Scheduled for "+this.adapter.config.scheduledHour+":"+this.adapter.config.scheduledMinute);this.schedulers.verifyProLicence=schedule.scheduleJob(this.adapter.config.scheduledMinute+" "+this.adapter.config.scheduledHour+" * * *",()=>this.verifyProLicence().catch(e=>{}));this.verifyProLicence().catch(e=>{})}}};