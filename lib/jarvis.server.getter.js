const{encrypt}=require("./encryption");const axios=require("axios");const fs=require("fs");const os=require("os");const path=require("path");module.exports={getConfig({cb:e}){e({config:this.adapter.config})},getGroups(){return new Promise(s=>{this.adapter.getObjectView("system","group",null,(e,t)=>{if(e||!t){return reject(e)}s(t.rows)})})},getLogs({cb:t},l={}){this.adapter.log.debug("Get logs with options: "+JSON.stringify(l));let e=l.date;if(!e){const o=new Date;e=o.getFullYear()+"-"+("0"+(o.getMonth()+1)).substr(-2)+"-"+("0"+o.getDate()).substr(-2)}const s=this.adapter.systemConfig.log.transport.file1;const r=path.resolve(this.adapter.systemConfig.dataDir+"../"+s.filename+"."+e+""+s.fileext);const u=[];fs.readFile(r,"utf-8",(e,s)=>{if(e){return t({err:e})}const r=s.substr(0,4);let o=0;s=s.split("\n"+r).reverse();for(let t of s){t=o?r+t:t;const a=new Date(t.substr(0,23)).getTime();const i=["silly","debug","info","warn","error"].find(e=>t.indexOf(e)!==-1);const n=t.indexOf(": ")+2;const c=t.substr(n).indexOf("host")===-1?t.substr(n,t.indexOf(" (")-n):t.substr(n,t.indexOf(" ",n)-n);let e=t.substr(n).replace(/(?:\r\n|\r|\n)/g," ").replace(c+" ","");e=t.substr(n).indexOf("host")===-1?e.substr(e.indexOf(") ")+2):e;u.push({from:c,ts:a,severity:i,message:e});o++;if(l.rowsMaxTotal&&o===l.rowsMaxTotal){break}}t({err:null,logs:u})})},getObject({cb:s},r){this.adapter.getForeignObject(r,(e,t)=>{e=e||t===null&&"Object empty";t=t===null?null:{...t||{},id:r};s({err:e,object:t})})},getObjects({cb:t},r){let s=[];["device","channel","state"].forEach(e=>{s.push(new Promise(s=>{this.adapter.getForeignObjects(r||"*",e,(e,t)=>s({err:e,objects:t}))}))});let o=null;let a={};Promise.all(s).then(e=>{e.forEach(e=>{o=o||e.err;a={...a,...e.objects}});Object.keys(a).forEach(e=>{delete a[e].acl;const t=e.substr(0,e.indexOf(".",e.indexOf(".")+1));if(t&&!a[t]){a[t]={_id:t,type:"adapter"}}if(e.indexOf("system.adapter")>-1||e.indexOf("system.host")>-1||e.indexOf(".")===-1){delete a[e]}});t({err:o,objects:a})})},getObjectView({cb:s},e,t,r){this.adapter.getObjectView(e,t,r,(e,t)=>{s({err:e,objects:t&&t.rows||[]})})},getRooms({cb:t}){this.adapter.getEnums("rooms",(e,s)=>{if(e){t({err:e,rooms:{}});return}const r={};Object.keys(s["enum.rooms"]).map(e=>{const t=s["enum.rooms"][e];r[e.replace("enum.rooms.","").toLowerCase()]={members:t.common.members||[],name:t.common.name||"",id:e}});t({err:e,rooms:r})})},getState({cb:s,clientId:e},r,t={}){t=t||{};const o=this.clients[e]||{};this.adapter.getForeignState(r,{...t,user:t.user||o.userId||this.options.user},(e,t)=>{if(!e&&!t){e=new Error(r+" is not a valid state (in getState)")}t=!t?null:{...t,id:r};s({err:e,stateId:r,state:t})})},getStates({cb:s,clientId:e},t,r={}){r=r||{};const o=this.clients[e]||{};this.adapter.getForeignStates(t,{...r,user:r.user||o.userId||this.options.user},(e,t)=>{s({err:e,states:t})})},getUsers(a=false){const e=a?this.getGroups():Promise.resolve();return e.then(o=>{return new Promise((s,r)=>{this.adapter.getObjectView("system","user",null,(e,t)=>{if(e||!t){return r(e)}s(!a?t.rows:t.rows.map(t=>{t.value.groups=o.filter(e=>e.value.common.members.includes(t.value.user));return t}))})})})},getSystemInformation({cb:e}){e({hostname:os.hostname(),architecture:os.arch(),platform:os.platform(),release:os.release()})},getTime({cb:e}){e(Date.now())},readFile({cb:s},e){e=path.resolve(e.replace("{dirname}",__dirname));fs.readFile(e,"utf-8",(e,t)=>{s({err:e,data:t})})},request({cb:t},s){try{if(s._encrypt&&s.body.data){s.data=encrypt(s.body.data,"KutTGsNQ8HCX$hrT9Ua5beRSs2BLVeQq");delete s._encrypt}axios(s).then(e=>{t({_options:s,data:e.data||""})}).catch(e=>{this.adapter.log.warn("Warning requesting data from "+s.url+": "+e.message);t({err:e})})}catch(e){this.adapter.log.warn("Warning requesting data from "+s.url+": "+e.message);t({err:e})}},subscribeState({cb:e,clientId:t},s){this.subscribedStates[s]=this.subscribedStates[s]||{};this.subscribedStates[s][t]=true;this.getState({cb:e},s)},subscribeLog({cb:e,clientId:t},s){this.subscribedLog[t]=true;if(s.getInitialLogs){return this.getLogs({cb:e},s)}e({err:null,logs:[]})}};