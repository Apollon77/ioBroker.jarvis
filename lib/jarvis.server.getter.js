const _fs=require("fs");const _os=require("os");const _got=require("got");const _path=require("path");const Encryption=require("./encryption");module.exports={getConfig({cb:e}){e({config:this.adapter.config})},getLogs({cb:t},d={}){this.adapter.log.debug("Get logs with options: "+JSON.stringify(d));let e=d.date;if(!e){const o=new Date;e=o.getFullYear()+"-"+("0"+(o.getMonth()+1)).substr(-2)+"-"+("0"+o.getDate()).substr(-2)}const s=this.adapter.systemConfig.log.transport.file1;const r=_path.resolve(this.adapter.systemConfig.dataDir+"../"+s.filename+"."+e+""+s.fileext);const b=[];_fs.readFile(r,"utf-8",(e,s)=>{if(e){return t({err:e})}const r=s.substr(0,4);let o=0;s=s.split("\n"+r).reverse();for(let t of s){t=o?r+t:t;const a=new Date(t.substr(0,23)).getTime();const i=["silly","debug","info","warn","error"].find(e=>t.indexOf(e)!==-1);const n=t.indexOf(": ")+2;const c=t.substr(n).indexOf("host")===-1?t.substr(n,t.indexOf(" (")-n):t.substr(n,t.indexOf(" ",n)-n);let e=t.substr(n).replace(/(?:\r\n|\r|\n)/g," ").replace(c+" ","");e=t.substr(n).indexOf("host")===-1?e.substr(e.indexOf(") ")+2):e;b.push({from:c,ts:a,severity:i,message:e});o++;if(d.rowsMaxTotal&&o===d.rowsMaxTotal){break}}t({err:null,logs:b})})},getObject({cb:s},r){this.adapter.getForeignObject(r,(e,t)=>{e=e||t===null&&"Object empty";t=t===null?null:{...t||{},id:r};s({err:e,object:t})})},getObjects({cb:t},r){let s=[];["device","channel","state"].forEach(e=>{s.push(new Promise(s=>{this.adapter.getForeignObjects(r||"*",e,(e,t)=>s({err:e,objects:t}))}))});let o=null;let a={};Promise.all(s).then(e=>{e.forEach(e=>{o=o||e.err;a={...a,...e.objects}});Object.keys(a).forEach(e=>{delete a[e].acl;const t=e.substr(0,e.indexOf(".",e.indexOf(".")+1));if(t&&!a[t]){a[t]={_id:t,type:"adapter"}}if(e.indexOf("system.adapter")>-1||e.indexOf("system.host")>-1||e.indexOf(".")===-1){delete a[e]}});t({err:o,objects:a})})},getObjectView({cb:s},e,t,r){this.adapter.getObjectView(e,t,r,(e,t)=>{s({err:e,objects:t&&t.rows||[]})})},getRooms({cb:t}){this.adapter.getEnums("rooms",(e,s)=>{if(e){t({err:e,rooms:{}});return}const r={};Object.keys(s["enum.rooms"]).map(e=>{const t=s["enum.rooms"][e];r[e.replace("enum.rooms.","").toLowerCase()]={members:t.common.members||[],name:t.common.name||"",id:e}});t({err:e,rooms:r})})},getState({cb:s},r){this.adapter.getForeignState(r,{user:this.options.user},(e,t)=>{if(!e&&!t){e=new Error(r+" is not a valid state (in getState)")}t=!t?null:{...t,id:r};s({err:e,stateId:r,state:t})})},getStates({cb:s},e){this.adapter.getForeignStates(e,{user:this.options.user},(e,t)=>{s({err:e,states:t})})},getSystemInformation({cb:e}){e({hostname:_os.hostname(),architecture:_os.arch(),platform:_os.platform(),release:_os.release()})},getTime({cb:e}){e((new Date).getTime())},readFile({cb:s},e){e=_path.resolve(e.replace("{dirname}",__dirname));_fs.readFile(e,"utf-8",(e,t)=>{s({err:e,data:t})})},request({cb:t},s){try{if(s._encrypt&&s.body.data){s.body.data=Encryption.encrypt(s.body.data,"KutTGsNQ8HCX$hrT9Ua5beRSs2BLVeQq");delete s._encrypt}if(s.json===true&&s.body){s.json=s.body;delete s.body}_got(s).then(e=>{t({_options:s,data:e.body||""})}).catch(e=>{this.adapter.log.warn("Warning requesting data from "+s.url+": "+e.message);t({err:e})})}catch(e){this.adapter.log.warn("Warning requesting data from "+s.url+": "+e.message);t({err:e})}},subscribeState({cb:e,clientId:t},s){this.subscribedStates[s]=this.subscribedStates[s]||{};this.subscribedStates[s][t]=true;this.getState({cb:e},s)},subscribeLog({cb:e,clientId:t},s){this.subscribedLog[t]=true;if(s.getInitialLogs){return this.getLogs({cb:e},s)}e({err:null,logs:[]})},verifyLogin({cb:t},e,s){this.adapter.checkPassword(e,s,e=>{t({login:e})})}};