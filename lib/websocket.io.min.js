const _crypto=require("crypto");const _fs=require("fs");const _path=require("path");const _got=require("got");const{Server}=require("socket.io");const EventEmitter=require("events");const _ip=require("ip");const _uuid=require("uuid").t;const _hash=require("object-hash");const _semver=require("semver");const _os=require("os");const _platform=require("platform");class ioWebSocket extends EventEmitter{constructor(t=null,e={}){super();if(!t){throw new Error("No adapter instance passed to WebSocket constructor!")}this.i=t;this.h=e||{};if(this.h.o&&this.h.o.indexOf("system.user.")===-1){this.h.o="system.user."+this.h.o}this.h.port=e.port||8400;this.h.l=e.l||null;this.u=null;this.p=null;this.g={};this.m={};this.connect();this.cache={};this.i.S(true);this.i.v("*");this._();this.I();this.i.C("admin.0.info.updatesJson",(t,e)=>{if(!t&&e){try{this.cache["O"]=JSON.parse(e.j)}catch(t){delete this.cache["O"]}this._()}});this.i.N("stateChange",(t,e)=>{if(t.startsWith("javascript.0.scriptEnabled.")&&e&&e.T===true){this.A()}else if(t==="admin.0.info.updatesJson"&&e){try{this.cache["O"]=JSON.parse(e.j)}catch(t){delete this.cache["O"]}}})}A(){this.cache["k"]=this.cache["k"]||{hash:null,data:{}};this.i.q("system","script",null,(t,e)=>{const n={};e.rows=e.rows||[];e.rows.forEach(t=>{const e=t.id.replace("script.js.","");const s=e.substr(0,e.lastIndexOf("."));const i=e.substr(0,e.indexOf("."));t=t.value;t.disabled=!t.enabled;delete t.J.source;n[s]=n[s]||{id:s,children:[]};n[s].children.push({...t.J,P:t.H,id:e});n[s].children.sort((t,e)=>t.id.toLowerCase()===e.id.toLowerCase()?0:t.id.toLowerCase()>e.id.toLowerCase()?1:-1)});let i={};Object.keys(n).sort().reverse().forEach(t=>{const e=t.indexOf(".")===-1;if(e){i={[t]:n[t],...i}}else{const s=t.substr(0,t.lastIndexOf("."));n[s]=n[s]||{id:s,children:[]};n[s].children=[].concat(n[t],n[s].children)}});const s=_hash(i);if(this.cache["k"].hash!==s){this.i.log.debug("Push update of scripts..");this.cache["k"]={hash:s,data:i};for(const h in this.m){if(this.m[h].K&&this.m[h].K["k"]){this.m[h].K["k"].forEach(t=>{this.m[h].B(t,i)})}}}})}_(){this.cache["D"]=this.cache["D"]||{hash:null,data:{}};this.i.q("system","instance",{L:"system.adapter.",W:"system.adapter.é¦™"},(t,e)=>{const r={};if(!t&&e&&e.rows){e.rows.forEach(async t=>{const e=t.id.replace("system.adapter.","");r[e]={...t.value.J,U:t.id,id:e};const s=await this.i.R(t.U+".alive");const i=await this.i.R(t.U+".connected");const n=await this.i.R(e+".info.connection");r[e].F=s?s.j:null;r[e].V=i?i.j:null;r[e].G=n?n.j:null;const h=this.cache["O"]&&this.cache["O"][r[e].name]&&this.cache["O"][r[e].name].M||r[e].version;r[e].update=h&&r[e].version&&_semver.X(h,r[e].version)===true?h:null;delete r[e].$;delete r[e].Y});const s=Object.keys(r).sort().reduce((t,e)=>{t[e]=r[e];return t},{});const i=_hash(s);if(this.cache["D"].hash!==i){this.i.log.debug("Push update of instances..");this.cache["D"]={hash:i,data:s};for(const n in this.m){if(this.m[n].K&&this.m[n].K["D"]){this.m[n].K["D"].forEach(t=>{this.m[n].B(t,s)})}}}}})}I(){this.Z=setInterval(()=>{this._();this.A()},30*1e3)}tt(t){const e=t.et;if(t.event==="disconnect"){delete this.g[e];delete this.m[e];this.B("CLIENT_LIST",this.g)}else if(t.event==="clients"){const{event:s,...i}=t;this.g[t.id]={...i,H:Date.now()};this.B("CLIENT_LIST",this.g)}else if(t.event==="getAdapterInstances"||t.event==="getScriptStatuses"){const n=t.event.replace("get","");if(this.m[e]&&this.m[e].K&&this.m[e].K[n]&&this.cache[n]){this.m[e].K[n].forEach(t=>{this.m[e].B(t,this.cache[n].data)})}}}connect(){const t=_ip.address();const e=_os.hostname();this.i.log.debug("Connection: ioBroker host detected with "+e+" (IP: "+t+")");const s=(t,e)=>{e.st(501);e.end("This is the jarvis socket.io port!")};if(this.h.l!==null){const n={...this.h.l,it:true};this.u=require("http2").nt(n,s);this.i.log.debug("Connection: Using secure HTTPS-Server")}else{this.u=require("http").ht(s);this.i.log.debug("Connection: Using non-secure HTTP-Server")}let i=this.i.ot.rt?this.i.ot.rt.replace(/, /g,",").split(","):[];i=i.concat(["localhost","127.0.0.1",t,e]);this.i.log.debug("Connection: Using options: "+JSON.stringify(this.h.connection||{}));this.p=new Server({path:"/jarvis-socket/",ct:true,at:12e4,lt:3e4,...this.h.connection||{},ut:{origin:(e,t)=>{e=e||"(direct access to the port)";this.i.log.debug("Connection: Origin detected with "+e+"...");const s=!this.h.dt||this.h.dt==="all"||this.h.dt==="list"&&e&&i.some(t=>e.indexOf(t)>-1);if(s){this.i.log.debug("Connection: Origin detected with "+e+" (allowed due to "+(this.h.dt||"all")+")");return t(null,e)}this.i.log.debug("Connection: Origin detected with "+e+" (rejected, not in "+i.join(", ")+")");return t("Access from domain not allowed")}}});this.p.ft(this.u);this.p.N("error",t=>{this.i.log.error(t.message);this.i.log.debug(JSON.stringify(t))});this.p.N("connection",t=>{this.i.log.info("Client connecting...");const e=t.request.headers["yt"];const s=_platform.parse(e);const i=s.name;const n=t.bt.gt.indexOf(":")!==-1?t.bt.gt.substr(t.bt.gt.lastIndexOf(":")+1):t.bt.gt;const h=n.replace(/\./g,"-")+"_"+i.replace(/ /g,"-");const r=_uuid(h,"d03b9915-564d-491e-a0e0-7ef4af0a52d1");this.g[r]={userAgent:e,St:s,vt:i,_t:n,It:h,id:r,H:Date.now()};this.m[r]=new ioWebSocketClient(this.i,this.h,this.g[r],t,t=>this.tt(t));this.B("CLIENT_NEW",this.g[r]);this.B("CLIENT_LIST",this.g);this.i.log.info("Client with IP "+this.g[r]._t+" connected")});this.u.Ct(this.h.port,"0.0.0.0",()=>{this.i.log.info("Connection: WebSocket opened on port "+this.u.address().port+(this.h.l!==null?" using https":" using http")+"...")})}}class ioWebSocketClient{constructor(t,e,s,i,n){this.i=t;this.h=e;this.wt=n;this.i.log.debug("Websocket-Handler for client initialized");this.Ot=s;this.jt=i;this.Nt=Date.now();this.i.Tt("clients."+this.Ot.It,{type:"device",J:{name:this.Ot._t},Et:{}},()=>this.At());this.B("_clientId",this.Ot.id);this.B("_version",this.i.version);this.jt.N("ping",()=>this.kt());const r={};this.jt.N("message",t=>{try{const{messageId:e,index:s,length:i,chunk:n}=t;r[e]=r[e]||{};r[e][s]=n;if(Object.keys(r[e]).length===i){const h=Object.values(r[e]).join("");this.qt(h);delete r[e]}}catch(t){this.i.log.warn(t.message||t)}});this.jt.N("disconnect",t=>this.disconnect(t));this.K={};this.Jt={};this.Pt={};this.i.N("stateChange",(t,e)=>this.Ht(t,e));this.i.N("log",t=>this.Kt(t));this.xt=setInterval(()=>{if(this.Nt&&this.Nt<Date.now()-30*1e3){this.disconnect("Client timeout")}},60*1e3);this.Bt=setInterval(()=>{for(const e in this.Pt){const{messageId:s,stateId:i,options:t}=this.Pt[e];this.Dt(s,e,i,t)}},2*60*1e3)}disconnect(t){this.Nt=0;this.i.log.debug("Client with IP "+this.Ot._t+" disconnected: "+t);this.i.Lt("clients."+this.Ot.It+".connected",false,true);clearInterval(this.xt);clearInterval(this.Bt);this.wt({et:this.Ot.id,event:"disconnect"})}At(){const o={connected:{name:"Indicates client connection",role:"indicator.connected",type:"boolean",value:true},_t:{name:"Client IP",role:"info.ip",type:"string",value:this.Ot._t},id:{name:"Client ID",role:"text",type:"string",value:this.Ot.id},userAgent:{name:"Client User Agent",role:"text",type:"string",value:this.Ot.userAgent},St:{name:"Client Platform Information",role:"text",type:"json",value:this.Ot.St},vt:{name:"Client Browser",role:"text",type:"string",value:this.Ot.vt},Wt:{name:"Client Last Seen",role:"value.time",type:"number",value:Date.now()}};Object.keys(o).forEach(t=>{const s="clients."+this.Ot.It+"."+t;const{role:e,type:i,value:n,initial:h,subscribe:r}=o[t];this.i.Ut(s,{type:"state",J:{role:e,type:i},Et:{}},(t,e)=>{if(e&&h||n!==undefined){this.i.Lt(s,typeof n==="object"?JSON.stringify(n,null,3):n,true)}})});const t="clients."+this.Ot.It+".setTabId";this.i.Ut(t,{type:"state",J:{role:"text",type:"string",write:true},Et:{}},()=>{});this.wt({...this.Ot,event:"clients"})}kt(){this.jt.B("pong");this.Nt=Date.now();this.At()}Kt(t){this.B("_log",t)}Ht(e,s){if(this.Jt&&this.Jt[e]&&Array.isArray(this.Jt[e])){this.Jt[e].forEach(t=>this.B(t,s&&s.T!==undefined&&s.H!==undefined&&s.from!==undefined?{state:s}:{Rt:new Error(e+" is not a valid state")}))}else if(e.endsWith(".setTabId")&&s&&s.j){this.i.Lt(e,"",true);this.B("_setTabId",s.j)}}qt(i){try{const n=JSON.parse(i);let{messageId:t,command:e,params:s=[]}=n;s=Array.isArray(s)?s:[s];e&&this[e](t,...s)}catch(t){this.i.log.warn(t.message||t);this.i.log.debug(i)}}B(s,t={},i="message"){this.i.log.Ft("Send message with ID "+s);if(t.Rt){t.Rt={name:t.Rt.name,message:t.Rt.message,stack:t.Rt.stack}}else if(t.Rt===null){t.Rt="_isNull"}const e=JSON.stringify(t).match(/.{1,100000}/g);const n=e.length;e.forEach((t,e)=>{this.jt.B(i,{Qt:s,index:e,length:n,Vt:t})})}log(t,e,s){const i=s.map(t=>{return typeof t==="object"?JSON.stringify(t):t});this.i.log[e||"info"](i.join(", "));this.B(t)}zt(s,t="current"){const e=this.i.Mt.log.transport.Gt;const i=_path.resolve(this.i.Mt.Xt+"../"+e.filename+"."+t+""+e.$t);_fs.Yt(i,"utf-8",(t,e)=>{if(t){this.B(s,{Rt:t});return}const o=e.substr(0,4);e=e.split("\n"+o);e=e.map((e,t)=>{e=t?o+e:e;const s=e.indexOf(": ")+2;const i=e.substr(s).indexOf("host")===-1?e.substr(s,e.indexOf(" (")-s):e.substr(s,e.indexOf(" ",s)-s);const n=new Date(e.substr(0,23)).getTime();const h=["silly","debug","info","warn","error"].find(t=>e.indexOf(t)!==-1);const r=e.substr(s).replace(/(?:\r\n|\r|\n)/g," ");return{from:i,H:n,Zt:h,message:r}});e=e.reverse();this.B(s,{Rt:null,te:e})})}ee(t){this.B(t,{ot:this.i.ot})}Yt(s,t){t=_path.resolve(t.replace("{dirname}",__dirname));_fs.Yt(t,"utf-8",(t,e)=>{this.B(s,{Rt:t,data:e})})}sign(t,e,s,i="RSA-SHA512"){e=typeof e!=="string"?JSON.stringify(e):e;let n=null;let h=null;try{const r=crypto.se(i);r.update(e);h=r.sign(s,"base64")}catch(t){this.i.log.warn(t.message);n=t}this.B(t,{Rt:n,data:e,privateKey:s,signature:h,algorithm:i,ie:verification})}verify(t,e,s,i,n="RSA-SHA512"){e=typeof e!=="string"?JSON.stringify(e):e;let h=null;let r=false;try{r=_crypto.verify(n,Buffer.from(e),i,Buffer.from(s,"base64"))}catch(t){this.i.log.warn(t.message);h=t}this.B(t,{Rt:h,data:e,publicKey:i,signature:s,algorithm:n,ie:r})}encrypt(t,e,s,i="AES-256-CTR"){let n=null;let h=null;try{const r=_crypto.ne(16).toString("hex").substr(0,16);const o=_crypto.he(i,_crypto.re("sha256").update(s).digest("hex").substr(0,32),r);h=Buffer.from(r).toString("base64").substr(0,24)+":"+o.update(typeof e==="object"?JSON.stringify(e):e,"utf8","base64")+o.oe("base64")}catch(t){this.i.log.warn(t.message);n=t}this.B(t,{Rt:n,ce:e,ae:h})}decrypt(t,e,s,i="AES-256-CTR"){let n=null;let h=null;try{const[r,o]=e.split(":");const c=_crypto.le(i,_crypto.re("sha256").update(s).digest("hex").substr(0,32),Buffer.from(r,"base64"));h=Buffer.concat([c.update(Buffer.from(o,"base64")),c.oe()]).toString()}catch(t){this.i.log.warn(t.message);n=t}this.B(t,{Rt:n,hash:e,ue:h})}request(e,s){try{if(s.de&&s.body.data){s.body.data=encrypt(s.body.data,"KutTGsNQ8HCX$hrT9Ua5beRSs2BLVeQq");delete s.de}if(s.json===true&&s.body){s.json=s.body;delete s.body}_got(s).then(t=>{this.B(e,{h:s,data:t.body||""})}).catch(t=>{this.B(e,{Rt:t});this.i.log.warn(t.message)})}catch(t){this.B(e,{Rt:t});this.i.log.warn(t.message)}}pe(s,i,n,t){i="system.adapter."+i;this.i.fe(i,(t,e)=>{if(t||!e){this.B(s,{Rt:t});return}e.J.enabled=n;this.i.ye(i,e,t=>{this.wt("getAdapterInstances");this.B(s,{Rt:t})})})}ge(t,e,s,i){this.Lt(t,"javascript.0.scriptEnabled."+e,s,i)}Lt(e,t,s,i,n=null){this.i.me(t,s,i||false,{o:this.h.o},t=>{this.B(e,{Rt:t});n&&n()})}be(t){this.wt({et:this.Ot.id,event:"get"+t})}Se(t,e){this.K[e]=this.K[e]||[];if(this.K[e].indexOf(t)===-1){this.K[e].push(t)}this.be(e)}ve(s,i){this.i.fe(i,(t,e)=>{e={...e||{},id:i};this.B(s,{Rt:t,object:e})})}_e(e,i){let s=[];["device","channel","state"].forEach(t=>{s.push(new Promise(s=>{this.i.Ie(i||"*",t,(t,e)=>s({Rt:t,Ce:e}))}))});let n=null;let h={};Promise.all(s).then(t=>{t.forEach(t=>{n=n||t.Rt;h={...h,...t.Ce}});Object.keys(h).forEach(t=>{const e=t.substr(0,t.indexOf(".",t.indexOf(".")+1));if(e&&!h[e]){h[e]={U:e,type:"adapter"}}if(t.indexOf("system.adapter")>-1||t.indexOf("system.host")>-1||t.indexOf(".")===-1){delete h[t]}});this.B(e,{Rt:n,Ce:h})})}q(s,t,e,i,n){this.i.q(t,e,i,(t,e)=>{this.B(s,{Rt:t,Ce:e&&e.rows||[]})})}getState(s,i){this.i.C(i,{o:this.h.o},(t,e)=>{if(!t&&(!e||e&&e.T===undefined&&e.H===undefined&&e.from===undefined)){t=new Error(i+" is not a valid state")}this.B(s,{Rt:t,state:e})})}we(s,t){this.i.Oe(t,{o:this.h.o},(t,e)=>{this.B(s,{Rt:t,je:e})})}unsubscribe(t,e,s,i){this.i.log.debug("unsubscribe ("+i+"): "+s+" | "+e);if(e==="history"&&s&&this.Pt[s]){delete this.Pt[s];this.B(t,{Ne:s,type:e,Te:i,Rt:null})}else if(e==="state"&&i&&this.Ee[i]){delete this.Ee[i];this.B(t,{Ne:s,type:e,Te:i,Rt:null})}else{this.B(t,{Ne:s,Te:i,Rt:"Not found"})}}Ee(t,e){this.Jt[e]=this.Jt[e]||[];if(this.Jt[e].indexOf(t)===-1){this.Jt[e].push(t)}this.getState(t,e)}Ae(t,e,s,i){this.i.log.debug("subscribeHistory ("+s+"): "+e+" | "+JSON.stringify(i));if(!this.Pt[e]){this.Pt[e]={Ne:e,Qt:t,Te:s,options:i};this.Dt(t,e,s,{...i,force:true})}else{this.B(t,{Ne:e,Rt:null,hash:this.Pt[e].hash,history:this.Pt[e].history})}}Dt(i,n,h,r={}){this.i.log.debug("getHistory ("+h+"): "+n+" | "+JSON.stringify(r));r.start=r.start||Date.now()-r.ke;r.end=r.end||Date.now();r.qe=r.qe||"history.0";Promise.allSettled([this.i.R("system.adapter."+r.qe+".alive"),this.i.R("system.adapter."+r.qe+".connected")]).then(t=>{const e=!t.some(t=>t.status!=="fulfilled"||(!t.value||t.value&&t.value.j!==true));if(!e){throw new Error(r.qe+" not reachable")}return e}).then(()=>{this.i.Dt(h,r,(t,e)=>{if(!t&&e){const s=e.length;if(this.Pt[n]&&(r.force===true||s!==this.Pt[n].hash)){this.i.log.debug("getHistory ("+h+"): Update");this.Pt[n].history=e;this.Pt[n].hash=s;this.B(i,{Ne:n,Rt:t,hash:s,history:e})}else{this.B(i,{Ne:n,Rt:t,hash:s,history:null,Je:true})}}else{this.B(i,{Ne:n,Rt:t,hash:null,history:null})}})}).catch(t=>{this.B(i,{Ne:n,Rt:t,hash:null,history:null})})}Pe(t){this.B(t,{hostname:_os.hostname(),He:_os.Ke(),platform:_os.platform(),release:_os.release()})}}module.exports=ioWebSocket;