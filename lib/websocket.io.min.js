const _crypto=require("crypto"),_fs=require("fs"),_path=require("path"),_got=require("got"),Server=require("socket.io")["Server"],EventEmitter=require("events"),_ip=require("ip"),_uuid=require("uuid").v5,_hash=require("object-hash"),_semver=require("semver"),_os=require("os");class ioWebSocket extends EventEmitter{constructor(t=null,e={}){if(super(),!t)throw new Error("No adapter instance passed to WebSocket constructor!");this._adapter=t,this._options=e||{},this._options.user&&-1===this._options.user.indexOf("system.user.")&&(this._options.user="system.user."+this._options.user),this._options.port=e.port||8400,this._options.certificates=e.certificates||null,this.server=null,this.wss=null,this.clients={},this.sockets={},this.connect(),this.cache={},this._adapter.requireLog(!0),this._adapter.subscribeForeignStates("*"),this.getAdapterInstances(),this.updateAdapterInstances(),this._adapter.getForeignState("admin.0.info.updatesJson",(t,e)=>{if(!t&&e){try{this.cache.AdapterUpdates=JSON.parse(e.val)}catch(t){delete this.cache.AdapterUpdates}this.getAdapterInstances()}}),this._adapter.on("stateChange",(t,e)=>{if(t.startsWith("javascript.0.scriptEnabled.")&&e&&!0===e.ack)this.getScriptStatuses();else if("admin.0.info.updatesJson"===t&&e)try{this.cache.AdapterUpdates=JSON.parse(e.val)}catch(t){delete this.cache.AdapterUpdates}})}getScriptStatuses(){this.cache.ScriptStatuses=this.cache.ScriptStatuses||{hash:null,data:{}},this._adapter.getObjectView("system","script",null,(t,e)=>{const i={};e.rows=e.rows||[],e.rows.forEach(t=>{const e=t.id.replace("script.js.","");var s=e.substr(0,e.lastIndexOf("."));e.substr(0,e.indexOf("."));(t=t.value).disabled=!t.enabled,delete t.common.source,i[s]=i[s]||{id:s,children:[]},i[s].children.push({...t.common,created:t.ts,id:e}),i[s].children.sort((t,e)=>t.id.toLowerCase()===e.id.toLowerCase()?0:t.id.toLowerCase()>e.id.toLowerCase()?1:-1)});let s={};Object.keys(i).sort().reverse().forEach(t=>{var e;-1===t.indexOf(".")?s={[t]:i[t],...s}:(e=t.substr(0,t.lastIndexOf(".")),i[e]=i[e]||{id:e,children:[]},i[e].children=[].concat(i[t],i[e].children))});e=_hash(s);if(this.cache.ScriptStatuses.hash!==e){this._adapter.log.debug("Push update of scripts.."),this.cache.ScriptStatuses={hash:e,data:s};for(const r in this.sockets)this.sockets[r]._subscribeOthers&&this.sockets[r]._subscribeOthers.ScriptStatuses&&this.sockets[r]._subscribeOthers.ScriptStatuses.forEach(t=>{this.sockets[r].emit(t,s)})}})}getAdapterInstances(){this.cache.AdapterInstances=this.cache.AdapterInstances||{hash:null,data:{}},this._adapter.getObjectView("system","instance",{startkey:"system.adapter.",endkey:"system.adapter.é¦™"},(t,e)=>{const r={};if(!t&&e&&e.rows){e.rows.forEach(async t=>{var e=t.id.replace("system.adapter.","");r[e]={...t.value.common,_id:t.id,id:e};var s=await this._adapter.getForeignStateAsync(t._id+".alive"),i=await this._adapter.getForeignStateAsync(t._id+".connected"),t=await this._adapter.getForeignStateAsync(e+".info.connection");r[e].alive=s?s.val:null,r[e].connectedToHost=i?i.val:null,r[e].connectedToInstance=t?t.val:null;t=this.cache.AdapterUpdates&&this.cache.AdapterUpdates[r[e].name]&&this.cache.AdapterUpdates[r[e].name].availableVersion||r[e].version;r[e].update=!0===_semver.gt(t,r[e].version)?t:null,delete r[e].docs,delete r[e].desc,delete r[e].news,delete r[e].titleLang});const s=Object.keys(r).sort().reduce((t,e)=>(t[e]=r[e],t),{});e=_hash(s);if(this.cache.AdapterInstances.hash!==e){this._adapter.log.debug("Push update of instances.."),this.cache.AdapterInstances={hash:e,data:s};for(const i in this.sockets)this.sockets[i]._subscribeOthers&&this.sockets[i]._subscribeOthers.AdapterInstances&&this.sockets[i]._subscribeOthers.AdapterInstances.forEach(t=>{this.sockets[i].emit(t,s)})}}})}updateAdapterInstances(){this.intervalInstancesRefresh=setInterval(()=>{this.getAdapterInstances(),this.getScriptStatuses()},6e4)}eventFromClient(t){const e=t.clientId;if("disconnect"===t.event&&(delete this.clients[e],delete this.sockets[e],this.emit("CLIENT_LIST",this.clients)),"getAdapterInstances"===t.event||"getScriptStatuses"===t.event){const s=t.event.replace("get","");this.sockets[e]._subscribeOthers&&this.sockets[e]._subscribeOthers[s]&&this.cache[s]&&this.sockets[e]._subscribeOthers[s].forEach(t=>{this.sockets[e].emit(t,this.cache[s].data)})}}connect(){var t=_ip.address(),e=_os.hostname();this._adapter.log.debug("Connection: ioBroker host detected with "+e+" (IP: "+t+")");var s,i=(t,e)=>{e.writeHead(501),e.end("This is the jarvis socket.io port!")};null!==this._options.certificates?(s={...this._options.certificates,allowHTTP1:!0},this.server=require("http2").createSecureServer(s,i),this._adapter.log.debug("Connection: Using secure HTTPS-Server")):(this.server=require("http").createServer(i),this._adapter.log.debug("Connection: Using non-secure HTTP-Server"));let r=this._adapter.config.hostWhitelist?this._adapter.config.hostWhitelist.replace(/, /g,",").split(","):[];r=r.concat(["localhost","127.0.0.1",t,e]),this._adapter.log.debug("Connection: Using options: "+JSON.stringify(this._options.connection||{})),this.wss=new Server({path:"/jarvis-socket/",allowEIO3:!0,pingInterval:12e4,pingTimeout:3e4,...this._options.connection||{},cors:{origin:(e,t)=>{return e=e||"(direct access to the port)",this._adapter.log.debug("Connection: Origin detected with "+e+"..."),!this._options.hostAllow||"all"===this._options.hostAllow||"list"===this._options.hostAllow&&e&&r.some(t=>-1<e.indexOf(t))?(this._adapter.log.debug("Connection: Origin detected with "+e+" (allowed due to "+(this._options.hostAllow||"all")+")"),t(null,e)):(this._adapter.log.debug("Connection: Origin detected with "+e+" (rejected, not in "+r.join(", ")+")"),t("Access from domain not allowed"))}}}),this.wss.attach(this.server),this.wss.on("error",t=>{this._adapter.log.error(t.message),this._adapter.log.debug(JSON.stringify(t))}),this.wss.on("connection",t=>{this._adapter.log.info("Client connecting...");var e=_uuid(t.conn.remoteAddress.replace(/\./g,"-").replace(/\:/g,"")+"-"+t.request.headers["user-agent"],"d03b9915-564d-491e-a0e0-7ef4af0a52d1");this.clients[e]={"user-agent":t.request.headers["user-agent"],ip:t.conn.remoteAddress,id:e},this.sockets[e]=new ioWebSocketClient(this._adapter,this._options,{...this.clients[e],socket:t},t=>this.eventFromClient(t)),this.emit("CLIENT_NEW",this.clients[e]),this.emit("CLIENT_LIST",this.clients),this._adapter.log.info("Client with IP "+this.clients[e].ip+" connected")}),this.server.listen(this._options.port,"0.0.0.0",()=>{this._adapter.log.info("Connection: WebSocket opened on port "+this.server.address().port+(null!==this._options.certificates?" using https":" using http")+"...")})}}class ioWebSocketClient{constructor(t,e,s,i){this._adapter=t,this._options=e,this._parentMessage=i,this._adapter.log.debug("Websocket-Handler for client initialized"),this._client=s,this._socket=s.socket,this._isAlive=Date.now(),this._adapter.setObject("clients."+this._client.id,{type:"device",common:{name:this._client.ip},native:{}},()=>this.updateStates()),this.emit("_clientId",this._client.id),this._socket.on("ping",()=>this.heartbeat()),this._socket.on("message",t=>{this.handleMessage(t)}),this._socket.on("disconnect",t=>this.disconnect(t)),this._subscribeOthers={},this._subscribeStates={},this._subscribeHistory={},this._adapter.on("stateChange",(t,e)=>this.handleStateChange(t,e)),this._adapter.on("log",t=>this.handleLogChange(t)),this.intervalClientTimeout=setInterval(()=>{this._isAlive&&this._isAlive<Date.now()-3e4&&this.disconnect("Client timeout")},6e4),this.intervalHistoryRefresh=setInterval(()=>{for(const i in this._subscribeHistory){var{messageId:t,stateId:e,options:s}=this._subscribeHistory[i];this.getHistory(t,i,e,s)}},12e4)}disconnect(t){this._isAlive=0,this._adapter.log.debug("Client with IP "+this._client.ip+" disconnected: "+t),this._adapter.setState("clients."+this._client.id+".connected",!1,!0),clearInterval(this.intervalClientTimeout),clearInterval(this.intervalHistoryRefresh),this._parentMessage({clientId:this._client.id,event:"disconnect"})}updateStates(){const n={connected:{name:"Indicates client connection",role:"indicator.connected",type:"boolean",value:!0},ip:{name:"Client IP",role:"info.ip",type:"string",value:this._client.ip},userAgent:{name:"Client User Agent",role:"text",type:"string",value:this._client["user-agent"]},userBrowser:{name:"Client Browser Information",role:"text",type:"json",value:""},lastSeen:{name:"Client Last Seen",role:"value.time",type:"number",value:Date.now()}};Object.keys(n).forEach(t=>{const s="clients."+this._client.id+"."+t,{role:e,type:i,value:r,initial:a}=n[t];this._adapter.setObjectNotExists(s,{type:"state",common:{role:e,type:i},native:{}},(t,e)=>{(e&&a||void 0!==r)&&this._adapter.setState(s,r,!0)})});var t="clients."+this._client.id+".setTabId";this._adapter.setObjectNotExists(t,{type:"state",common:{role:"text",type:"string",write:!0},native:{}},()=>{})}heartbeat(){this._socket.emit("pong"),this._isAlive=Date.now(),this.updateStates()}handleLogChange(t){this.emit("_log",t)}handleStateChange(e,s){this._subscribeStates&&this._subscribeStates[e]&&Array.isArray(this._subscribeStates[e])?this._subscribeStates[e].forEach(t=>this.emit(t,s&&void 0!==s.ack&&void 0!==s.ts&&void 0!==s.from?{state:s}:{err:new Error(e+" is not a valid state")})):e.endsWith(".setTabId")&&s&&s.val&&(this._adapter.setState(e,"",!0),this.emit("_setTabId",s.val))}handleMessage(i){try{var r=JSON.parse(i);let{messageId:t,command:e,params:s=[]}=r;s=Array.isArray(s)?s:[s],e&&this[e](t,...s)}catch(t){this._adapter.log.warn(t.message||t),this._adapter.log.debug(i)}}emit(t,e={},s="message"){this._adapter.log.silly("Send message with ID "+t),e.err?e.err={name:e.err.name,message:e.err.message,stack:e.err.stack}:null===e.err&&(e.err="_isNull"),this._socket.emit(s,{messageId:t,data:e})}log(t,e,s){const i=s.map(t=>"object"==typeof t?JSON.stringify(t):t);this._adapter.log[e||"info"](i.join(", ")),this.emit(t)}getLogs(i,t="current"){var e=this._adapter.systemConfig.log.transport.file1,e=_path.resolve(this._adapter.systemConfig.dataDir+"../"+e.filename+"."+t+e.fileext);_fs.readFile(e,"utf-8",(t,e)=>{if(t)this.emit(i,{err:t});else{const s=e.substr(0,4);e=(e=(e=e.split("\n"+s)).map((e,t)=>{t=(e=t?s+e:e).indexOf(": ")+2;return{from:-1===e.substr(t).indexOf("host")?e.substr(t,e.indexOf(" (")-t):e.substr(t,e.indexOf(" ",t)-t),ts:new Date(e.substr(0,23)).getTime(),severity:["silly","debug","info","warn","error"].find(t=>-1!==e.indexOf(t)),message:e.substr(t).replace(/(?:\r\n|\r|\n)/g," ")}})).reverse(),this.emit(i,{err:null,logs:e})}})}getConfig(t){this.emit(t,{config:this._adapter.config})}readFile(s,t){t=_path.resolve(t.replace("{dirname}",__dirname)),_fs.readFile(t,"utf-8",(t,e)=>{this.emit(s,{err:t,data:e})})}sign(t,e,s,i="RSA-SHA512"){e="string"!=typeof e?JSON.stringify(e):e;let r=null,a=null;try{const n=crypto.createSign(i);n.update(e),a=n.sign(s,"base64")}catch(t){this._adapter.log.warn(t.message),r=t}this.emit(t,{err:r,data:e,privateKey:s,signature:a,algorithm:i,verification:verification})}verify(t,e,s,i,r="RSA-SHA512"){e="string"!=typeof e?JSON.stringify(e):e;let a=null,n=!1;try{n=_crypto.verify(r,Buffer.from(e),i,Buffer.from(s,"base64"))}catch(t){this._adapter.log.warn(t.message),a=t}this.emit(t,{err:a,data:e,publicKey:i,signature:s,algorithm:r,verification:n})}encrypt(t,e,s,i="AES-256-CTR"){let r=null,a=null;try{var n=_crypto.randomBytes(16).toString("hex").substr(0,16);const o=_crypto.createCipheriv(i,_crypto.createHash("sha256").update(s).digest("hex").substr(0,32),n);a=Buffer.from(n).toString("base64").substr(0,24)+":"+o.update("object"==typeof e?JSON.stringify(e):e,"utf8","base64")+o.final("base64")}catch(t){this._adapter.log.warn(t.message),r=t}this.emit(t,{err:r,str:e,encrypted:a})}decrypt(t,e,s,i="AES-256-CTR"){let r=null,a=null;try{var[n,o]=e.split(":");const c=_crypto.createDecipheriv(i,_crypto.createHash("sha256").update(s).digest("hex").substr(0,32),Buffer.from(n,"base64"));a=Buffer.concat([c.update(Buffer.from(o,"base64")),c.final()]).toString()}catch(t){this._adapter.log.warn(t.message),r=t}this.emit(t,{err:r,hash:e,decrypted:a})}request(e,s){try{s._encrypt&&s.body.data&&(s.body.data=encrypt(s.body.data,"KutTGsNQ8HCX$hrT9Ua5beRSs2BLVeQq"),delete s._encrypt),!0===s.json&&s.body&&(s.json=s.body,delete s.body),_got(s).then(t=>{this.emit(e,{_options:s,data:t.body||""})}).catch(t=>{this.emit(e,{err:t}),this._adapter.log.warn(t.message)})}catch(t){this.emit(e,{err:t}),this._adapter.log.warn(t.message)}}setAdapter(s,i,r,t){i="system.adapter."+i,this._adapter.getForeignObject(i,(t,e)=>{!t&&e?(e.common.enabled=r,this._adapter.setForeignObject(i,e,t=>{this.getAdapterInstances(),this.emit(s,{err:t})})):this.emit(s,{err:t})})}setScript(t,e,s,i){this.setState(t,"javascript.0.scriptEnabled."+e,s,i)}setState(e,t,s,i,r=null){this._adapter.setForeignState(t,s,i||!1,{user:this._options.user},t=>{this.emit(e,{err:t}),r&&r()})}getSpecial(t){this._parentMessage({clientId:this._client.id,event:"get"+t})}subscribeSpecial(t,e){this._subscribeOthers[e]=this._subscribeOthers[e]||[],-1===this._subscribeOthers[e].indexOf(t)&&(this._subscribeOthers[e].push(t),this.getSpecial(e))}getObject(s,i){this._adapter.getForeignObject(i,(t,e)=>{e={...e||{},id:i},this.emit(s,{err:t,object:e})})}getObjects(e,i){let s=[];["device","channel","state"].forEach(t=>{s.push(new Promise(s=>{this._adapter.getForeignObjects(i||"*",t,(t,e)=>s({err:t,objects:e}))}))});let r=null,a={};Promise.all(s).then(t=>{t.forEach(t=>{r=r||t.err,a={...a,...t.objects}}),Object.keys(a).forEach(t=>{var e=t.substr(0,t.indexOf(".",t.indexOf(".")+1));e&&!a[e]&&(a[e]={_id:e,type:"adapter"}),(-1<t.indexOf("system.adapter")||-1<t.indexOf("system.host")||-1===t.indexOf("."))&&delete a[t]}),this.emit(e,{err:r,objects:a})})}getObjectView(s,t,e,i,r){this._adapter.getObjectView(t,e,i,(t,e)=>{this.emit(s,{err:t,objects:e&&e.rows||[]})})}getState(s,i){this._adapter.getForeignState(i,{user:this._options.user},(t,e)=>{t||e&&(void 0!==e.ack||void 0!==e.ts||void 0!==e.from)||(t=new Error(i+" is not a valid state")),this.emit(s,{err:t,state:e})})}getStates(s,t){this._adapter.getForeignStates(t,{user:this._options.user},(t,e)=>{this.emit(s,{err:t,states:e})})}unsubscribe(t,e,s,i){this._adapter.log.debug("unsubscribe ("+i+"): "+s+" | "+e),"history"===e&&s&&this._subscribeHistory[s]?(delete this._subscribeHistory[s],this.emit(t,{subscriptionKey:s,type:e,stateId:i,err:null})):"state"===e&&i&&this.subscribeState[i]?(delete this.subscribeState[i],this.emit(t,{subscriptionKey:s,type:e,stateId:i,err:null})):this.emit(t,{subscriptionKey:s,stateId:i,err:"Not found"})}subscribeState(t,e){this._subscribeStates[e]=this._subscribeStates[e]||[],-1===this._subscribeStates[e].indexOf(t)&&this._subscribeStates[e].push(t),this.getState(t,e)}subscribeHistory(t,e,s,i){this._adapter.log.debug("subscribeHistory ("+s+"): "+e+" | "+JSON.stringify(i)),this._subscribeHistory[e]?this.emit(t,{subscriptionKey:e,err:null,hash:this._subscribeHistory[e].hash,history:this._subscribeHistory[e].history}):(this._subscribeHistory[e]={subscriptionKey:e,messageId:t,stateId:s,options:i},this.getHistory(t,e,s,{...i,force:!0}))}getHistory(i,r,a,n={}){this._adapter.log.debug("getHistory ("+a+"): "+r+" | "+JSON.stringify(n)),n.start=n.start||Date.now()-n.review,n.end=n.end||Date.now(),n.instance=n.instance||"history.0",Promise.allSettled([this._adapter.getForeignStateAsync("system.adapter."+n.instance+".alive"),this._adapter.getForeignStateAsync("system.adapter."+n.instance+".connected")]).then(t=>{t=!t.some(t=>"fulfilled"!==t.status||!t.value||t.value&&!0!==t.value.val);if(!t)throw new Error(n.instance+" not reachable");return t}).then(()=>{this._adapter.getHistory(a,n,(t,e)=>{var s;!t&&e?(s=e.length,!this._subscribeHistory[r]||!0!==n.force&&s===this._subscribeHistory[r].hash?this.emit(i,{subscriptionKey:r,err:t,hash:s,history:null,noUpdate:!0}):(this._adapter.log.debug("getHistory ("+a+"): Update"),this._subscribeHistory[r].history=e,this._subscribeHistory[r].hash=s,this.emit(i,{subscriptionKey:r,err:t,hash:s,history:e}))):this.emit(i,{subscriptionKey:r,err:t,hash:null,history:null})})}).catch(t=>{this.emit(i,{subscriptionKey:r,err:t,hash:null,history:null})})}getSystemInformation(t){this.emit(t,{hostname:_os.hostname(),architecture:_os.arch(),platform:_os.platform(),release:_os.release()})}}module.exports=ioWebSocket;