module.exports={v2css(n,s){return new Promise((i,o)=>{this.adapter.getObject(s._id,(e,t)=>{if(e){return o(e)}this.adapter.setObject(s._id,{...t,common:{...t.common,role:"json"}},()=>{this.adapter.setState(s._id,JSON.stringify({version:3.2,signature:this.library.hash(s.val),[n]:s.val},null,3),true,()=>i({key:n,version:3.2}))})})})},v2scripts(e,t){return this.v2css(e,t)},v2devices(o,e){const s=e.val||{};let r={};Object.keys(s).forEach(e=>{const t=s[e];const i={};for(const o in t.states){const n=t.states[o];if(n.label||n.state||n.action){i[o]={showState:(n.state&&n.state.node||typeof n.state==="string")&&(n.actionElement===undefined||n.actionElement===null||n.actionElement==="State"),...n,state:n.state&&n.state.node!==undefined?n.state.node:n.state||"",action:n.action&&n.action.node!==undefined?n.action.node:n.action||""};if(i[o].bodyElement!==null){i[o].bodyElement=i[o].bodyElement==="LightTemperatureBody"?"LevelBody":i[o].bodyElement}}}if(t.suppressPopup!==undefined){t.options.suppressPopup=t.suppressPopup;delete t.suppressPopup}delete t.hash;t.states=i;r[e]=t});return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:this.library.hash(r),devices:r}),true,e=>e?i({key:o,version:2}):t({key:o,version:3}))})},v2layout(o,e){const t=e.val||[];let c=[];const m={};t.forEach((e,u)=>{c[u]={id:uuid(),title:e.title||i18n.global.t("Main Site"),type:"page",icon:"mdi-file",iconColor:"",color:"",backgroundColor:"",hideLabels:e.hideLabels!==undefined?e.hideLabels:false,tabs:[]};e.tabs=e.tabs||[];e.tabs.forEach((e,a)=>{c[u].tabs[a]={id:e.id||uuid(),icon:e.icon||"mdi-tab",title:e.title,iconColor:"",color:"",backgroundColor:"",widgetConfig:{},widgetsDesktop:[],widgetsTablet:[],widgetsSmartphone:[],widgetEdges:e.widgetsEdges!==undefined?e.widgetsEdges:false};e.columns=e.columns||[];const l=Math.floor(12/e.columns.length);let d=0;e.columns=e.columns||[];e.columns.forEach((e,r)=>{e=e||[];d=0;e.forEach((e,t)=>{if(e){const i=e.devices?e.devices.map(n=>{n.id=uuid();const s={};for(const o in n){if(o.endsWith("Config")){s[o]={};for(const r in n[o]){let[e,t]=r.split("-");let i=n[o][r];s[o][e]=s[o][e]||{};if(o==="ButtonActionConfig"&&t==="label"){t="labelTurnOn";s[o][e].labelTurnOff=i}if((o==="IconButtonActionConfig"||o==="ButtonActionConfig")&&t==="buttonSize"){i=i===true?"sm":"md"}else if((o==="IconButtonActionConfig"||o==="ButtonActionConfig")&&t==="icon"){t="iconTurnOn";s[o][e].iconTurnOff=i}s[o][e][t]=i}}}n={...n,...s};if(n.type==="group"){n.groupElement=n.actionElement;delete n.actionElement;delete n.bodyStateKey;delete n.bodyElement}if(n.type==="device"&&n.bodyElement!==null){n.bodyStateKey=n.bodyStateKey||n.primaryStateKey;if(n.bodyStateKey){n.bodyElement=n.bodyElement||"LastChangeBody";n.bodyElement=n.bodyElement==="LightTemperatureBody"?"LevelBody":n.bodyElement}}return n}):[];e.module=e.module==="Chart"?"HistoryGraph":e.module;e.module=e.module==="CustomHTML"?"StateHTML":e.module;if(e.module==="StateListHorizontal"){e.module="StateList";e.moduleConfig={...e.moduleConfig||{},horizontal:true,stacked:true}}const{height:o,scaleToFitContents:n}=ioBroker.getDefaultModuleHeight(e,i);const s=uuid();e.hideTitle=e.fullscreen!==undefined?e.fullscreen:!e.title;m[s]={id:s,config:e.moduleConfig||{},icon:e.icon||"mdi:home",title:e.title||"",module:e.module,items:i||[],hideTitle:e.hideTitle,hideSeparator:true};c[u].tabs[a].widgetsDesktop.push({x:r*l,y:d,w:l,h:o,i:uuid(),items:[s],scaleToFitContents:n,alignmentVertical:"top",alignmentHorizontal:"center"});d+=o}})})})});return Promise.allSettled([new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:this.library.hash(c),layout:c}),true,e=>e?i({key:o,version:2}):t({key:o,version:3}))}),new Promise((t,i)=>{this.adapter.setState("jarvis."+this.adapter.instance+".widgets",JSON.stringify({version:3,signature:this.library.hash(m),widgets:m}),true),e=>e?i({key:o,version:2}):t({key:o,version:3})})]).then(e=>{if(e.some(e=>e.status==="rejected")){return{key:o,version:2}}return{key:o,version:3}})},v2widgets(o,e){const n=e.val||{};return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:this.library.hash(n),widgets:n}),true,e=>e?i({key:o,version:2}):t({key:o,version:3}))})},v3widgets(o,e){const n=e.val&&e.val.widgets||{};for(const t in n){const i=n[t];const s=i.items||[];n[t].items=s.map(e=>{if(e.bodyStateKey&&(e.bodyElement===undefined||e.bodyElement==="")){e.bodyElement=null}return e})}return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3.1,signature:this.library.hash(n),widgets:n}),true,e=>e?i({key:o,version:2}):t({key:o,version:3}))})}};