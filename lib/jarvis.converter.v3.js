module.exports={v2css(o,s){return new Promise((i,n)=>{this.adapter.getObject(s._id,(e,t)=>{if(e){return n(e)}this.adapter.setObject(s._id,{...t,common:{...t.common,role:"json"}},()=>{this.adapter.setState(s._id,JSON.stringify({version:3.2,signature:null,[o==="css"?"styles":o]:s.val},null,3),true,()=>i({key:o,version:3.2}))})})})},v2scripts(e,t){return this.v2css(e,t)},v2devices(n,e){const s=e.val||{};let r={};Object.keys(s).forEach(e=>{const t=s[e];const i={};for(const n in t.states){const o=t.states[n];if(o.label||o.state||o.action){i[n]={showState:(o.state&&o.state.node||typeof o.state==="string")&&(o.actionElement===undefined||o.actionElement===null||o.actionElement==="State"),...o,state:o.state&&o.state.node!==undefined?o.state.node:o.state||"",action:o.action&&o.action.node!==undefined?o.action.node:o.action||""};if(i[n].bodyElement!==null){i[n].bodyElement=i[n].bodyElement==="LightTemperatureBody"?"LevelBody":i[n].bodyElement}}}if(t.suppressPopup!==undefined){t.options.suppressPopup=t.suppressPopup;delete t.suppressPopup}delete t.hash;t.states=i;r[e]=t});return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:null,devices:r}),true,e=>e?i({key:n,version:2}):t({key:n,version:3}))})},v3devices(n,e){const i=e.val&&e.val.devices||{};let o={};Object.keys(i).forEach(e=>{const t=i[e];if(t.attributes&&t.attributes.manufacturer&&t.attributes.manufacturer.namespace){t.tags=t.tags||[];if(!t.tags.includes(t.attributes.manufacturer.namespace)){t.tags.push(t.attributes.manufacturer.namespace)}delete t.attributes.manufacturer}o[e]=t});return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3.2,signature:null,devices:o}),true,e=>e?i({key:n,version:2}):t({key:n,version:3.2}))})},v2layout(n,e){const t=e.val||[];let c=[];const m={};t.forEach((e,u)=>{c[u]={id:uuid(),title:e.title||i18n.global.t("Main Site"),type:"page",icon:"mdi-file",iconColor:"",color:"",backgroundColor:"",hideLabels:e.hideLabels!==undefined?e.hideLabels:false,tabs:[]};e.tabs=e.tabs||[];e.tabs.forEach((e,a)=>{c[u].tabs[a]={id:e.id||uuid(),icon:e.icon||"mdi-tab",title:e.title,iconColor:"",color:"",backgroundColor:"",widgetConfig:{},widgetsDesktop:[],widgetsTablet:[],widgetsSmartphone:[],widgetEdges:e.widgetsEdges!==undefined?e.widgetsEdges:false};e.columns=e.columns||[];const l=Math.floor(12/e.columns.length);let d=0;e.columns=e.columns||[];e.columns.forEach((e,r)=>{e=e||[];d=0;e.forEach((e,t)=>{if(e){const i=e.devices?e.devices.map(o=>{o.id=uuid();const s={};for(const n in o){if(n.endsWith("Config")){s[n]={};for(const r in o[n]){let[e,t]=r.split("-");let i=o[n][r];s[n][e]=s[n][e]||{};if(n==="ButtonActionConfig"&&t==="label"){t="labelTurnOn";s[n][e].labelTurnOff=i}if((n==="IconButtonActionConfig"||n==="ButtonActionConfig")&&t==="buttonSize"){i=i===true?"sm":"md"}else if((n==="IconButtonActionConfig"||n==="ButtonActionConfig")&&t==="icon"){t="iconTurnOn";s[n][e].iconTurnOff=i}s[n][e][t]=i}}}o={...o,...s};if(o.type==="group"){o.groupElement=o.actionElement;delete o.actionElement;delete o.bodyStateKey;delete o.bodyElement}if(o.type==="device"&&o.bodyElement!==null){o.bodyStateKey=o.bodyStateKey||o.primaryStateKey;if(o.bodyStateKey){o.bodyElement=o.bodyElement||"LastChangeBody";o.bodyElement=o.bodyElement==="LightTemperatureBody"?"LevelBody":o.bodyElement}}return o}):[];e.module=e.module==="Chart"?"HistoryGraph":e.module;e.module=e.module==="CustomHTML"?"StateHTML":e.module;if(e.module==="StateListHorizontal"){e.module="StateList";e.moduleConfig={...e.moduleConfig||{},horizontal:true,stacked:true}}const{height:n,scaleToFitContents:o}=ioBroker.getDefaultModuleHeight(e,i);const s=uuid();e.hideTitle=e.fullscreen!==undefined?e.fullscreen:!e.title;m[s]={id:s,config:e.moduleConfig||{},icon:e.icon||"mdi:home",title:e.title||"",module:e.module,items:i||[],hideTitle:e.hideTitle,hideSeparator:true};c[u].tabs[a].widgetsDesktop.push({x:r*l,y:d,w:l,h:n,i:uuid(),items:[s],scaleToFitContents:o,alignmentVertical:"top",alignmentHorizontal:"center"});d+=n}})})})});return Promise.allSettled([new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:null,layout:c}),true,e=>e?i({key:n,version:2}):t({key:n,version:3}))}),new Promise((t,i)=>{this.adapter.setState("widgets",JSON.stringify({version:3,signature:null,widgets:m}),true),e=>e?i({key:n,version:2}):t({key:n,version:3})})]).then(e=>{if(e.some(e=>e.status==="rejected")){return{key:n,version:2}}return{key:n,version:3}})},v2widgets(n,e){const o=e.val||{};return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:null,widgets:o}),true,e=>e?i({key:n,version:2}):t({key:n,version:3}))})},v3widgets(n,e){const o=e.val&&e.val.widgets||{};for(const t in o){const i=o[t];const s=i.items||[];o[t].items=s.map(e=>{if(e.bodyStateKey&&(e.bodyElement===undefined||e.bodyElement==="")){e.bodyElement=null}return e})}return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3.1,signature:null,widgets:o}),true,e=>e?i({key:n,version:2}):t({key:n,version:3.1}))})}};