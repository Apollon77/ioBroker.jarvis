const _datefns=require("date-fns");const _fs=require("fs");const _got=require("got");const _ical=require("node-ical");const{hash:_ohash}=require("ohash");const{getDateLocale:_getDateLocale}=require("./date");const{decrypt:_decrypt}=require("./encryption");module.exports={getCalendar({cb:a},s,r,n={}){n.language=n.language||"en-US";n.refresh=n.refresh||5;n.locale=_getDateLocale(n.language);if(r.url&&(r.url.indexOf("http")>-1||r.url.indexOf("www.")>-1)){this.adapter.log.debug('Get Calendar "'+r.name+'" ('+s+") from URL "+r.url+"...");let e={};if(r.user&&r.pass){const{decrypted:d}=_decrypt(r.pass,this.options.encryptionKey);e={username:r.user,password:d}}let t={url:r.url,...e};if(r.url.indexOf("https")>-1){t={...t,https:{rejectUnauthorized:r.sslignore!==undefined?r.sslignore===false:true}}}return _got(t).then(e=>{this.adapter.log.debug('Get Calendar events for calendar "'+r.name+'" ('+s+")...");return this.getCalendarEvents({cb:a},s,e.body,n)}).catch(e=>{this.adapter.log.warn('Failed getting Calendar "'+r.name+'" ('+s+") from URL "+r.url+" ("+e.message+")!");this.adapter.log.debug("Request: "+JSON.stringify({...t,encryptionKey:this.options.encryptionKey},null,3));return a({err:e})})}else if(r.url&&r.url.indexOf("http")===-1){this.adapter.log.debug('Get Calendar "'+r.name+'" ('+s+") from file...");return _fs.readFile(r.url,"utf-8",(e,t)=>{if(e){this.adapter.log.warn('Failed getting Calendar "'+r.name+'" ('+s+") from file "+r.url+" ("+e.message+")!");return a({err:e})}this.adapter.log.debug('Get Calendar events for calendar "'+r.name+'" ('+s+")...");this.getCalendarEvents({cb:a},s,t,n)})}},getCalendarEvents({cb:r},n,e,t){const[a,s]=n.substr(n.indexOf(":")+1).split("-");const{locale:d}=t;const l=(new Date).getTimezoneOffset();const i=new Date(Date.UTC(a,s-1,1));const o=_datefns.subMinutes(_datefns.endOfDay(_datefns.lastDayOfMonth(i)),l);return _ical.async.parseICS(e).then(e=>{let t=[];for(const a in e){const s=e[a];if(s&&s.summary&&s.type==="VEVENT"&&s.start&&s.start instanceof Date){s.isAllDay=s.start.toString().indexOf("00:00:00")!==-1&&(!s.end||s.end.toString().indexOf("00:00:00")>-1);s.end=s.isAllDay?_datefns.subSeconds(s.end,1):s.end;s.time=s.isAllDay?"all day":s.multiDay?"several days":_datefns.format(s.start,"HH:mm",{locale:d})+(s.end?"-"+_datefns.format(s.end,"HH:mm",{locale:d}):"");s.multiDay=s.end&&(s.start.getDate()!==s.end.getDate()||s.start.getMonth()!==s.end.getMonth());s.duration=s.end?_datefns.differenceInDays(s.end,s.start):1;s.caption=s.multiDay?_datefns.format(s.start,"EEE, dd.MM."+(s.isAllDay?"":", HH:mm"),{locale:d})+" - "+_datefns.format(s.end,"EEE, dd.MM."+(s.isAllDay?"":", HH:mm"),{locale:d}):_datefns.format(s.start,"EEE, dd.MM.",{locale:d})+", "+_datefns.formatDistanceToNow(s.isAllDay?_datefns.addHours(s.start,12):s.start,{locale:d,addSuffix:true});if(s.rrule){let e=s.rrule.between(i,o);if(s.exdate){e=e.filter(e=>{const t=_datefns.format(e,"yyyy-MM-dd",{locale:d});return s.exdate[t]===undefined})}e=e.map(e=>{const t=_rfdc(s);t.recurring=true;delete t.rrule;delete t.exdate;const a=s.end-s.start;t.start=e;t.end=_datefns.addMilliseconds(e,a);t.caption=_datefns.format(t.start,"EEE, dd.MM.",{locale:d})+", "+_datefns.formatDistanceToNow(t.isAllDay?_datefns.addHours(t.start,12):t.start,{locale:d,addSuffix:true});return t});t=t.concat(e)}else{if(s.start>=i&&s.start<=o){t.push(s)}else if(s.start<i&&s.end>=i){t.push(s)}}}}t=t.sort((e,t)=>e.start===t.start?0:e.start>t.start?1:-1);this.subscribedCalendar[n].events=t;this.subscribedCalendar[n].hash=_ohash(t);return r(this.subscribedCalendar[n])}).catch(e=>{r({err:e})})},subscribeCalendar({cb:e,clientId:t},a,s,r){if(!this.subscribedCalendar[a]||!this.subscribedCalendar[a].events){this.subscribedCalendar[a]={subscriptionKey:a,calendar:s,options:{...r},clients:[t]};return this.getCalendar({cb:e},a,s,{...r})}else if(!this.subscribedCalendar[a].clients.includes(t)){this.subscribedCalendar[a].clients.push(t)}e(this.subscribedCalendar[a])}};