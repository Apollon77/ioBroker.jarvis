const _datefns=require("date-fns");const _fs=require("fs");const _got=require("got");const _ical=require("node-ical");const _rfdc=require("rfdc/default");const{hash:_ohash}=require("ohash");const{getDateLocale:_getDateLocale}=require("./date");const{decrypt:_decrypt}=require("./encryption");module.exports={getCalendar({cb:a},r,n,s={}){s.language=s.language||"en-US";s.refresh=s.refresh||5;s.locale=_getDateLocale(s.language);if(n.url&&(n.url.indexOf("http")>-1||n.url.indexOf("www.")>-1)){this.adapter.log.debug('Get Calendar "'+n.name+'" ('+r+") from URL "+n.url+"...");let t={};if(n.user&&n.pass){const{decrypted:i}=_decrypt(n.pass,this.options.encryptionKey);t={username:n.user,password:i}}let e={url:n.url,...t};if(n.url.indexOf("https")>-1){e={...e,https:{rejectUnauthorized:n.sslignore!==undefined?n.sslignore===false:true}}}return _got(e).then(t=>{this.adapter.log.debug('Get Calendar events for calendar "'+n.name+'" ('+r+")...");return this.getCalendarEvents({cb:a},n,r,t.body,s)}).catch(t=>{this.adapter.log.warn('Failed getting Calendar "'+n.name+'" ('+r+") from URL "+n.url+" ("+t.message+")!");this.adapter.log.debug("Request: "+JSON.stringify({...e,encryptionKey:this.options.encryptionKey},null,3));return a({err:t})})}else if(n.url&&n.url.indexOf("http")===-1){this.adapter.log.debug('Get Calendar "'+n.name+'" ('+r+") from file...");return _fs.readFile(n.url,"utf-8",(t,e)=>{if(t){this.adapter.log.warn('Failed getting Calendar "'+n.name+'" ('+r+") from file "+n.url+" ("+t.message+")!");return a({err:t})}this.adapter.log.debug('Get Calendar events for calendar "'+n.name+'" ('+r+")...");this.getCalendarEvents({cb:a},n,r,e,s)})}},getCalendarEvents({cb:n},s,i,t,e){const[a,r]=i.substr(i.indexOf(":")+1).split("-");const{locale:d}=e;const l=(new Date).getTimezoneOffset();const o=new Date(Date.UTC(a,r-1,1));const u=_datefns.subMinutes(_datefns.endOfDay(_datefns.lastDayOfMonth(o)),l);return _ical.async.parseICS(t).then(t=>{let e=[];for(const a in t){const r=t[a];if(r&&r.summary&&r.type==="VEVENT"&&r.start&&r.start instanceof Date){try{r.end=r.end&&r.end instanceof Date?r.end:null;r.isAllDay=r.start.toString().indexOf("00:00:00")!==-1&&(!r.end||r.end.toString().indexOf("00:00:00")!==-1);r.end=r.isAllDay&&r.end?_datefns.subSeconds(r.end,1):r.end;r.time=r.isAllDay?"all day":r.multiDay?"several days":_datefns.format(r.start,"HH:mm",{locale:d})+""+(r.end?"-"+_datefns.format(r.end,"HH:mm",{locale:d}):"");r.multiDay=r.end&&(r.start.getDate()!==r.end.getDate()||r.start.getMonth()!==r.end.getMonth());r.duration=r.end?_datefns.differenceInDays(r.end,r.start):1;r.caption=r.multiDay?_datefns.format(r.start,"EEE, dd.MM."+(r.isAllDay?"":", HH:mm"),{locale:d})+" - "+_datefns.format(r.end,"EEE, dd.MM."+(r.isAllDay?"":", HH:mm"),{locale:d}):_datefns.format(r.start,"EEE, dd.MM.",{locale:d})+", "+_datefns.formatDistanceToNow(r.isAllDay?_datefns.addHours(r.start,12):r.start,{locale:d,addSuffix:true})}catch(t){this.adapter.log.warn("Failed parsing an event of calendar "+s.name+": "+t.message);this.adapter.log.debug(JSON.stringify({locale:d,start:r.start,end:r.end,isAllDay:r.isAllDay,time:r.time,multiDay:r.multiDay,duration:r.duration}));this.adapter.log.debug(JSON.stringify({start:r.start&&r.start.toString(),end:r.end&&r.end.toString(),isAllDay:r.isAllDay&&r.isAllDay.toString(),time:r.time&&r.time.toString(),multiDay:r.multiDay&&r.multiDay.toString(),duration:r.duration&&r.duration.toString()}))}if(r.rrule){let t=r.rrule.between(o,u);try{if(r.exdate){t=t.filter(t=>{const e=_datefns.format(t,"yyyy-MM-dd",{locale:d});return r.exdate[e]===undefined})}}catch(t){this.adapter.log.warn("Failed parsing a recurring event of calendar "+s.name+": "+t.message);this.adapter.log.debug(JSON.stringify({locale:d,start:r.start,end:r.end,isAllDay:r.isAllDay,time:r.time,multiDay:r.multiDay,duration:r.duration,rrule:r.rrule,exdate:r.exdate}));this.adapter.log.debug(JSON.stringify({start:r.start&&r.start.toString(),end:r.end&&r.end.toString(),isAllDay:r.isAllDay&&r.isAllDay.toString(),time:r.time&&r.time.toString(),multiDay:r.multiDay&&r.multiDay.toString(),duration:r.duration&&r.duration.toString(),rrule:r.rrule&&r.rrule.toString(),exdate:r.exdate&&r.exdate.toString()}))}t=t.map(t=>{const e=_rfdc(r);try{e.recurring=true;delete e.rrule;delete e.exdate;const a=r.end-r.start;e.start=t;e.end=_datefns.addMilliseconds(t,a);e.caption=_datefns.format(e.start,"EEE, dd.MM.",{locale:d})+", "+_datefns.formatDistanceToNow(e.isAllDay?_datefns.addHours(e.start,12):e.start,{locale:d,addSuffix:true})}catch(t){this.adapter.log.warn("Failed mapping a recurring event of calendar "+s.name+": "+t.message);this.adapter.log.debug(JSON.stringify({locale:d,start:r.start,end:r.end,isAllDay:r.isAllDay,time:r.time,multiDay:r.multiDay,duration:r.duration}));this.adapter.log.debug(JSON.stringify({start:r.start&&r.start.toString(),end:r.end&&r.end.toString(),isAllDay:r.isAllDay&&r.isAllDay.toString(),time:r.time&&r.time.toString(),multiDay:r.multiDay&&r.multiDay.toString(),duration:r.duration&&r.duration.toString()}))}return e});e=e.concat(t)}else{if(r.start>=o&&r.start<=u){e.push(r)}else if(r.start<o&&r.end>=o){e.push(r)}}}}e=e.sort((t,e)=>t.start===e.start?0:t.start>e.start?1:-1);this.subscribedCalendar[i].events=e;this.subscribedCalendar[i].hash=_ohash(e);return n(this.subscribedCalendar[i])}).catch(t=>{this.adapter.log.warn("Failed parsing ical of calendar "+s.name+": "+t.message);n({err:t})})},subscribeCalendar({cb:t,clientId:e},a,r,n){if(!this.subscribedCalendar[a]||!this.subscribedCalendar[a].events){this.subscribedCalendar[a]={subscriptionKey:a,calendar:r,options:{...n},clients:[e]};return this.getCalendar({cb:t},a,r,{...n})}else if(!this.subscribedCalendar[a].clients.includes(e)){this.subscribedCalendar[a].clients.push(e)}t(this.subscribedCalendar[a])}};