const _fs=require("fs-extra");const _got=require("got");const _ip=require("ip");const _os=require("os");const _platform=require("platform");const _schedule=require("node-schedule");const _semver=require("semver");const _uuid=require("uuid").v5;const _cookieParser=require("cookie-parser");const{WebSocketServer}=require("ws");const EventEmitter=require("events");const{objectHash}=require("ohash");const _ical=require("node-ical");const{RRule}=require("rrule");const _datefns=require("date-fns");const _rfdc=require("rfdc")();const{getDateLocale}=require("./date");const{decrypt}=require("./encryption");const ioWebSocketClient=require("./server.client-handler");class ioWebSocket extends EventEmitter{constructor(e=null,t={}){super();if(!e){throw new Error("No adapter instance passed to WebSocket constructor!")}this._adapter=e;this._options=t||{};if(this._options.user&&this._options.user.indexOf("system.user.")===-1){this._options.user="system.user."+this._options.user}this._options.port=t.port||8400;this._options.certificates=t.certificates||null;this.server=null;this.wss=null;this.clients={};this.sockets={};this.connect();this.cache={};this._adapter.requireLog(true);this._adapter.subscribeForeignStates("*");this.getAdapterInstances();this.updateAdapterInstances();this._adapter.getForeignState("admin.0.info.updatesJson",(e,t)=>{if(!e&&t){try{this.cache["AdapterUpdates"]=JSON.parse(t.val)}catch(e){delete this.cache["AdapterUpdates"]}this.getAdapterInstances()}});this._adapter.on("stateChange",(e,t)=>{if(e.startsWith("javascript.0.scriptEnabled.")&&t&&t.ack===true){this.getScriptStatuses(true)}else if(e==="admin.0.info.updatesJson"&&t){try{this.cache["AdapterUpdates"]=JSON.parse(t.val)}catch(e){delete this.cache["AdapterUpdates"]}}})}sendSubscribedClients(t,s){for(const a in this.sockets){if(this.sockets[a]._subscribeOthers&&this.sockets[a]._subscribeOthers[t]){this.sockets[a]._subscribeOthers[t].forEach(({messageId:e})=>{this.sockets[a].emit(e,t,s)})}else{this.sockets[a].emit("_"+t,t,s)}}}getCalendarEvents(r,e,n,i,t){const s=(new Date).getTimezoneOffset();const o=new Date(Date.UTC(n,i-1,1));const c=_datefns.subMinutes(_datefns.endOfDay(_datefns.lastDayOfMonth(o)),s);const{locale:d}=t;return _ical.async.parseICS(e).then(e=>{let t=[];for(const s in e){const a=e[s];if(a&&a.summary&&a.type==="VEVENT"&&a.start&&a.start instanceof Date){a.isAllDay=a.start.toString().indexOf("00:00:00")!==-1&&(!a.end||a.end.toString().indexOf("00:00:00")>-1);a.end=a.isAllDay?_datefns.subSeconds(a.end,1):a.end;a.time=a.isAllDay?"all day":a.multiDay?"several days":_datefns.format(a.start,"HH:mm",{locale:d})+(a.end?"-"+_datefns.format(a.end,"HH:mm",{locale:d}):"");a.multiDay=a.end&&(a.start.getDate()!==a.end.getDate()||a.start.getMonth()!==a.end.getMonth());a.duration=a.end?_datefns.differenceInDays(a.end,a.start):1;a.caption=a.multiDay?_datefns.format(a.start,"EEE, dd.MM."+(a.isAllDay?"":", HH:mm"),{locale:d})+" - "+_datefns.format(a.end,"EEE, dd.MM."+(a.isAllDay?"":", HH:mm"),{locale:d}):_datefns.format(a.start,"EEE, dd.MM.",{locale:d})+", "+_datefns.formatDistanceToNow(a.isAllDay?_datefns.addHours(a.start,12):a.start,{locale:d,addSuffix:true});if(a.rrule){let e=a.rrule.between(o,c);if(a.exdate){e=e.filter(e=>{const t=_datefns.format(e,"yyyy-MM-dd",{locale:d});return a.exdate[t]===undefined})}e=e.map(e=>{const t=_rfdc(a);t.recurring=true;delete t.rrule;delete t.exdate;const s=a.end-a.start;t.start=e;t.end=_datefns.addMilliseconds(e,s);t.caption=_datefns.format(t.start,"EEE, dd.MM.",{locale:d})+", "+_datefns.formatDistanceToNow(t.isAllDay?_datefns.addHours(t.start,12):t.start,{locale:d,addSuffix:true});return t});t=t.concat(e)}else{if(a.start>=o&&a.start<=c){t.push(a)}else if(a.start<o&&a.end>=o){t.push(a)}}}}t=t.sort((e,t)=>e.start===t.start?0:e.start>t.start?1:-1);const s="Calendar:"+r.id+":"+n+"-"+i;this.cache[s]={calendar:r,ts:Date.now(),hash:objectHash(t),events:t};return t}).catch(e=>{console.error(e);return[]})}getCalendar({calendar:a,year:r,month:n,options:i={}}){i.language=i.language||"en-US";i.refresh=i.refresh||5;i.locale=getDateLocale(i.language);this.cache["Calendar:"+a.id]=this.cache["Calendar:"+a.id]||{calendar:a,ts:null,hash:null,data:{}};const e="Calendar:"+a.id+":"+r+"-"+n;this.cache[e]=this.cache[e]||{calendar:a,ts:null,hash:null,events:[]};const t=Date.now()-i.refresh*60*1e3;if(!i.forceUpdate&&this.cache[e].ts&&this.cache[e].ts>t){this._adapter.log.debug("Got events for "+a.name+" ("+a.id+") "+r+"-"+n+" from Cache.");return Promise.resolve({events:this.cache[e].events})}else if(!i.forceUpdate&&this.cache["Calendar:"+a.id].ts&&this.cache["Calendar:"+a.id].ts>t){this._adapter.log.debug("Got ical data for "+a.name+" ("+a.id+") "+r+"-"+n+" from Cache.");return this.getCalendarEvents(a,this.cache["Calendar:"+a.id].data,r,n,i).then(e=>({events:e}))}else if(a.url&&(a.url.indexOf("http")>-1||a.url.indexOf("www.")>-1)){this._adapter.log.debug("Get ical data for "+a.name+" ("+a.id+") "+r+"-"+n+" from URL...");let e={};if(a.user&&a.pass){const{decrypted:s}=decrypt(a.pass,this._options.encryptionKey);e={username:a.user,password:s}}let t={url:a.url,...e};if(a.url.indexOf("https")>-1){t={...t,https:{rejectUnauthorized:a.sslignore!==undefined?a.sslignore===false:true}}}return _got(t).then(e=>{const t=e.body||"";this._adapter.log.debug("Got ical data for "+a.name+" ("+a.id+") "+r+"-"+n+" from URL.");this.cache["Calendar:"+a.id]={calendar:a,ts:Date.now(),data:t};return this.getCalendarEvents(a,this.cache["Calendar:"+a.id].data,r,n,i)}).then(e=>{return{events:e}}).catch(e=>{this._adapter.log.warn("Failed getting ical data for "+a.name+" ("+a.id+") "+r+"-"+n+" from URL: "+a.url+" ("+e.message+")");this._adapter.log.debug("Request: "+JSON.stringify({...t,encryptionKey:this._options.encryptionKey},null,3));return{error:e}})}else if(a.url&&a.url.indexOf("http")===-1){this._adapter.log.debug("Calendar","Get ical data for "+a.name+" ("+a.id+") "+r+"-"+n+" from local path...");return new Promise(s=>{_fs.readFile(a.url,"utf-8",(e,t)=>{if(e){this._adapter.log.warn("Failed getting ical data for "+a.name+" ("+a.id+") "+r+"-"+n+" from local path: "+e.message);return s({error:e})}this._adapter.log.debug("Got ical data for "+a.name+" ("+a.id+") "+r+"-"+n+" from local path.");this.cache["Calendar:"+a.id]={calendar:a,ts:Date.now(),data:t};this.getCalendarEvents(a,this.cache["Calendar:"+a.id].data,r,n,i).then(e=>({events:e}))})})}}getScriptStatuses(l=false){this.cache["ScriptStatuses"]=this.cache["ScriptStatuses"]||{hash:null,data:{}};return new Promise(h=>{this._adapter.getObjectView("system","script",null,(e,t)=>{const s=[];const n={};t.rows=t.rows||[];t.rows.forEach(e=>{const t=e.id.replace("script.js.","");const s=t.substr(0,t.lastIndexOf("."));const a=t.substr(0,t.indexOf("."));e=e.value;e.disabled=!e.enabled;delete e.common.source;n[t]={...n[t],...e.common,created:e.ts,type:"file",id:t,parentId:s,lazy:false,children:null};n[s]={...n[s]||{},type:"folder",id:s,parentId:s.substr(0,s.lastIndexOf(".")),children:n[s]&&n[s].children||[]};n[s].children.push(n[t]);const r=t.split(".");if(r.length>2){r.forEach((e,t)=>{const s=r.slice(0,t).join(".");const a=s.substr(0,s.lastIndexOf("."));if(s&&a){n[a]=n[a]||{id:a,parentId:a.substr(0,a.lastIndexOf(".")),type:"folder",children:[]};if(n[a].children.findIndex(e=>e.id===s)===-1){n[a].children.push({id:s,type:"folder",lazy:true})}}})}});const a=Object.values(n);let r={},i,o=[],c;a.sort((e,t)=>{return e.type==="folder"&&t.type==="file"?-1:e.id.toLowerCase()===t.id.toLowerCase()?0:e.id.toLowerCase()>t.id.toLowerCase()?1:-1});for(c=0;c<a.length;c+=1){r[a[c].id]=c;a[c].children=[]}for(c=0;c<a.length;c+=1){i=a[c];if(i.parentId!==""){a[r[i.parentId]].children.push(i)}else{o.push(i)}}const d=objectHash(n);if(l===true||this.cache["ScriptStatuses"].hash!==d){this._adapter.log.debug("Push update of scripts..");this.cache["ScriptStatuses"]={hash:d,data:{scripts:o,scriptList:s}};return h({scripts:o,scriptList:s})}})})}getAdapterInstances(){this.cache["AdapterInstances"]=this.cache["AdapterInstances"]||{hash:null,data:{}};return new Promise(r=>{this._adapter.getObjectView("system","instance",{startkey:"system.adapter.",endkey:"system.adapter.zzz"},(e,t)=>{const i={};if(!e&&t&&t.rows){t.rows.forEach(async e=>{const t=e.id.replace("system.adapter.","");i[t]={...e.value.common,_id:e.id,id:t};const s=await this._adapter.getForeignStateAsync(e._id+".alive");const a=await this._adapter.getForeignStateAsync(e._id+".connected");const r=await this._adapter.getForeignStateAsync(t+".info.connection");i[t].alive=s?s.val:null;i[t].connectedToHost=a?a.val:null;i[t].connectedToInstance=r?r.val:null;const n=this.cache["AdapterUpdates"]&&this.cache["AdapterUpdates"][i[t].name]&&this.cache["AdapterUpdates"][i[t].name].availableVersion||i[t].version;i[t].update=n&&i[t].version&&_semver.gt(n,i[t].version)===true?n:null;delete i[t].docs;delete i[t].news});const s=Object.keys(i).sort().reduce((e,t)=>{e[t]=i[t];return e},{});const a=objectHash(s);if(this.cache["AdapterInstances"].hash!==a){this._adapter.log.debug("Push update of instances..");this.cache["AdapterInstances"]={hash:a,data:s};return r(s)}}})})}updateAdapterInstances(){this.scheduler=_schedule.scheduleJob("*/30 * * * * *",e=>{this._adapter.log.silly("Refresh Adapter Instances and Script Statuses..");this.sendSubscribedClients("timestamp",(new Date).getTime());this.getAdapterInstances().then(e=>{this.sendSubscribedClients("AdapterInstances",e)});this.getScriptStatuses().then(e=>{this.sendSubscribedClients("ScriptStatuses",e)})})}eventFromClient(t){const s=t.clientId;t.options=t.options||{};if(t.event==="disconnect"){if(s&&this.clients[s]){this._adapter.log.info("Client with IP "+(this.clients[s]?this.clients[s].ip:"(unknown)")+" disconnected.");delete this.clients[s]}this.emit("CLIENT_LIST",this.clients)}else if(t.event==="clients"){const{event:e,...a}=t;this.clients[t.id]={...a,ts:Date.now()};this.emit("CLIENT_LIST",this.clients)}else if(t.event==="getAdapterInstances"||t.event==="getScriptStatuses"||t.event==="getCalendar"){const r=t.event.replace("get","");this._adapter.log.debug(t.event+": Retrieving with options "+JSON.stringify(t.options));if(!t.options.forceUpdate&&this.sockets[s]&&this.sockets[s]._subscribeOthers&&this.sockets[s]._subscribeOthers[r]&&this.cache[r]){this.sockets[s]._subscribeOthers[r].forEach(({messageId:e})=>{this.sockets[s].emit(e,r,this.cache[r].data)})}else if(this.sockets[s]&&this[t.event]){this[t.event](t.options).then(e=>{this.sockets[s]&&this.sockets[s].emit(t.messageId,r,e)}).catch(e=>{this.sockets[s]&&this.sockets[s].emit(t.messageId,r,{error:e});this._adapter.log.warn(t.event+": "+e.message)})}else if(s){const n="Unknown error (using options "+JSON.stringify(t.options)+")";this.sockets[s]&&this.sockets[s].emit(t.messageId,r,{error:n});this._adapter.log.warn(t.event+": "+n)}}}connect(){const a=_ip.address();const e=_os.hostname();this._adapter.log.debug("Connection: ioBroker host detected with "+e+" (IP: "+a+").");const i={};const o={};const t=(s,r)=>{const n=s.headers.cookie;const e={headers:{Cookie:n},https:{rejectUnauthorized:false}};const t=this._options.auth!==true||i[n]?Promise.resolve({body:i[n]||""}):_got((this._options.secure===true?"https":"http")+"://"+a+":"+this._options.webPort+"/prolongSession",e);t.then(({body:e})=>{const t=RegExp("\\d{4}-(?:0[1-9]|1[0-2])-(?:[0-2][1-9]|[1-3]0|3[01])T(?:[0-1][0-9]|2[0-3])(?::[0-6]\\d)(?::[0-6]\\d)?(?:.\\d{3})?(?:[+-][0-2]\\d:[0-5]\\d|Z)?");if(this._options.auth===true&&!t.test(e)){throw new Error("Incorrect Authentication")}i[n]=e;let a=decodeURI(s.url);a=a==="/"?"/index.html":a;a=a.replace("/jarvis","").substr(1);if(o[a]!==undefined){r.writeHead(200,{"Cache-Control":"public, max-age=30758400000","Content-Type":o[a].mimeType});r.end(o[a].buffer)}else{this._adapter.readFile("jarvis",a,(e,t,s)=>{if(e||!s){this._adapter.log.warn(a+": "+(e.message||"No Mime Type"));r.writeHead(404);r.end(e&&e.message||e||"No Mime Type")}else{o[a]={buffer:t,mimeType:s};r.writeHead(200,{"Cache-Control":"public, max-age=30758400000","Content-Type":o[a].mimeType});r.end(o[a].buffer)}})}}).catch(e=>{r.writeHead(302,{Location:(this._options.secure===true?"https":"http")+"://"+a+":"+this._options.webPort+"/login"});r.end()})};if(this._options.certificates!==null){const r={...this._options.certificates,allowHTTP1:true};this.server=require("http2").createSecureServer(r,t);this._adapter.log.debug("Connection: Using secure HTTPS-Server")}else{this.server=require("http").createServer(t);this._adapter.log.debug("Connection: Using non-secure HTTP-Server")}let s=this._adapter.config.hostWhitelist?this._adapter.config.hostWhitelist.replace(/, /g,",").split(","):[];s=s.concat(["localhost","127.0.0.1",a,e]);this._adapter.log.debug("Connection: Using options: "+JSON.stringify(this._options.connection||{}));this.wss=null;try{this.wss=new WebSocketServer({server:this.server})}catch(e){this._adapter.log.error(e.message)}this.wss.on("error",e=>{this._adapter.log.error("WebSocket Error: "+e.message);this._adapter.log.debug(e)});this.wss.on("connection",(e,t)=>{this._adapter.log.debug("Client connecting...");const s=t.headers["user-agent"];const a=_platform.parse(s);const r=a.name||"";const n=t.connection.remoteAddress.indexOf(":")!==-1?t.connection.remoteAddress.substr(t.connection.remoteAddress.lastIndexOf(":")+1):t.connection.remoteAddress;const i=(n?n.replace(/\./g,"-"):"no-ip-detected")+"_"+(r?r.replace(/ /g,"-"):"no-browser-detected");const o=_uuid(i,"d03b9915-564d-491e-a0e0-7ef4af0a52d1");this.clients[o]={userAgent:s,userPlatform:a||{},userBrowser:r,ip:n,ns:i,id:o,ts:Date.now()};this.sockets[o]=new ioWebSocketClient(this._adapter,this._options,this.clients[o],e,e=>this.eventFromClient(e));this.emit("CLIENT_NEW",this.clients[o]);this.emit("CLIENT_LIST",this.clients);this._adapter.log.info("Client with IP "+(this.clients[o]?this.clients[o].ip:"(unknown)")+" connected.")});this.server.listen(this._options.port,"0.0.0.0",()=>{this._adapter.log.info("Connection: WebSocket opened on port "+this.server.address().port+(this._options.certificates!==null?" using https":" using http")+"...")})}}module.exports=ioWebSocket;