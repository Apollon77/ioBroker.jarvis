"use strict";const adapterName=require("./io-package.json").common.name;const utils=require("@iobroker/adapter-core");const _crypto=require("crypto");const _got=require("got");const _ip=require("ip");const _os=require("os");const _fs=require("fs");const _shajs=require("sha.js");const _path=require("path");const _schedule=require("node-schedule");const{v4:_uuid}=require("uuid");const Library=require("./lib/library.js");const Encryption=require("./lib/encryption");const JarvisServer=require("./lib/jarvis.server.js");let adapter;let library;let server;let unloaded;let garbage_collector;let notification="";let NotificationTimer=null;let SETTINGS={};let CLIENTS={};let BACKUPS={styles:{},settings:{},layout:{},widgets:{},devices:{},scripts:{}};const BACKUP_STATES=[{state:"devices"},{state:"layout"},{state:"widgets"},{state:"settings"},{state:"scripts"},{state:"css",id:"styles"}];if(!Promise.allSettled){Promise.allSettled=e=>Promise.all(e.map((e,t)=>e.then(e=>({status:"fulfilled",value:e})).catch(e=>({status:"rejected",reason:e}))))}function startAdapter(e){e=e||{};adapter=new utils.Adapter({...e,systemConfig:true,name:adapterName});adapter.on("ready",function(){unloaded=false;library=new Library(adapter);if(adapter.name!=="jarvis"){return library.terminate()}removeOldDevices();garbage_collector=setInterval(()=>{removeOldDevices()},24*3600*1e3);if(adapter.config.scheduledHour===undefined||adapter.config.scheduledMinute===undefined){adapter.getForeignObject("system.adapter."+adapter.namespace,(e,t)=>{if(e||!t||!t.native){return library.terminate("Error system.adapter."+adapter.namespace+" not found!")}const a=library.random(0,59);const r=library.random(0,23);t.native={...t.native,scheduledHour:r,scheduledMinute:a};adapter.setForeignObject(t._id,t)})}else{adapter.log.debug("Scheduled for "+adapter.config.scheduledHour+":"+adapter.config.scheduledMinute);_schedule.scheduleJob(adapter.config.scheduledMinute+" "+adapter.config.scheduledHour+" * * *",()=>{adapter.getState("info.pro",(e,r)=>{if(!e&&r.val){const i=library.random(1e3,9999);const s=Date.now();const n=_shajs("sha256").update(s+"-"+i+"-bfceea54-998e-4f30-adf0-d0ff894e4a54").digest("hex");try{const o=JSON.parse(r.val);const{signature:t,...a}=o;const d=Encryption.verify(a,t,["-----BEGIN PUBLIC KEY-----","MIIBITANBgkqhkiG9w0BAQEFAAOCAQ4AMIIBCQKCAQB3DHXL321K/qm0H7pac0pZ","4hIBVgqOU3k6d8ti/gWRqrIvtC4BjFaZ5EtHD/tgPtb2eQKZFhxg/ZjQ7pgkWiqq","hs022REErUUtVFZDdovJkxQYkpqKYwjprjUMkEBna4hrugqpTfzTTOQShGULYEBB","gw9NFGff/NxTiOt4yyXFOkMJf7t8AYRWAoVpFYp5X+bI5mKEo8AzWZyKQY6n13Wx","ZWLUK9f8+ZEPgKU0LFiqMwEDwBO4af5Wqo8wdbnbWP7Ejo5qcrfOgEdGKXq9egza","ZuQy5K/b+mhtcDqtIVK1aAuGU/mBjjwCl0nft7PYMBd6pbq4c2rWCa4GRViC1reh","AgMBAAE=","-----END PUBLIC KEY-----"].join("\r\n"));if(d.verification===false){adapter.log.warn("Pro licence is invalid!");CLIENTS.forEach(a=>{adapter.getState(a.path+".connected",(e,t)=>{if(!e&&t&&t.val===true){server.send(a.id,"#reload")}})})}adapter.getForeignObject("system.meta.uuid",(e,t)=>{if(!e&&t&&t.native){const a={action:"setPro",token:n,random:i,ts:s,intIp:_ip.address(),signature:o.signature,pro:r.val,version:adapter.version,ioBrokerId:t.native.uuid,system:JSON.stringify({hostname:_os.hostname(),architecture:_os.arch(),platform:_os.platform(),release:_os.release()})};_got.post("https://www.zefau.net/jarvis/user/details.php",{json:a}).catch(e=>{adapter.log.warn(e.message||e)})}})}catch(e){}}})})}BACKUP_STATES.forEach(r=>{r.id=r.id||r.state;BACKUPS[r.id]={};const i=_path.join(__dirname,"..","..","iobroker-data","jarvis",adapter.instance.toString(),"_BACKUP_"+r.id.toUpperCase()+".json");_fs.readFile(i,(e,t)=>{const a=_path.dirname(i);if(!_fs.existsSync(a)){_fs.mkdirSync(a,{recursive:true})}if(e){adapter.log.info("No Backup found for "+r.id+", thus backing up initially.");adapter.getState(r.state,(e,t)=>!e&&t&&t.val&&backup(r,t.val))}else if(t){adapter.log.info("Found Backups for "+r.id+".");try{BACKUPS[r.id]=JSON.parse(t)}catch(e){adapter.log.error("Error loading recent backups ("+r.id+"): "+e.message)}}})});let e=[];const s=8400+adapter.instance;e.push(new Promise(i=>{adapter.getForeignObject("system.adapter.web.0",(e,t)=>{adapter.log.debug("Web Configuration: "+JSON.stringify(t.native));const a={...t.native,user:t&&t.native&&t.native.defaultUser||null,webPort:t&&t.native&&t.native.port||8082,socketSecure:t&&t.native&&t.native.secure!==undefined?t.native.secure:false};const r={certPublic:t&&t.native&&t.native.certPublic!==undefined?t.native.certPublic:"",certPrivate:t&&t.native&&t.native.certPrivate!==undefined?t.native.certPrivate:"",certChained:t&&t.native&&t.native.certChained!==undefined?t.native.certChained:""};if(adapter.config.certPublic!==r.certPublic||adapter.config.certPrivate!==r.certPrivate||adapter.config.certChained!==r.certChained||adapter.config.autoDetect===true&&(adapter.config.webPort!==a.webPort||adapter.config.socketPort!==s||adapter.config.socketSecure!==a.socketSecure)){adapter.getForeignObject("system.adapter."+adapter.namespace,(e,t)=>{if(e||!t||!t.native){return library.terminate("Error system.adapter."+adapter.namespace+" not found!")}adapter.log.debug("Remember certificates...");t.native={...t.native,...r};if(adapter.config.autoDetect===true){adapter.log.debug("Write default config to jarvis...");t.native={...t.native,...a,socketPort:s}}adapter.setForeignObject(t._id,t)})}i(a)})}));if(adapter.config.socketSecure&&adapter.config.certPublic&&adapter.config.certPrivate){e.push(new Promise(r=>{adapter.getCertificates(adapter.config.certPublic,adapter.config.certPrivate,adapter.config.certChained,(e,t,a)=>{r(t)})}))}else{e.push(Promise.resolve(null))}e.push(new Promise(a=>{adapter.getForeignObject("system.config",(e,t)=>{a(t&&t.native&&t.native.secret||null)})}));Promise.all(e).then(e=>{const t=adapter.config.autoDetect===true?s:adapter.config.socketPort||s;server=new JarvisServer(adapter,{...adapter.config,...e[0],port:t,certificates:e[1],encryptionKey:e[2]});server.init().listen().server();if(false){server.proxy()}server.on("CLIENT_LIST",e=>{adapter.setState("clients.connected",JSON.stringify(e,null,3),true);CLIENTS=e})}).catch(e=>{adapter.log.error("Error opening web socket: "+e.message)});library.set(Library.CONNECTION,true);adapter.getState("settings",(e,t)=>{if(!e&&t&&t.val){try{SETTINGS=JSON.parse(t.val)||{};SETTINGS.token=SETTINGS.token||_crypto.randomBytes(16).toString("hex");SETTINGS.sendUsageData=adapter.config.sendUsageData!==undefined?adapter.config.sendUsageData:true;adapter.setState("settings",JSON.stringify(SETTINGS),true);writeSettingsToStates(SETTINGS,()=>adapter.subscribeStates("settings*"))}catch(e){adapter.log.error("Error initially writing settings to states: "+e.message)}}})});adapter.on("stateChange",function(t,a){if(t.startsWith("jarvis."+adapter.instance)===false||a===undefined||a===null||a.val===undefined||a.val===null){return}if(t.startsWith("jarvis.")&&t.indexOf(".clients.")>-1&&t.endsWith(".connected")&&a&&a.val===true){adapter.getState(t.substr(0,t.lastIndexOf("."))+".id",(e,t)=>{const a=t&&t.val;if(a){const r=CLIENTS.find(e=>e.id===a);if(r&&r.unreadNotifications){adapter.log.debug("Client with ID "+a+" back online. Delivering saved notifications ("+r.unreadNotifications.length+").");server.send(a,"notification",r.unreadNotifications);r.unreadNotifications=[]}}})}if(t.substr(-9)===".settings"){try{const r=JSON.parse(a.val)||{};SETTINGS=r;writeSettingsToStates(r)}catch(e){adapter.log.error("Error writing settings to states: "+e.message)}}const e=BACKUP_STATES.findIndex(e=>e.state===t.substr(t.lastIndexOf(".")+1));if(e>-1){backup(BACKUP_STATES[e],a.val)}if(a.ack===true){return}if(t.indexOf(".addNotification")>-1&&a&&a.val){adapter.setState("addNotification","",true);try{notification=a.val.indexOf("{")>-1&&a.val.indexOf("}")>-1?JSON.parse(a.val):{title:a.val};notification.message=notification.message.replace(/(\r\n|\r|\n)/g,"<br />");notification.id=_uuid();notification.ts=notification.ts||Date.now();if(notification.devices){notification.devices=Array.isArray(notification.devices)?notification.devices:[notification.devices]}if(notification.state!=="delete"){adapter.setState("notifications",JSON.stringify(processNotifications(NOTIFICATIONS)),true)}}catch(e){adapter.log.error("Error adding notification: "+e.message)}}if(t.indexOf(".settings.")>-1){try{const i=t.substr(t.lastIndexOf(".settings.")+10);SETTINGS[i]=a&&a.val&&a.val.toString().indexOf("{")>-1&&a.val.toString().indexOf("}")>-1?JSON.parse(a.val):a.val;adapter.setState("settings",JSON.stringify(SETTINGS),true);if(adapter.config[i]!==undefined){adapter.getForeignObject("system.adapter."+adapter.namespace,(e,t)=>{if(e||!t||!t.native){return library.terminate("Error system.adapter."+adapter.namespace+" not found!")}t.native[i]=a.val;adapter.setForeignObject(t._id,t)})}}catch(e){adapter.log.error("Error updating settings: "+e.message)}}});adapter.on("message",function(s){adapter.log.debug("Got message: "+JSON.stringify(s));if(library&&library.msg&&s.command==="_getHashedToken"&&s.message){}else if(library&&library.msg&&s.command==="_getProData"){adapter.log.debug("Get pro data...");adapter.getForeignObject("system.meta.uuid",(e,i)=>{adapter.getState("info.pro",(e,t)=>{const a=t.val&&JSON.parse(t.val);const r={licence:t.val,licenceSignature:a&&a.signature,adapterInstance:adapter.instance,ioBrokerId:i.native.uuid};library.msg(s.from,s.command,r,s.callback)})})}else if(library&&library.msg&&s.command==="_backups"&&s.message){adapter.log.debug("Get List of Backups for "+s.message.id);library.msg(s.from,s.command,BACKUPS[s.message.id],s.callback)}else if(s.command==="_restore"&&s.message&&s.message.id&&s.message.state&&s.message.date){adapter.log.debug("Restore "+s.message.id);restore(s.message.id,s.message.state,s.message.date)}});adapter.on("unload",function(t){try{adapter.log.info("Adapter stopped und unloaded.");unloaded=true;library&&library.resetStates();clearInterval(garbage_collector);server.close();t()}catch(e){t()}});return adapter}function processNotifications(e){const t=SETTINGS.maxNotifications||1e3;e=e.slice(-(t+1));return e}function restore(e,t,a){adapter.log.info("Restore "+e+" from "+a+"..");adapter.setState(t,BACKUPS[e][a],true)}function backup(a,e){a.id=a.id||a.state;if(!e||e&&e.toString()==="{}"){return false}const t=new Date;const r=t.getFullYear()+"-"+("0"+(t.getMonth()+1)).substr(-2)+"-"+("0"+t.getDate()).substr(-2)+"_"+("0"+t.getHours()).substr(-2)+"-"+("0"+t.getMinutes()).substr(-2)+"-"+("0"+t.getSeconds()).substr(-2);BACKUPS[a.id][r]=e;adapter.config.keepBackupEntries=(adapter.config.keepBackupEntries||25)-1;const i=Object.keys(BACKUPS[a.id]);if(i.length>adapter.config.keepBackupEntries){i.reverse().forEach((e,t)=>{if(t>adapter.config.keepBackupEntries){delete BACKUPS[a.id][e]}})}adapter.log.info("Backup "+a.id+"..");const s=_path.join(__dirname,"..","..","iobroker-data","jarvis",adapter.instance.toString(),"_BACKUP_"+a.id.toUpperCase()+".json");_fs.writeFile(s,JSON.stringify(BACKUPS[a.id],null,3),e=>e&&adapter.log.error("Error saving backups to storage: "+e.message))}function removeOldDevices(){adapter.getDevices((e,t)=>{t.forEach(i=>{adapter.getState(i._id+".lastSeen",(e,t)=>{const a=i._id.substr(i._id.lastIndexOf(".")+1);const r=Date.now()-7*24*3600*1e3;if(e&&e.message){adapter.log.warn("Error removing old devices: "+e.message)}if(!t||!t.val||t.val<r){adapter.log.info("Device "+a+" expired and removed.");adapter.delForeignObject(i._id,{recursive:true},()=>{})}})})})}function writeSettingsToStates(t,a=null){let r=[];for(let e in t){const i=typeof t[e]==="object"?JSON.stringify(t[e]):t[e];r.push(new Promise((a,r)=>{library.set({node:"settings."+e,description:"Modify setting "+e,role:"config",type:typeof i,write:true,read:true},i,{callback:(e,t)=>e?r(e):a(t)})}))}Promise.allSettled(r).then(e=>a&&a())}if(module&&module.parent)module.exports=startAdapter;else startAdapter();