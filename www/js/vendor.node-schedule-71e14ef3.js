import{e as z}from"./vendor.events-e8bb2ecf.js";import{d as O,p as P}from"./vendor.cron-parser-d81a89fc.js";import{s as $}from"./vendor.sorted-array-functions-07761bc7.js";import{l as V}from"./vendor.long-timeout-eb943ffb.js";const J=V,d=O,C=$,g=[];let l=null;const j=new m;j.recurs=!1;function S(e,t,i,n){this.job=e,this.fireDate=t,this.endDate=n,this.recurrenceRule=i||j,this.timerID=null}function N(e,t){return e.fireDate.getTime()-t.fireDate.getTime()}function D(e,t,i){this.start=e||0,this.end=t||60,this.step=i||1}D.prototype.contains=function(e){if(this.step===null||this.step===1)return e>=this.start&&e<=this.end;for(let t=this.start;t<this.end;t+=this.step)if(t===e)return!0;return!1};function m(e,t,i,n,s,r,o){this.recurs=!0,this.year=e==null?null:e,this.month=t==null?null:t,this.date=i==null?null:i,this.dayOfWeek=n==null?null:n,this.hour=s==null?null:s,this.minute=r==null?null:r,this.second=o==null?0:o}m.prototype.isValid=function(){function e(t){return Array.isArray(t)||t instanceof Array?t.every(function(i){return e(i)}):!(Number.isNaN(Number(t))&&!(t instanceof D))}if(this.month!==null&&(this.month<0||this.month>11||!e(this.month))||this.dayOfWeek!==null&&(this.dayOfWeek<0||this.dayOfWeek>6||!e(this.dayOfWeek))||this.hour!==null&&(this.hour<0||this.hour>23||!e(this.hour))||this.minute!==null&&(this.minute<0||this.minute>59||!e(this.minute))||this.second!==null&&(this.second<0||this.second>59||!e(this.second)))return!1;if(this.date!==null){if(!e(this.date))return!1;switch(this.month){case 3:case 5:case 8:case 10:if(this.date<1||this.date>30)return!1;break;case 1:if(this.date<1||this.date>29)return!1;break;default:if(this.date<1||this.date>31)return!1}}return!0};m.prototype.nextInvocationDate=function(e){const t=this._nextInvocationDate(e);return t?t.toDate():null};m.prototype._nextInvocationDate=function(e){if(e=e instanceof d||e instanceof Date?e:new Date,!this.recurs||!this.isValid())return null;let i=new d(Date.now(),this.tz).getFullYear();if(this.year!==null&&typeof this.year=="number"&&this.year<i)return null;let n=new d(e.getTime(),this.tz);for(n.addSecond();;){if(this.year!==null){if(i=n.getFullYear(),typeof this.year=="number"&&this.year<i){n=null;break}if(!h(i,this.year)){n.addYear(),n.setMonth(0),n.setDate(1),n.setHours(0),n.setMinutes(0),n.setSeconds(0);continue}}if(this.month!=null&&!h(n.getMonth(),this.month)){n.addMonth();continue}if(this.date!=null&&!h(n.getDate(),this.date)){n.addDay();continue}if(this.dayOfWeek!=null&&!h(n.getDay(),this.dayOfWeek)){n.addDay();continue}if(this.hour!=null&&!h(n.getHours(),this.hour)){n.addHour();continue}if(this.minute!=null&&!h(n.getMinutes(),this.minute)){n.addMinute();continue}if(this.second!=null&&!h(n.getSeconds(),this.second)){n.addSecond();continue}break}return n};function h(e,t){if(t==null)return!0;if(typeof t=="number")return e===t;if(typeof t=="string")return e===Number(t);if(t instanceof D)return t.contains(e);if(Array.isArray(t)||t instanceof Array){for(let i=0;i<t.length;i++)if(h(e,t[i]))return!0}return!1}function A(e,t){const i=Date.now(),n=e.getTime();return J.setTimeout(function(){n>Date.now()?A(e,t):t()},n<i?0:n-i)}function E(e){C.add(g,e,N),k();const t=e.fireDate instanceof d?e.fireDate.toDate():e.fireDate;e.job.emit("scheduled",t)}function k(){if(g.length>0&&l!==g[0]){l!==null&&(J.clearTimeout(l.timerID),l.timerID=null,l=null),l=g[0];const e=l.job,t=l;l.timerID=A(l.fireDate,function(){if(Y(),e.callback&&e.callback(),t.recurrenceRule.recurs||t.recurrenceRule._endDate===null){const i=W(t.recurrenceRule,t.job,t.fireDate,t.endDate);i!==null&&i.job.trackInvocation(i)}e.stopTrackingInvocation(t);try{const i=e.invoke(t.fireDate instanceof d?t.fireDate.toDate():t.fireDate);e.emit("run"),e.running+=1,i instanceof Promise?i.then(function(n){e.emit("success",n),e.running-=1}).catch(function(n){e.emit("error",n),e.running-=1}):(e.emit("success",i),e.running-=1)}catch(i){e.emit("error",i),e.running-=1}e.isOneTimeJob&&e.deleteFromSchedule()})}}function Y(){g.shift(),l=null,k()}function H(e){const t=g.indexOf(e);t>-1&&(g.splice(t,1),e.timerID!==null&&J.clearTimeout(e.timerID),l===e&&(l=null),e.job.emit("canceled",e.fireDate),k())}function W(e,t,i,n){i=i instanceof d?i:new d;const s=e instanceof m?e._nextInvocationDate(i):e.next();if(s===null||n instanceof d&&s.getTime()>n.getTime())return null;const r=new S(t,s,e,n);return E(r),r}var _={Range:D,RecurrenceRule:m,Invocation:S,cancelInvocation:H,scheduleInvocation:E,scheduleNextRecurrence:W,sorter:N,_invocations:g};function G(e){return e.getTime()===e.getTime()}var U={isValidDate:G};const X=z.exports,q=P,v=O,B=$,{scheduleNextRecurrence:I,scheduleInvocation:K,cancelInvocation:p,RecurrenceRule:x,sorter:L,Invocation:Q}=_,{isValidDate:w}=U,R={};let b=0;function Z(){const e=new Date;return b===Number.MAX_SAFE_INTEGER&&(b=0),b++,`<Anonymous Job ${b} ${e.toISOString()}>`}function y(e,t,i){this.pendingInvocations=[];let n=0;const s=e&&typeof e=="string"?e:Z();this.job=e&&typeof e=="function"?e:t,this.job===e?this.callback=typeof t=="function"?t:!1:this.callback=typeof i=="function"?i:!1,this.running=0,typeof this.job=="function"&&this.job.prototype&&this.job.prototype.next&&(this.job=function(){return this.next().value}.bind(this.job.call(this))),Object.defineProperty(this,"name",{value:s,writable:!1,enumerable:!0}),this.trackInvocation=function(r){return B.add(this.pendingInvocations,r,L),!0},this.stopTrackingInvocation=function(r){const o=this.pendingInvocations.indexOf(r);return o>-1?(this.pendingInvocations.splice(o,1),!0):!1},this.triggeredJobs=function(){return n},this.setTriggeredJobs=function(r){n=r},this.deleteFromSchedule=function(){F(this.name)},this.cancel=function(r){r=typeof r=="boolean"?r:!1;let o,u;const a=[];for(let c=0;c<this.pendingInvocations.length;c++)o=this.pendingInvocations[c],p(o),r&&(o.recurrenceRule.recurs||o.recurrenceRule.next)&&(u=I(o.recurrenceRule,this,o.fireDate,o.endDate),u!==null&&a.push(u));this.pendingInvocations=[];for(let c=0;c<a.length;c++)this.trackInvocation(a[c]);return r||this.deleteFromSchedule(),!0},this.cancelNext=function(r){if(r=typeof r=="boolean"?r:!0,!this.pendingInvocations.length)return!1;let o;const u=this.pendingInvocations.shift();return p(u),r&&(u.recurrenceRule.recurs||u.recurrenceRule.next)&&(o=I(u.recurrenceRule,this,u.fireDate,u.endDate),o!==null&&this.trackInvocation(o)),!0},this.reschedule=function(r){let o;const u=this.pendingInvocations.slice();for(let a=0;a<u.length;a++)o=u[a],p(o);return this.pendingInvocations=[],this.schedule(r)?(this.setTriggeredJobs(0),!0):(this.pendingInvocations=u,!1)},this.nextInvocation=function(){return this.pendingInvocations.length?this.pendingInvocations[0].fireDate:null}}Object.setPrototypeOf(y.prototype,X.EventEmitter.prototype);y.prototype.invoke=function(e){return this.setTriggeredJobs(this.triggeredJobs()+1),this.job(e)};y.prototype.runOnDate=function(e){return this.schedule(e)};y.prototype.schedule=function(e){const t=this;let i=!1,n,s,r,o;typeof e=="object"&&"tz"in e&&(o=e.tz),typeof e=="object"&&e.rule&&(s=e.start||void 0,r=e.end||void 0,e=e.rule,s&&(s instanceof Date||(s=new Date(s)),s=new v(s,o),(!w(s)||s.getTime()<Date.now())&&(s=void 0)),r&&!(r instanceof Date)&&!w(r=new Date(r))&&(r=void 0),r&&(r=new v(r,o)));try{const u=q.parseExpression(e,{currentDate:s,tz:o});n=I(u,t,s,r),n!==null&&(i=t.trackInvocation(n))}catch{const a=typeof e;if((a==="string"||a==="number")&&(e=new Date(e)),e instanceof Date&&w(e))e=new v(e),t.isOneTimeJob=!0,e.getTime()>=Date.now()&&(n=new Q(t,e),K(n),i=t.trackInvocation(n));else if(a==="object"){if(t.isOneTimeJob=!1,!(e instanceof x)){const c=new x;"year"in e&&(c.year=e.year),"month"in e&&(c.month=e.month),"date"in e&&(c.date=e.date),"dayOfWeek"in e&&(c.dayOfWeek=e.dayOfWeek),"hour"in e&&(c.hour=e.hour),"minute"in e&&(c.minute=e.minute),"second"in e&&(c.second=e.second),e=c}e.tz=o,n=I(e,t,s,r),n!==null&&(i=t.trackInvocation(n))}}return R[this.name]=this,i};function F(e){e&&delete R[e]}var M={Job:y,deleteScheduledJob:F,scheduledJobs:R};const{Job:T,scheduledJobs:f}=M;function ee(){if(arguments.length<2)throw new RangeError("Invalid number of arguments");const e=arguments.length>=3&&typeof arguments[0]=="string"?arguments[0]:null,t=e?arguments[1]:arguments[0],i=e?arguments[2]:arguments[1],n=e?arguments[3]:arguments[2];if(typeof i!="function")throw new RangeError("The job method must be a function.");const s=new T(e,i,n);return s.schedule(t)?s:null}function te(e,t){if(e instanceof T){if(e.reschedule(t))return e}else if(typeof e=="string")if(Object.prototype.hasOwnProperty.call(f,e)){if(f[e].reschedule(t))return f[e]}else throw new Error("Cannot reschedule one-off job by name, pass job reference instead");return null}function ne(e){let t=!1;return e instanceof T?t=e.cancel():(typeof e=="string"||e instanceof String)&&e in f&&Object.prototype.hasOwnProperty.call(f,e)&&(t=f[e].cancel()),t}function ie(){const e=Object.keys(f).map(i=>f[i]);e.forEach(function(i){i.cancel()});let t=!1;for(let i=0;i<e.length;i++)if(e[i].running>0){t=!0;break}return new Promise(function(i){t?setInterval(function(){for(let n=0;n<e.length;n++)if(e[n].running>0)return;i()},500):i()})}var re={scheduleJob:ee,rescheduleJob:te,scheduledJobs:f,cancelJob:ne,gracefulShutdown:ie};const{cancelJob:oe,rescheduleJob:se,scheduledJobs:ue,scheduleJob:ce,gracefulShutdown:le}=re,{Invocation:ae,RecurrenceRule:fe,Range:he}=_,{Job:de}=M;var Ie={Job:de,Invocation:ae,Range:he,RecurrenceRule:fe,cancelJob:oe,rescheduleJob:se,scheduledJobs:ue,scheduleJob:ce,gracefulShutdown:le};export{Ie as n};
