import{dA as requiredArgs,dL as getTimezoneOffsetInMilliseconds,dB as toDate,_ as _export_sfc,q as defineComponent,dh as useIoBroker,cj as useQuasar,c as computed,de as Pro,d8 as Modules,dM as ConfigFile,a4 as ref,j as resolveComponent,o as openBlock,d as createElementBlock,K as withDirectives,a2 as vShow,k as createVNode,d0 as QLinearProgress,a as createBlock,g as createCommentVNode,n as normalizeStyle,f as normalizeClass,t as toDisplayString,w as withCtx,e as createBaseVNode,ad as QSpace,P as QBtn,L as ClosePopup,J as QMenu,m as withModifiers,ds as Devices,a5 as Functions}from"./index-2b0597a6.js";import"./index-672cae70.js";import{eT as w}from"./components-f01478d4.js";import{s as startOfDay}from"./index-73ece3e2.js";import"./_commonjsHelpers-45ea234c.js";import"./vue.runtime.esm-bundler-1186e0cd.js";import"./QTooltip-782d8f9e.js";import"./json-editor-75b31c57.js";var MILLISECONDS_IN_DAY=864e5;function differenceInCalendarDays(e,n){requiredArgs(2,arguments);var r=startOfDay(e),c=startOfDay(n),f=r.getTime()-getTimezoneOffsetInMilliseconds(r),o=c.getTime()-getTimezoneOffsetInMilliseconds(c);return Math.round((f-o)/MILLISECONDS_IN_DAY)}function compareLocalAsc(e,n){var r=e.getFullYear()-n.getFullYear()||e.getMonth()-n.getMonth()||e.getDate()-n.getDate()||e.getHours()-n.getHours()||e.getMinutes()-n.getMinutes()||e.getSeconds()-n.getSeconds()||e.getMilliseconds()-n.getMilliseconds();return r<0?-1:r>0?1:r}function differenceInDays(e,n){requiredArgs(2,arguments);var r=toDate(e),c=toDate(n),f=compareLocalAsc(r,c),o=Math.abs(differenceInCalendarDays(r,c));r.setDate(r.getDate()-f*o);var t=Number(compareLocalAsc(r,c)===-f),i=f*(o-t);return i===0?0:i}var HistoryGraph_vue_vue_type_style_index_0_lang=(()=>`.jarvis-HistoryGraph-Configuration{padding:0 5px;font-size:80%;cursor:pointer;display:block;line-height:25px;z-index:101;text-align:right}.jarvis-HistoryGraph-Configuration:active,.jarvis-HistoryGraph-Configuration:focus,.jarvis-HistoryGraph-Configuration:hover{background-color:var(--q-primary);color:#fff}
`)();const _sfc_main=defineComponent({name:"ModuleHistoryGraph",props:["_containerSize","_widgetSize","widget"],provide:{[w]:"dark"},setup(props){var e,n,r,c,f;const iobroker=useIoBroker(),$q=useQuasar(),config=computed(()=>props.widget.config),instanceList=((e=iobroker.instanceList)==null?void 0:e.val)||[],from=new Date(new Date().getTime()-7*24*3600*1e3),to=new Date;let callback=null;if(Pro.isPro()&&(config.value.callback||((r=(n=config.value.yAxis)==null?void 0:n.axisLabel)==null?void 0:r.formatter)))try{callback=eval(config.value.callback||((f=(c=config.value.yAxis)==null?void 0:c.axisLabel)==null?void 0:f.formatter));const test=callback(1)}catch(o){callback=null,error.value=o.message,console.error("HistoryGraph",o)}const moduleConfig=computed(()=>({...Modules.joinConfig(config.value,ConfigFile),defaultHistoryAdapter:instanceList.find(o=>["history","sql","influxdb"].includes(o.substr(0,o.indexOf(".")))),stepLineChart:!1,callback,timeTimelineDate:{from:{year:from.getFullYear(),month:from.getMonth()+1,day:from.getDate()},to:{year:to.getFullYear(),month:to.getMonth()+1,day:to.getDate()},...config.value.timeTimelineDate||{}}})),userConfig=ref(moduleConfig.value),tempConfig=ref(moduleConfig.value),optionsTimeType=ConfigFile.find(o=>o.parameter==="timeType").options,optionsTimeReviewUnits=ConfigFile.find(o=>o.parameter==="timeReviewUnit").options,loaded=ref(!1),errors=ref({}),chartSeries=ref([]);let chartLabels={};const addSerieToChart=(o,t,i,a)=>{var h,C;let p=t.label||a&&a.name||a&&a.label||"???",u=0;for(;Object.values(chartLabels).includes(p);)u++,p=p+" ("+u+")";chartLabels[a.id+":"+i.stateKey]=p;const y=parseInt(moduleConfig.value.maxEntries)||500,g=o.length>y?Math.ceil(o.length/y):null;let l={};o.forEach(({ts:s,val:d},b)=>{(g===null||b%g===0)&&(typeof d=="boolean"&&(moduleConfig.value.stepLineChart=!0,d=d===!0?1:0),d=Pro.isPro()&&moduleConfig.value.callback?moduleConfig.value.callback(d,s,b):parseFloat(d)||d,l[s]=l[s]&&l[s][1]!==null?l[s]:[s,d,i.unit||Functions._defaults&&Functions._defaults[t.primaryStateKey]&&Functions._defaults[t.primaryStateKey].unit||""])}),l=Object.values(l);const m=t.moduleConfig&&t.moduleConfig.color?getComputedStyle(document.documentElement).getPropertyValue(t.moduleConfig.color.substr(0,t.moduleConfig.color.length-1).replace("var(",""))||t.moduleConfig.color:void 0,S={name:p,step:moduleConfig.value.stepLineChart||(moduleConfig.value.chartType==="stepped"?"start":void 0),smooth:moduleConfig.value.chartType==="smooth",showSymbol:moduleConfig.value.showSymbol!==void 0?moduleConfig.value.showSymbol:!1,emphasis:{lineStyle:{width:2}},connectNulls:!0,symbol:"roundRect",...moduleConfig.value.series||{},lineStyle:{width:2,color:m,...((h=moduleConfig.value.series)==null?void 0:h.lineStyle)||{}},itemStyle:{width:2,color:m,...((C=moduleConfig.value.series)==null?void 0:C.itemStyle)||{}},type:moduleConfig.value.chartType==="bar"?"bar":"line",yAxisIndex:Pro.isPro()&&moduleConfig.value.yAxis&&Array.isArray(moduleConfig.value.yAxis)&&moduleConfig.value.yAxis.length>1&&t.moduleConfig&&t.moduleConfig.yaxis||0,deviceId:t.deviceId,stateKey:t.primaryStateKey,data:l},v=chartSeries.value.findIndex(s=>s.deviceId===t.deviceId&&s.stateKey===t.primaryStateKey);chartSeries.value[v]=S},subscribe=()=>{const o={...moduleConfig.value,...userConfig.value,count:9999999,aggregate:"none"};if(o.timeType==="timeline")o.start=new Date(o.timeTimelineDate.from.year,o.timeTimelineDate.from.month-1,o.timeTimelineDate.from.day).getTime(),o.end=new Date(o.timeTimelineDate.to.year,o.timeTimelineDate.to.month-1,o.timeTimelineDate.to.day).getTime(),o.count=differenceInDays(o.end,o.start)*200,o.step=o.count*10*60*60;else{let t=(o.timeReviewValue||7)*1e3,i=100;switch(o.timeReviewUnit){case"seconds":break;case"minutes":t=t*60,i=i*10;break;case"hours":t=t*60*60,i=i*60*10;break;case"weeks":t=t*60*60*24*7,i=i*60*60*24*10;break;case"months":t=t*60*60*24*31,i=i*60*60*24*10;break;case"days":default:t=t*60*60*24,i=i*60*60*10;break}o.step=i/1e3,o.review=t}chartLabels={},!props.widget.items||props.widget.items.length===0?(loaded.value=!0,errors.value.noDevices="No devices defined for HistoryGraph!"):(delete errors.value.noDevices,props.widget.items.forEach(t=>{if(t.type==="device"){chartSeries.value.some(v=>v.deviceId===t.deviceId&&v.stateKey===t.primaryStateKey)||chartSeries.value.push({deviceId:t.deviceId,stateKey:t.primaryStateKey,type:moduleConfig.value.chartType==="bar"?"bar":"line",data:[]});const i=(v,{subscriptionKey:h,history:C},s,d)=>{if(loaded.value=!0,v||!C){const b=v&&v.message||"Invalid History Data";return errors.value[h]=s.stateKey+": "+b+"!",errors.value}delete errors.value[h],delete chartLabels[d.id+":"+s.stateKey],addSerieToChart(C,t,s,d)},{start:a,end:p,review:u,step:y,count:g,ack:l,ignoreNull:m,aggregate:S}=o;Devices.history(t.deviceId,t.primaryStateKey,{start:a,end:p,review:u,step:y,count:g,ack:l,ignoreNull:m,aggregate:S,instance:t.historyAdapter||moduleConfig.value.defaultHistoryAdapter},i)}}))},chartOptions=computed(()=>{var p;const o=Pro.isPro()&&moduleConfig.value.yAxis?moduleConfig.value.yAxis:null;!Pro.isPro()&&(moduleConfig.value.xAxis||moduleConfig.value.yAxis)&&Pro.warn("HistoryGraph: Axis Configuration is only available to Pro!");let t=7;const i=2;let a=90;return moduleConfig.value.zoom&&(t+=10,a-=10),moduleConfig.value.dataZoom&&(a-=17),moduleConfig.value.legend==="top"&&(t+=10,a-=10),moduleConfig.value.legend==="bottom"&&(a-=10),{backgroundColor:"transparent",tooltip:{trigger:"axis",formatter:u=>{const y=u.map(g=>{let[,l,m]=g.data||[];return m=typeof m=="object"?m[l]||m.default:m,""+g.marker+'<span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">'+g.seriesName+'</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">'+(typeof l=="number"?l.toFixed(2):"-")+(m?" "+m:"")+"</span>"});return u[0].axisValueLabel.replace(" 00:00:00","")+"<br />"+y.join("<br />")}},legend:{show:moduleConfig.value.legend!=="off",bottom:moduleConfig.value.legend==="bottom"?moduleConfig.value.dataZoom?50:0:"auto",padding:[10,10,0,10],textStyle:{color:$q.dark.isActive?"#fff":"#666"}},grid:{top:t+"%",left:"2%",right:"2%",bottom:i+"%",containLabel:!0,height:a+"%"},toolbox:{feature:{dataZoom:{show:moduleConfig.value.zoom,yAxisIndex:"none"}}},xAxis:{...Pro.isPro()&&moduleConfig.value.xAxis||{},axisLabel:{fontSize:10,...Pro.isPro()&&((p=moduleConfig.value.xAxis)==null?void 0:p.axisLabel)||{},formatter:moduleConfig.value.dateFormat?moduleConfig.value.dateFormat.replace("HH:mm|dd.MM.","{HH}:{mm}|{dd}.{MM}.").replace(/\|/g,`
`):{year:"{yyyy}",month:"{MMM}",day:`
{dd}.{MM}.`,hour:`{HH}:{mm}
{dd}.{MM}.`,minute:"{HH}:{mm}",second:"{HH}:{mm}:{ss}",millisecond:"{hh}:{mm}:{ss} {SSS}",none:"{yyyy}-{MM}-{dd} {hh}:{mm}:{ss} {SSS}"}},type:"time"},yAxis:o&&Array.isArray(o)&&o.length>0?o.map(u=>({splitLine:{lineStyle:{color:"#ccc"}},...u,axisLabel:{...(u==null?void 0:u.axisLabel)||{},formatter:void 0}})):{splitLine:{lineStyle:{color:"#ccc"}},type:"value",...o||{},axisLabel:{...(o==null?void 0:o.axisLabel)||{},formatter:void 0},show:!moduleConfig.value.stepLineChart},dataZoom:moduleConfig.value.dataZoom&&[{start:100-(moduleConfig.value.dataZoom===1?100:parseInt(moduleConfig.value.dataZoom)||100),end:100}],series:chartSeries.value}}),onApply=()=>{userConfig.value=tempConfig.value,loaded.value=!1,subscribe()},onCancel=()=>{tempConfig.value=userConfig.value},onChange=o=>{tempConfig.value[o.id]=o.value};return subscribe(),{loaded,errors,moduleConfig,userConfig,tempConfig,chartOptions,onApply,onCancel,onChange,optionsTimeType,optionsTimeReviewUnits}}}),_hoisted_1={key:0},_hoisted_2={key:1},_hoisted_3={class:"row no-wrap q-pa-sm items-center bg-primary text-white"};function _sfc_render(e,n,r,c,f,o){const t=resolveComponent("alert"),i=resolveComponent("v-chart"),a=resolveComponent("inputs");return openBlock(),createElementBlock("div",{class:"jarvis-HistoryGraph-Container",style:{"min-width":"1px","min-height":"1px"},onTouchstart:n[0]||(n[0]=withModifiers(()=>{},["stop"]))},[withDirectives(createVNode(QLinearProgress,{indeterminate:""},null,512),[[vShow,!e.loaded]]),Object.values(e.errors).length>0?(openBlock(),createBlock(t,{key:0,title:Object.values(e.errors).join("<br />")},null,8,["title"])):createCommentVNode("",!0),e.loaded?(openBlock(),createElementBlock("div",{key:1,class:"jarvis-HistoryGraph",style:normalizeStyle({"min-width":"100%","min-height":"100%",width:(e._widgetSize.width||e._containerSize.width)+"px",height:e._containerSize.height-25+"px"})},[createVNode(i,{autoresize:"",ref:"vchart",option:e.chartOptions},null,8,["option"])],4)):createCommentVNode("",!0),e.moduleConfig.timeConfigurable?withDirectives((openBlock(),createElementBlock("a",{key:2,class:normalizeClass(["jarvis-HistoryGraph-Configuration","jarvis-HistoryGraph-Configuration-"+e.widget.id])},[e.userConfig.timeType==="timeline"?(openBlock(),createElementBlock("span",_hoisted_1,toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.from.year)+" - "+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.to.year),1)):(openBlock(),createElementBlock("span",_hoisted_2,toDisplayString(e.userConfig.timeReviewValue)+" "+toDisplayString(e.$t(e.userConfig.timeReviewUnit)),1)),e.moduleConfig.timeConfigurable?(openBlock(),createBlock(QMenu,{key:2,fit:"",cover:"",class:"jarvis-HistoryGraph-Menu",target:".jarvis-HistoryGraph-Configuration-"+e.widget.id,onHide:e.onCancel},{default:withCtx(()=>[createBaseVNode("div",_hoisted_3,[createVNode(a,{class:"text-white",id:"timeType",type:"Select",dense:"",value:e.tempConfig.timeType,onOnSelect:e.onChange,options:e.optionsTimeType},null,8,["value","onOnSelect","options"]),withDirectives(createVNode(a,{id:"timeTimelineDate",type:"Date",dense:"",value:e.tempConfig.timeTimelineDate,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="timeline"]]),withDirectives(createVNode(a,{id:"timeReviewValue",type:"Number",dense:"",value:e.tempConfig.timeReviewValue,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="review"]]),withDirectives(createVNode(a,{id:"timeReviewUnit",type:"Select",dense:"",value:e.tempConfig.timeReviewUnit,options:e.optionsTimeReviewUnits,onOnSelect:e.onChange},null,8,["value","options","onOnSelect"]),[[vShow,e.tempConfig.timeType==="review"]]),createVNode(QSpace),withDirectives(createVNode(QBtn,{flat:"",label:e.$t("Apply"),onClick:e.onApply},null,8,["label","onClick"]),[[ClosePopup]])])]),_:1},8,["target","onHide"])):createCommentVNode("",!0)],2)),[[vShow,e.loaded]]):createCommentVNode("",!0)],32)}var HistoryGraph=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{HistoryGraph as default};
