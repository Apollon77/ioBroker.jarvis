import{dA as Y,dL as Z,dB as $,_ as oe,q as ne,dh as se,cj as re,aC as le,d8 as me,dM as R,a4 as H,c as de,de as k,j as P,o as w,d as A,K as T,a2 as I,k as h,d0 as ue,a as q,g as G,n as pe,f as ye,t as v,w as fe,e as ge,ad as ce,P as he,L as ve,J as Ce,m as we,ds as be,a5 as x}from"./index-9b3d623a.js";import"./index-61c294a1.js";import{eT as Se}from"./components-58ae6d36.js";import{s as E}from"./index-45522896.js";import"./_commonjsHelpers-45ea234c.js";import"./vue.runtime.esm-bundler-a62b0c26.js";import"./QTooltip-0ea98b06.js";import"./json-editor-a7e0d10a.js";var De=864e5;function Te(e,n){Y(2,arguments);var s=E(e),p=E(n),t=s.getTime()-Z(s),y=p.getTime()-Z(p);return Math.round((t-y)/De)}function Q(e,n){var s=e.getFullYear()-n.getFullYear()||e.getMonth()-n.getMonth()||e.getDate()-n.getDate()||e.getHours()-n.getHours()||e.getMinutes()-n.getMinutes()||e.getSeconds()-n.getSeconds()||e.getMilliseconds()-n.getMilliseconds();return s<0?-1:s>0?1:s}function Me(e,n){Y(2,arguments);var s=$(e),p=$(n),t=Q(s,p),y=Math.abs(Te(s,p));s.setDate(s.getDate()-t*y);var C=Number(Q(s,p)===-t),b=t*(y-C);return b===0?0:b}const He=ne({name:"ModuleHistoryGraph",props:["_containerSize","_widgetSize","widget"],provide:{[Se]:"dark"},setup(e){var B;const n=se(),s=re(),p=le(e.widget,"config"),t=me.joinConfig(p.value,R);t.stepLineChart=!1;const y=new Date(new Date().getTime()-7*24*3600*1e3),C=new Date;t.timeTimelineDate={from:{year:y.getFullYear(),month:y.getMonth()+1,day:y.getDate()},to:{year:C.getFullYear(),month:C.getMonth()+1,day:C.getDate()},...t.timeTimelineDate||{}};const b=((B=n.instanceList)==null?void 0:B.val)||[];t.defaultHistoryAdapter=b.find(i=>["history","sql","influxdb"].includes(i.substr(0,i.indexOf("."))));const f=H(t),z=H(t),J=R.find(i=>i.parameter==="timeType").options,W=R.find(i=>i.parameter==="timeReviewUnit").options,j=H(!1),S=H({}),M=H([]);let O={};const X=(i,a,o,r)=>{let l=a.label||r&&r.name||r&&r.label||"???",D=0;for(;Object.values(O).includes(l);)D++,l=l+" ("+D+")";O[r.id+":"+o.stateKey]=l;const g=parseInt(t.maxEntries)||500,c=i.length>g?Math.ceil(i.length/g):null;let m=[];i.forEach(({ts:d,val:u},L)=>{(c===null||L%c===0)&&(typeof u=="boolean"&&(t.stepLineChart=!0,u=u===!0?1:0),u=parseFloat(u)||u,m.push([d,u,o.unit||x._defaults&&x._defaults[a.primaryStateKey]&&x._defaults[a.primaryStateKey].unit||""]))});const K={deviceId:a.deviceId,stateKey:a.primaryStateKey,name:l,type:t.chartType==="bar"?"bar":"line",yAxisIndex:k.isPro()&&t.yAxis&&Array.isArray(t.yAxis)&&t.yAxis.length>1&&a.moduleConfig&&a.moduleConfig.yaxis||0,step:t.stepLineChart||(t.chartType==="stepped"?"start":void 0),smooth:t.chartType==="smooth",showSymbol:t.showSymbol!==void 0?t.showSymbol:!1,lineStyle:{width:2,color:a.moduleConfig&&a.moduleConfig.color},itemStyle:{width:2,color:a.moduleConfig&&a.moduleConfig.color},emphasis:{lineStyle:{width:2}},connectNulls:!0,symbol:"roundRect",data:m},N=M.value.findIndex(d=>d.deviceId===a.deviceId&&d.stateKey===a.primaryStateKey);M.value[N]=K},V=()=>{const i={...t,...f.value,count:9999999,aggregate:"none"};if(i.timeType==="timeline")i.start=new Date(i.timeTimelineDate.from.year,i.timeTimelineDate.from.month-1,i.timeTimelineDate.from.day).getTime(),i.end=new Date(i.timeTimelineDate.to.year,i.timeTimelineDate.to.month-1,i.timeTimelineDate.to.day).getTime(),i.count=Me(i.end,i.start)*200,i.step=i.count*10*60*60;else{let a=(i.timeReviewValue||7)*1e3,o=100;switch(i.timeReviewUnit){case"seconds":break;case"minutes":a=a*60,o=o*10;break;case"hours":a=a*60*60,o=o*60*10;break;case"weeks":a=a*60*60*24*7,o=o*60*60*24*10;break;case"months":a=a*60*60*24*31,o=o*60*60*24*10;break;case"days":default:a=a*60*60*24,o=o*60*60*10;break}i.step=o/1e3,i.review=a}O={},!e.widget.items||e.widget.items.length===0?(j.value=!0,S.value.noDevices="No devices defined for HistoryGraph!"):(delete S.value.noDevices,e.widget.items.forEach(a=>{if(a.type==="device"){M.value.some(d=>d.deviceId===a.deviceId&&d.stateKey===a.primaryStateKey)||M.value.push({deviceId:a.deviceId,stateKey:a.primaryStateKey,type:t.chartType==="bar"?"bar":"line",data:[]});const o=(d,{subscriptionKey:u,history:L},F,U)=>{if(j.value=!0,d||!L){const ae=d&&d.message||"Invalid History Data";return S.value[u]=F.stateKey+": "+ae+"!",S.value}delete S.value[u],delete O[U.id+":"+F.stateKey],X(L,a,F,U)},{start:r,end:l,review:D,step:g,count:c,ack:m,ignoreNull:K,aggregate:N}=i;be.history(a.deviceId,a.primaryStateKey,{start:r,end:l,review:D,step:g,count:c,ack:m,ignoreNull:K,aggregate:N,instance:a.historyAdapter||t.defaultHistoryAdapter},o)}}))},_=de(()=>{const i=k.isPro()&&t.yAxis?t.yAxis:null;!k.isPro()&&(t.xAxis||t.yAxis)&&k.warn("HistoryGraph: Axis Configuration is only available to Pro!");let a=7;const o=2;let r=90;return t.zoom&&(a+=10,r-=10),t.dataZoom&&(r-=17),t.legend==="top"&&(a+=10,r-=10),t.legend==="bottom"&&(r-=10),{backgroundColor:"transparent",tooltip:{trigger:"axis",formatter:l=>{const D=l.map(g=>{let[,c,m]=g.data||[];return m=typeof m=="object"?m[c]||m.default:m,""+g.marker+'<span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">'+g.seriesName+'</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">'+(typeof c=="number"?c.toFixed(2):"-")+(m?" "+m:"")+"</span>"});return l[0].axisValueLabel.replace(" 00:00:00","")+"<br />"+D.join("<br />")}},legend:{show:t.legend!=="off",bottom:t.legend==="bottom"?t.dataZoom?50:0:"auto",padding:[10,10,0,10],textStyle:{color:s.dark.isActive?"#fff":"#666"}},grid:{top:a+"%",left:"2%",right:"2%",bottom:o+"%",containLabel:!0,height:r+"%"},toolbox:{feature:{dataZoom:{show:t.zoom,yAxisIndex:"none"}}},xAxis:{axisLabel:{fontSize:10,formatter:t.dateFormat?t.dateFormat.replace("HH:mm|dd.MM.","{HH}:{mm}|{dd}.{MM}.").replace(/\|/g,`
`):{year:"{yyyy}",month:"{MMM}",day:`
{dd}.{MM}.`,hour:`{HH}:{mm}
{dd}.{MM}.`,minute:"{HH}:{mm}",second:"{HH}:{mm}:{ss}",millisecond:"{hh}:{mm}:{ss} {SSS}",none:"{yyyy}-{MM}-{dd} {hh}:{mm}:{ss} {SSS}"}},...k.isPro()&&t.xAxis||{},type:"time"},yAxis:i&&Array.isArray(i)&&i.length>0?i.map(l=>({splitLine:{lineStyle:{color:"#ccc"}},...l})):{splitLine:{lineStyle:{color:"#ccc"}},...i||{},type:"value",show:!t.stepLineChart},dataZoom:t.dataZoom&&[{start:100-(t.dataZoom===1?100:parseInt(t.dataZoom)||100),end:100}],series:M.value}}),ee=()=>{f.value=z.value,j.value=!1,V()},te=()=>{z.value=f.value},ie=i=>{z.value[i.id]=i.value};return V(),{loaded:j,errors:S,moduleConfig:t,userConfig:f,tempConfig:z,chartOptions:_,onApply:ee,onCancel:te,onChange:ie,optionsTimeType:J,optionsTimeReviewUnits:W}}}),ke={key:0},Ae={key:1},Ie={class:"row no-wrap q-pa-sm items-center bg-primary text-white"};function ze(e,n,s,p,t,y){const C=P("alert"),b=P("v-chart"),f=P("inputs");return w(),A("div",{class:"jarvis-HistoryGraph-Container",style:{"min-width":"1px","min-height":"1px"},onTouchstart:n[0]||(n[0]=we(()=>{},["stop"]))},[T(h(ue,{indeterminate:""},null,512),[[I,!e.loaded]]),Object.values(e.errors).length>0?(w(),q(C,{key:0,title:Object.values(e.errors).join("<br />")},null,8,["title"])):G("",!0),e.loaded?(w(),A("div",{key:1,class:"jarvis-HistoryGraph",style:pe({"min-width":"100%","min-height":"100%",width:(e._widgetSize.width||e._containerSize.width)+"px",height:e._containerSize.height-25+"px"})},[h(b,{autoresize:"",ref:"vchart",option:e.chartOptions},null,8,["option"])],4)):G("",!0),e.moduleConfig.timeConfigurable?T((w(),A("a",{key:2,class:ye(["jarvis-HistoryGraph-Configuration","jarvis-HistoryGraph-Configuration-"+e.widget.id])},[e.userConfig.timeType==="timeline"?(w(),A("span",ke,v(e.zero(e.userConfig.timeTimelineDate.from.day))+"."+v(e.zero(e.userConfig.timeTimelineDate.from.month))+"."+v(e.userConfig.timeTimelineDate.from.year)+" - "+v(e.zero(e.userConfig.timeTimelineDate.to.day))+"."+v(e.zero(e.userConfig.timeTimelineDate.to.month))+"."+v(e.userConfig.timeTimelineDate.to.year),1)):(w(),A("span",Ae,v(e.userConfig.timeReviewValue)+" "+v(e.$t(e.userConfig.timeReviewUnit)),1)),e.moduleConfig.timeConfigurable?(w(),q(Ce,{key:2,fit:"",cover:"",class:"jarvis-HistoryGraph-Menu",target:".jarvis-HistoryGraph-Configuration-"+e.widget.id,onHide:e.onCancel},{default:fe(()=>[ge("div",Ie,[h(f,{class:"text-white",id:"timeType",type:"Select",dense:"",value:e.tempConfig.timeType,onOnSelect:e.onChange,options:e.optionsTimeType},null,8,["value","onOnSelect","options"]),T(h(f,{id:"timeTimelineDate",type:"Date",dense:"",value:e.tempConfig.timeTimelineDate,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[I,e.tempConfig.timeType==="timeline"]]),T(h(f,{id:"timeReviewValue",type:"Number",dense:"",value:e.tempConfig.timeReviewValue,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[I,e.tempConfig.timeType==="review"]]),T(h(f,{id:"timeReviewUnit",type:"Select",dense:"",value:e.tempConfig.timeReviewUnit,options:e.optionsTimeReviewUnits,onOnSelect:e.onChange},null,8,["value","options","onOnSelect"]),[[I,e.tempConfig.timeType==="review"]]),h(ce),T(h(he,{flat:"",label:e.$t("Apply"),onClick:e.onApply},null,8,["label","onClick"]),[[ve]])])]),_:1},8,["target","onHide"])):G("",!0)],2)),[[I,e.loaded]]):G("",!0)],32)}var Pe=oe(He,[["render",ze]]);export{Pe as default};
