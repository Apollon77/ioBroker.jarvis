import{dE as requiredArgs,dQ as getTimezoneOffsetInMilliseconds,dF as toDate,bt as _export_sfc,a4 as defineComponent,bN as useIoBroker,co as useQuasar,Q as computed,dc as Modules,dR as ConfigFile,dj as Pro,k as ref,d8 as v4,as as onMounted,aw as onUnmounted,dw as Devices,bJ as zero,aG as resolveComponent,ay as openBlock,W as createElementBlock,b3 as withDirectives,bn as vShow,a2 as createVNode,d3 as QLinearProgress,U as createBlock,V as createCommentVNode,C as normalizeStyle,A as normalizeClass,D as toDisplayString,b1 as withCtx,X as createBaseVNode,bD as QSpace,bB as QBtn,bE as ClosePopup,by as QMenu,bp as withModifiers,cq as Log,dK as setCssVar,bR as Functions}from"./index-4e13b6ad.js";import"./index-68a748d9.js";import{eW as w}from"./components-f0a0b6c9.js";import{s as startOfDay}from"./index-c9e24eb3.js";import"./_commonjsHelpers-55d1ff45.js";import"./QTooltip-0891dbb0.js";import"./json-editor-1bee4739.js";var MILLISECONDS_IN_DAY=864e5;function differenceInCalendarDays(e,l){requiredArgs(2,arguments);var r=startOfDay(e),g=startOfDay(l),p=r.getTime()-getTimezoneOffsetInMilliseconds(r),h=g.getTime()-getTimezoneOffsetInMilliseconds(g);return Math.round((p-h)/MILLISECONDS_IN_DAY)}function compareLocalAsc(e,l){var r=e.getFullYear()-l.getFullYear()||e.getMonth()-l.getMonth()||e.getDate()-l.getDate()||e.getHours()-l.getHours()||e.getMinutes()-l.getMinutes()||e.getSeconds()-l.getSeconds()||e.getMilliseconds()-l.getMilliseconds();return r<0?-1:r>0?1:r}function differenceInDays(e,l){requiredArgs(2,arguments);var r=toDate(e),g=toDate(l),p=compareLocalAsc(r,g),h=Math.abs(differenceInCalendarDays(r,g));r.setDate(r.getDate()-p*h);var M=Number(compareLocalAsc(r,g)===-p),S=p*(h-M);return S===0?0:S}var HistoryGraph_vue_vue_type_style_index_0_lang="";const _sfc_main=defineComponent({name:"ModuleHistoryGraph",props:["_containerSize","_widgetSize","widget"],provide:{[w]:"dark"},setup(props){var e,l,r,g,p,h,M,S,D,N,P,z,V,B,K,F,R,E,j,G,U;const iobroker=useIoBroker(),$q=useQuasar(),config=computed(()=>props.widget.config),instanceList=((e=iobroker.instanceList)==null?void 0:e.val)||[],from=new Date(new Date().getTime()-7*24*3600*1e3),to=new Date,moduleConfig=computed(()=>({...Modules.joinConfig(config.value,ConfigFile),defaultHistoryAdapter:instanceList.find(o=>["history","sql","influxdb"].includes(o.substr(0,o.indexOf(".")))),stepLineChart:!1,timeTimelineDate:{from:{year:from.getFullYear(),month:from.getMonth()+1,day:from.getDate()},to:{year:to.getFullYear(),month:to.getMonth()+1,day:to.getDate()},...config.value.timeTimelineDate||{}}}));if(Pro.isPro()&&((r=(l=moduleConfig.value.xAxis)==null?void 0:l.axisLabel)==null?void 0:r.formatter)&&((p=(g=moduleConfig.value.xAxis)==null?void 0:g.axisLabel)==null?void 0:p.formatter.indexOf("("))!==-1&&((M=(h=moduleConfig.value.xAxis)==null?void 0:h.axisLabel)==null?void 0:M.formatter.indexOf(")"))!==-1)try{moduleConfig.value.xCallback=eval((D=(S=moduleConfig.value.xAxis)==null?void 0:S.axisLabel)==null?void 0:D.formatter);const test=moduleConfig.value.xCallback&&moduleConfig.value.xCallback(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.xCallback,(P=(N=moduleConfig.value.xAxis)==null?void 0:N.axisLabel)==null?void 0:P.formatter,o),moduleConfig.value.xCallback=null}if(Pro.isPro()&&(moduleConfig.value.callback||((V=(z=moduleConfig.value.yAxis)==null?void 0:z.axisLabel)==null?void 0:V.formatter)&&((K=(B=moduleConfig.value.yAxis)==null?void 0:B.axisLabel)==null?void 0:K.formatter.indexOf("("))!==-1&&((R=(F=moduleConfig.value.yAxis)==null?void 0:F.axisLabel)==null?void 0:R.formatter.indexOf(")"))!==-1))try{moduleConfig.value.yCallback=eval(moduleConfig.value.callback||((j=(E=moduleConfig.value.yAxis)==null?void 0:E.axisLabel)==null?void 0:j.formatter));const test=moduleConfig.value.yCallback&&moduleConfig.value.yCallback(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.yCallback,moduleConfig.value.callback,(U=(G=moduleConfig.value.yAxis)==null?void 0:G.axisLabel)==null?void 0:U.formatter,o),moduleConfig.value.yCallback=null}const userConfig=ref(moduleConfig.value),tempConfig=ref(moduleConfig.value),optionsTimeType=ConfigFile.find(o=>o.parameter==="timeType").options,optionsTimeReviewUnits=ConfigFile.find(o=>o.parameter==="timeReviewUnit").options,loaded=ref(!1),errors=ref({}),key=ref(v4()),chartSeries=ref([]);let chartLabels={};const addSerieToChart=(o,t,b,u)=>{var C,T;Log.dev("Add Serie to Chart",o,t,b,u);let m=t&&t.label||u&&u.name||u&&u.label||"???",i={};t.moduleConfig&&t.moduleConfig.color&&setCssVar("history-graph--"+m.toLowerCase().replace(/ /g,"-").replace(/\./g,"-"),t.moduleConfig.color);let v=0;for(;Object.values(chartLabels).includes(m);)v++,m=m+" ("+v+")";chartLabels[u.id+":"+b.stateKey]=m;const y=parseInt(moduleConfig.value.maxEntries)||500,f=o.length>y?Math.ceil(o.length/y):null;if(o.forEach(({ts:a,val:n},d)=>{a=Math.round(a/1e3)*1e3,(f===null||d%f===0)&&(typeof n=="boolean"&&(moduleConfig.value.stepLineChart=!0,n=n===!0?1:0),n=Pro.isPro()&&moduleConfig.value.yCallback?moduleConfig.value.yCallback(n,a,d):parseFloat(n)||n,(!moduleConfig.value.yAxis||moduleConfig.value.yAxis.type!=="log"||moduleConfig.value.yAxis.type==="log"&&n!==0)&&(i[a]=i[a]&&i[a][1]!==null?i[a]:[a,n,b.unit||Functions._defaults&&Functions._defaults[t.primaryStateKey]&&Functions._defaults[t.primaryStateKey].unit||""]))}),moduleConfig.value.timeType==="review"&&o.length>0){const a=moduleConfig.value.timeReviewUnit,n=Date.now(),d=(n-o[o.length-1].ts)/1e3,L=Math.floor(d/60),O=Math.floor(L/60),I=Math.floor(O/24),Q=Math.floor(I/7),_=Math.floor(I/30);let k=null,A=1;if(a==="months"&&_>1?(k=_,A=30*24*60*60):a==="weeks"&&Q>1?(k=Q,A=7*24*60*60):a==="days"&&I>1?(k=I,A=24*60*60):a==="hours"&&O>1?(k=O,A=60*60):a==="minutes"&&L>1?(k=L,A=60):a==="seconds"&&d>1&&(k=d,A=1),k)for(let H=o[o.length-1].ts/1e3;H<=Math.floor(n/1e3);H+=A)i[H]=[H*1e3,o[o.length-1].val,b.unit||Functions._defaults&&Functions._defaults[t.primaryStateKey]&&Functions._defaults[t.primaryStateKey].unit||""]}i=Object.values(i);const c=t.moduleConfig&&t.moduleConfig.color?getComputedStyle(document.documentElement).getPropertyValue(t.moduleConfig.color.substr(0,t.moduleConfig.color.length-1).replace("var(",""))||t.moduleConfig.color:void 0,s={name:m,step:moduleConfig.value.stepLineChart||(moduleConfig.value.chartType==="stepped"?"start":void 0),smooth:moduleConfig.value.chartType==="smooth",showSymbol:moduleConfig.value.showSymbol!==void 0?moduleConfig.value.showSymbol:!1,emphasis:{lineStyle:{width:2}},connectNulls:!0,symbol:"roundRect",...moduleConfig.value.series||{},lineStyle:{width:2,color:c,...((C=moduleConfig.value.series)==null?void 0:C.lineStyle)||{}},itemStyle:{width:2,color:c,...((T=moduleConfig.value.series)==null?void 0:T.itemStyle)||{}},type:moduleConfig.value.chartType==="bar"?"bar":"line",yAxisIndex:Pro.isPro()&&moduleConfig.value.yAxis&&Array.isArray(moduleConfig.value.yAxis)&&moduleConfig.value.yAxis.length>1&&t.moduleConfig&&Number.isInteger(t.moduleConfig.yaxis)?t.moduleConfig.yaxis:0,deviceId:t.deviceId,stateKey:t.primaryStateKey,data:i},x=chartSeries.value.findIndex(a=>a.deviceId===t.deviceId&&a.stateKey===t.primaryStateKey);chartSeries.value[x]=s,key.value=v4()},subscriptionKeys=[],subscribe=()=>{const o={...moduleConfig.value,...userConfig.value,count:999999,aggregate:"none"};if(o.timeType==="timeline")o.start=new Date(o.timeTimelineDate.from.year,o.timeTimelineDate.from.month-1,o.timeTimelineDate.from.day).getTime(),o.end=new Date(o.timeTimelineDate.to.year,o.timeTimelineDate.to.month-1,o.timeTimelineDate.to.day).getTime(),o.count=differenceInDays(o.end,o.start)*200;else{let t=(o.timeReviewValue||7)*1e3;switch(o.timeReviewUnit){case"seconds":break;case"minutes":t=t*60;break;case"hours":t=t*60*60;break;case"weeks":t=t*60*60*24*7;break;case"months":t=t*60*60*24*31;break;case"days":default:t=t*60*60*24;break}o.review=t}chartLabels={},!props.widget.items||props.widget.items.length===0?(loaded.value=!0,errors.value.noDevices="No devices defined for HistoryGraph!"):(delete errors.value.noDevices,props.widget.items.forEach(t=>{if(t.type==="device"){chartSeries.value.some(C=>C.deviceId===t.deviceId&&C.stateKey===t.primaryStateKey)||chartSeries.value.push({deviceId:t.deviceId,stateKey:t.primaryStateKey,type:moduleConfig.value.chartType==="bar"?"bar":"line",data:[]});const b=(C,{subscriptionKey:T,history:a},n,d)=>{if(Log.dev("Got history data",T,d.id,a&&a.label||d&&d.name||d&&d.label,n,n.stateKey),loaded.value=!0,C||!a){const L=C&&C.message||"Invalid History Data";return errors.value[T]=n.stateKey+": "+L+"!",errors.value}delete errors.value[T],delete chartLabels[d.id+":"+n.stateKey],addSerieToChart(a,t,n,d)},{start:u,end:m,review:i,step:v,count:y,ack:f,ignoreNull:c,aggregate:s}=o,x=Devices.history(t.deviceId,t.primaryStateKey,{timeRefresh:o.timeRefresh,timeReviewUnit:o.timeReviewUnit,start:u,end:m,review:i,step:v,count:y,ack:f,ignoreNull:c,aggregate:s,instance:t.historyAdapter||moduleConfig.value.defaultHistoryAdapter},b);subscriptionKeys.push({subscriptionKey:x,deviceId:t.deviceId,stateKey:t.primaryStateKey})}}))},chartOptions=computed(()=>{var m;const o=Pro.isPro()&&moduleConfig.value.yAxis?moduleConfig.value.yAxis:null;!Pro.isPro()&&(moduleConfig.value.xAxis||moduleConfig.value.yAxis)&&Pro.warn("HistoryGraph: Axis Configuration is only available to Pro!");let t=7;const b=2;let u=90;return moduleConfig.value.zoom&&(t+=10,u-=10),moduleConfig.value.dataZoom&&(u-=17),moduleConfig.value.legend==="top"&&(t+=10,u-=10),moduleConfig.value.legend==="bottom"&&(u-=10),{key,backgroundColor:"transparent",tooltip:{trigger:"axis",position:(i,v,y,f,c)=>{const s=i[0],x=c.viewSize[0];return s>x/2?{left:s-c.contentSize[0],top:"10%"}:{left:s,top:"10%"}},formatter:i=>{const v=Array.isArray(i)?i:[],y={};return v.forEach(f=>{let[,c,s]=f.data||[];s=typeof s=="object"?s[c]||s.default:s,y[f.seriesId]===void 0&&(y[f.seriesId]=""+f.marker+'<span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">'+f.seriesName+'</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">'+(typeof c=="number"?c.toFixed(2):"-")+(s?" "+s:"")+"</span>")}),v[0]?v[0].axisValueLabel.replace(" 00:00:00","")+"<br />"+Object.values(y).join("<br />"):null}},legend:{show:moduleConfig.value.legend!=="off",bottom:moduleConfig.value.legend==="bottom"?moduleConfig.value.dataZoom?50:0:"auto",padding:[10,10,0,10],textStyle:{color:$q.dark.isActive?"#fff":"#666"}},grid:{top:t+"%",left:"2%",right:"2%",bottom:b+"%",containLabel:!0,height:u+"%"},toolbox:{feature:{dataZoom:{show:moduleConfig.value.zoom,yAxisIndex:"none"}}},xAxis:{...Pro.isPro()&&moduleConfig.value.xAxis||{},axisLabel:{fontSize:10,...Pro.isPro()&&((m=moduleConfig.value.xAxis)==null?void 0:m.axisLabel)||{},formatter:Pro.isPro()&&moduleConfig.value.xCallback?moduleConfig.value.xCallback:moduleConfig.value.dateFormat?moduleConfig.value.dateFormat.replace("HH:mm|dd.MM.","{HH}:{mm}|{dd}.{MM}.").replace(/\|/g,`
`):{year:"{yyyy}",month:"{MMM}",day:`
{dd}.{MM}.`,hour:`{HH}:{mm}
{dd}.{MM}.`,minute:"{HH}:{mm}",second:"{HH}:{mm}:{ss}",millisecond:"{hh}:{mm}:{ss} {SSS}",none:"{yyyy}-{MM}-{dd} {hh}:{mm}:{ss} {SSS}"}},type:"time"},yAxis:o&&Array.isArray(o)&&o.length>0?o.map(i=>({splitLine:{lineStyle:{color:"#ccc"}},...i,axisLabel:{...(i==null?void 0:i.axisLabel)||{}}})):{splitLine:{lineStyle:{color:"#ccc"}},type:"value",...o||{},axisLabel:{...(o==null?void 0:o.axisLabel)||{}},show:!moduleConfig.value.stepLineChart},dataZoom:moduleConfig.value.dataZoom&&[{start:100-(moduleConfig.value.dataZoom===1?100:parseInt(moduleConfig.value.dataZoom)||100),end:100}],series:chartSeries.value}}),onApply=()=>{userConfig.value=tempConfig.value,loaded.value=!1,subscribe()},onCancel=()=>{tempConfig.value=userConfig.value},onChange=o=>{tempConfig.value[o.id]=o.value};return onMounted(()=>subscribe()),onUnmounted(()=>{subscriptionKeys.forEach(o=>{Devices.unsubscribe(o.subscriptionKey,o.deviceId,o.stateKey,"history")})}),{zero,loaded,errors,moduleConfig,userConfig,tempConfig,chartOptions,onApply,onCancel,onChange,optionsTimeType,optionsTimeReviewUnits}}}),_hoisted_1={key:0},_hoisted_2={key:1},_hoisted_3={class:"row no-wrap q-pa-sm items-center bg-primary text-white"};function _sfc_render(e,l,r,g,p,h){const M=resolveComponent("alert"),S=resolveComponent("v-chart"),D=resolveComponent("inputs");return openBlock(),createElementBlock("div",{class:"jarvis-HistoryGraph-Container",style:{"min-width":"1px","min-height":"1px"},onTouchstart:l[0]||(l[0]=withModifiers(()=>{},["stop"]))},[withDirectives(createVNode(QLinearProgress,{indeterminate:""},null,512),[[vShow,!e.loaded]]),Object.values(e.errors).length>0?(openBlock(),createBlock(M,{key:0,title:Object.values(e.errors).join("<br />")},null,8,["title"])):createCommentVNode("",!0),e.loaded?(openBlock(),createElementBlock("div",{key:1,class:"jarvis-HistoryGraph",style:normalizeStyle({"min-width":"100%","min-height":"100%",width:(e._widgetSize.width||e._containerSize.width)+"px",height:e._containerSize.height-25+"px"})},[createVNode(S,{autoresize:"",option:e.chartOptions},null,8,["option"])],4)):createCommentVNode("",!0),e.moduleConfig.timeConfigurable?withDirectives((openBlock(),createElementBlock("a",{key:2,class:normalizeClass(["jarvis-HistoryGraph-Configuration","jarvis-HistoryGraph-Configuration-"+e.widget.id])},[e.userConfig.timeType==="timeline"?(openBlock(),createElementBlock("span",_hoisted_1,toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.from.year)+" - "+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.to.year),1)):(openBlock(),createElementBlock("span",_hoisted_2,toDisplayString(e.userConfig.timeReviewValue)+" "+toDisplayString(e.$t(e.userConfig.timeReviewUnit)),1)),e.moduleConfig.timeConfigurable?(openBlock(),createBlock(QMenu,{key:2,fit:"",cover:"",class:"jarvis-HistoryGraph-Menu",target:".jarvis-HistoryGraph-Configuration-"+e.widget.id,onHide:e.onCancel},{default:withCtx(()=>[createBaseVNode("div",_hoisted_3,[createVNode(D,{class:"text-white",id:"timeType",type:"Select",dense:"",value:e.tempConfig.timeType,onOnSelect:e.onChange,options:e.optionsTimeType},null,8,["value","onOnSelect","options"]),withDirectives(createVNode(D,{id:"timeTimelineDate",type:"Date",dense:"",value:e.tempConfig.timeTimelineDate,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="timeline"]]),withDirectives(createVNode(D,{id:"timeReviewValue",type:"Number",dense:"",value:e.tempConfig.timeReviewValue,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="review"]]),withDirectives(createVNode(D,{id:"timeReviewUnit",type:"Select",dense:"",value:e.tempConfig.timeReviewUnit,options:e.optionsTimeReviewUnits,onOnSelect:e.onChange},null,8,["value","options","onOnSelect"]),[[vShow,e.tempConfig.timeType==="review"]]),createVNode(QSpace),withDirectives(createVNode(QBtn,{flat:"",label:e.$t("Apply"),onClick:e.onApply},null,8,["label","onClick"]),[[ClosePopup]])])]),_:1},8,["target","onHide"])):createCommentVNode("",!0)],2)),[[vShow,e.loaded]]):createCommentVNode("",!0)],32)}var HistoryGraph=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{HistoryGraph as default};
