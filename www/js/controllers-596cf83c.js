import{i as C,l as Z,a as K}from"./boot-d33196cc.js";import{N as M,ae as ee,u as te,af as Q,S as se,Q as ne}from"./vendor.quasar-78ba37d9.js";import{l as oe}from"./vendor.socket.io-client-fd03852a.js";import{E as q}from"./vendor.events-e8bb2ecf.js";import{_ as A}from"./vendor.rfdc-06a2e69e.js";import{c as x,g as G}from"./config-f4693115.js";import{a as ie,u as F,b as Y}from"./stores-22cbae97.js";import{f as re}from"./vendor.date-fns-448d10fa.js";import{r as ae,E as X,h as N,a as H}from"./helpers-7b53fe93.js";import{s as ce}from"./vendor.sha.js-0bffd5bc.js";import{a as le}from"./vendor.axios-23a4eccc.js";import{u as B,v as P}from"./vendor.uuid-b6f2345c.js";import{F as E}from"./functions-9f904a0e.js";import{G as ue}from"./configuration-f4a0a9e1.js";const z=window.localStorage;class g{static get getMaxStorage(){return 51e5-1}static setNamespace(e){return g._ns=e,g}static remove(e){delete g._cache[g._ns+e],z.removeItem(g._ns+e)}static get(e){let t=g._cache&&g._cache[g._ns+e];return t==null&&(t=JSON.parse(z.getItem(g._ns+e))),t!=null?t:null}static set(e,t,s=!0){if(e===void 0||t===void 0)return!1;if(typeof e=="object"&&(s=t!==void 0?t:s,Object.keys(e).forEach(n=>g.set(n,e[n],s))),g._cache=g._cache||{},g._cache[g._ns+e]=t,s)try{const n=JSON.stringify(t);z.setItem(g._ns+e,n)}catch{}return g}}class d extends q{static getInstance(){return d.instance||(d.instance=new d,d.instance.setMaxListeners(25)),d.instance}static destroy(){d.getInstance().removeAllListeners(),d.instance=null}static _message(e,t,s){if(s=Array.isArray(s)?s:[s],s.join("")!==""){const n=Date.now();let o=!1;s[0]&&s[0].toString().startsWith(`
`)&&(o=!0,s[0]=s[0].substr(1));const i=s.length>1&&typeof s[0]=="string"?s.shift():"";ie().push(A({ts:n,criticality:e,category:i,args:s}));try{const c=s.map(l=>typeof l=="object"?JSON.stringify(l):l).join(" | ");d.getInstance().emit("message",{from:x.get("ADAPTER_INSTANCE").slice(0,-1),ts:n,severity:e,message:c},s)}catch{}const a=s[s.length-1];if(a&&a.iobroker){s.pop();const c=[];s.forEach(u=>{u&&u.name&&u.name.toLowerCase().indexOf("error")>-1&&c.push(u.message)}),v.getConnection.send("log",[e,c],()=>{})}console[e==="dev"?"debug":e]((o?`
`:"")+re(n,"HH:mm:ss.SSS")+" | "+e.toUpperCase()+" |",i.toUpperCase()+" |",...s)}}static getLog(){return d.log}static dev(...e){g.get("params").debug==="true"&&x.get("IS_DEV")&&d._message("dev","grey",e)}static debug(...e){d._message("debug","grey",e)}static log(...e){d._message("info",null,e)}static info(...e){d._message("info","blue",e)}static warn(...e){d._message("warn","yellow",e)}static error(...e){d._message("error","red",e)}}class J{static get SERVER_URL(){return"https://www.zefau.net/jarvis/"}static token(){const e=ae(1e3,9999),t=Date.now();return{token:ce("sha256").update(t+"-"+e+"-"+x.get("UUID")).digest("hex"),random:e,ts:t}}static post(e,t){const s=J.token();return le.post(J.SERVER_URL+e+".php",{...t,...s}).then(n=>n.body||n.data)}}class y{static getLicence(){return y._licence}static isPro(){return F().pro}static verify(e){const t=e.signature.replace(/ /g,""),s={...e};delete s.signature,delete s.ioBrokerId;const n=[X.verify(s,t,x.get("PUBLIC_KEY")),X.verify(s+"-invalid",t,x.get("PUBLIC_KEY"))];return Promise.allSettled(n).then(o=>({verification:o[0].status==="fulfilled"&&o[0].value===!0&&o[1].status==="fulfilled"&&o[1].value===!1,licence:{...e,signature:t}}))}static warn(e){F().settings.hideProNotification!==!0&&y.notify(e,"mdi-alert","warning")}static notify(e,t,s){const n={message:e||"Pro-Feature not enabled due to invalid licence.",icon:t||"mdi-star-remove-outline",type:s||"negative"};M.create(n)}static getSystemId(e){return B(JSON.stringify(e),x.get("UUID"))}static validate(e,t,s){d.debug("Pro","Using "+t,s);const n=F(),o=n.settings.hideProNotification,i={message:"Pro-Features not enabled due to invalid licence.",icon:"mdi-star-remove-outline",type:"negative"};if(e){if(typeof e=="string")try{e=e.replace(/(?:\r\n|\r|\n)/g," ").replace(/\\ /g,"\\$& "),e=JSON.parse(e)}catch(r){return d.error("COULD NOT PARSE PRO LICENCE!",r),M.create(i),Promise.reject(new Error("COULD NOT PARSE PRO LICENCE!"))}}else return Promise.reject(new Error("No licence given"));return y.verify(e).then(({verification:r,licence:a})=>{if(a.expires=a.expires?parseInt(a.expires)*1e3:0,r===!0&&a.subscriber&&a.expires<Date.now()&&y.pollForToken(c=>y.setToken(c),null,a.subscriptionId,99),r===!0&&a.subscriber&&a.expires>Date.now()-24*60*60*1e3){const c=a.subscriber.name?a.subscriber.name.given_name+" "+a.subscriber.name.surname:"";d.log("Pro","Valid Pro User: "+c),o===!1&&M.create({message:(c?"Welcome "+c+"! ":"")+"You are Pro!",icon:"mdi-star-check",type:"positive"}),y._licence=a,n.set({pro:!0});const l=g.get("userId"),u=y.getSystemId(s);l&&J.post("user/details",{action:"setInstallation",userId:l,signature:a.signature,ioBrokerId:t,systemId:u,system:JSON.stringify(s)}).catch(S=>{d.error("Pro",S.message||S)})}else d.error("INVALID LICENCE!",r,a.expires>Date.now(),t,a),M.create(i);return y.isPro})}static setToken(e,t,s={}){return new Promise((n,o)=>{if(e)return n(e);t&&y.pollForToken(n,o,t)}).then(n=>{var a;const o=v.getConnection;return(((a=Y().instanceList)==null?void 0:a.val)||["jarvis.0"]).forEach(c=>{c.startsWith("jarvis.")&&o.setState(x.get("NODE_PRO").replace(x.get("ADAPTER_INSTANCE"),c+"."),JSON.stringify({...n,ioBrokerId:s}),!0).catch(l=>d.warn("Pro",l.message||l))}),n})}static pollForToken(e,t,s,n=0){return J.post("user/invoice",{action:"getTokenBySubscriptionId",subscriptionId:s}).then(o=>{if(o)e(o);else{if(n=n+1,n>5)return t&&t("too many attempts");setTimeout(()=>{y.pollForToken(e,t,s,n)},30*1e3)}}).catch(o=>{d.error("Pro",o.message||o),t&&t(o)})}}class h{static destroy(){h._devices=null,h._states={},h._history={}}static prepareState(e,t,s){const n=h.get(e);s.key=t,delete s.key,s.stateKey=t,s.revision=s.revision||P(),s.value=s.val,s.configFunctionDefaults={...E.Configurations._defaults&&E.Configurations._defaults._any||{},...E.Configurations._defaults&&E.Configurations._defaults[t]||{}},s.configDeviceDefaults={...E.Configurations[n.function.toLowerCase()]&&E.Configurations[n.function.toLowerCase()]._any||{},...E.Configurations[n.function.toLowerCase()]&&E.Configurations[n.function.toLowerCase()][t]||{}},s.configUser=A(n.states[t]),s.config={...s.configFunctionDefaults,...s.configDeviceDefaults};for(const o in n.states[t])s.config[o]=s.configUser[o]||s.config[o];if(s.config.value&&s.value!==void 0&&s.value!==null&&s.value!=="")try{const o=new Function("return "+s.config.value)();s.value=o(s.value,n.states[t],n.states,n)}catch(o){console.warn("Devices-875c87ea","Incorrect callback function ("+s.config.value+") supplied to "+n.name+" ("+t+")!",o),s.value=s.val}if(y.isPro()&&n.states[t]&&n.states[t].properties&&n.states[t].properties.value)try{const o=new Function("return "+n.states[t].properties.value)();s.value=o(s.value,n.states[t],n.states,n)}catch(o){console.warn("Devices-875c87eb","Incorrect callback function ("+n.states[t].properties.value+") supplied to "+n.name+" ("+t+")!",o),s.value=s.val}else!y.isPro()&&n.states[t]&&n.states[t].properties&&n.states[t].properties.value&&y.warn("Device ("+n.name+'): Callback for "value" only available in Pro.');try{for(const o in s.config){const i=s.config[o];s=m.resolveBinding(o,i,s,n),m.hasBinding(s[o])&&(s[o]=m.replaceBinding(s[o],{state:s,device:n}))}}catch(o){console.warn("Devices-jEk6S8dX","Error resolving bindings for device "+n.name+" ("+n.id+"): "+o.message)}!s.configUser.icon&&n.icon&&(s.icon=n.icon),s.icon||(s.icon=E.Icons[n.function]||E.Icons._defaults);try{s.value=s.value===void 0?"":C.global.t((typeof s.display=="string"?s.display:s.value).toString())}catch(o){console.warn("Devices-yDv926aP","Error translating name for device "+n.name+" ("+n.id+') using "'+((!s.config.value&&s.display?s.display:s.value)||"")+'": '+o.message)}return s}static init(e){h._devices=A(e),v.getConnection.refreshSubscribedStates()}static get(e){return h.getDevice(e)}static getDevice(e){if(e===void 0||!h._devices[e])return null;const t=h._devices[e];return t.function=t.function==="other"?"_defaults":t.function,t.options={suppressPopup:!1,...t.options||{}},t}static refreshDeviceState(e,t,s,n="cache"){const o=h.get(e);if(h._states){const{cb:i}=h._states[o.id+":"+t]||{};h.applyDeviceState(o,t,null,{val:null},n,i)}}static applyDeviceState(e,t,s,n,o,i){let{err:r,state:a}=n.state?n:{state:n};if(r||!a){r=r||"State "+t+" is null",i&&o!=="setState"&&i(r,e,t,null);return}else if(!e){r="No Device found for ID "+e.id,i&&o!=="setState"&&i(r,e,t,null);return}o!=="cache"&&m.setStateVal(a.id,a.val);try{if(h._states=h._states||{},!s||s!==a.id)({s:a}=h._states[e.id+":"+t]||{}),a=h.prepareState(e.id,t,A(a||{})),i&&i(null,e,t,a);else{a=A(a||{}),h._states[e.id+":"+t]={s:a,cb:i};const c=h.prepareState(e.id,t,a);i&&i(null,e,t,c)}}catch(c){console.warn("Devices-1ecd585d",c.message,c)}}static listen(e,t,s){if(d.dev("listen",e,t),e&&t){const n=h.get(e),o=n&&n.states&&n.states[t],i=o&&(o.state||o.action);if(i){const r=m.getBindings(h.prepareState(n.id,t,{...A(o),val:""})),c=v.getConnection.subscribeStates([...new Set([...r,i])],(u,S)=>{h.applyDeviceState(n,t,i,u,S,s)}),l=m.getStateVal(i);return l!==void 0&&h.applyDeviceState(n,t,i,{state:{val:l}},"cache",s),c}else s&&s(new Error("Neither state nor action defined for state key "+t+" in device "+e),n,t,o)}else console.warn("Devices-a9b3ff4f","Invalid details for listener",e,t);return[]}static unlisten(e){d.dev("Devices","unlisten",e),e&&e.length>0&&v.getConnection.unsubscribeStates(e)}static history(e,t,s,n){if(d.dev("history",e,t,s),e&&t){let o=h.get(e);const i=o&&o.states&&o.states[t],r=i&&i.state;if(i.stateKey=t,r){const a=N(r+":"+JSON.stringify(s));if(h._history=h._history||{},h._history[a])return n(null,h._history[a],i,o),a;s={ack:!0,ignoreNull:!0,aggregate:"none",...s,instance:s.instance||"history.0"};const c=({err:u,history:S,...f})=>{d.dev("history","callback",u,S,f),o=h.get(e);const b=h.prepareState(o.id,t,A(i||{}));if(u)return console.debug("Devices-b917b213",u),n(u,{history:null,subscriptionKey:a},b,o),u;if(f.noUpdate&&!S&&h._history[a]!==void 0)return n(u,h._history[a],b,o),null;S=S||[],h._history[a]={history:S,subscriptionKey:a,cb:n},n(null,{history:S,subscriptionKey:a},b,o)};return v.getConnection.subscribeHistory(a,r,s,c),a}else n&&n(new Error('History subscription invalid (no state given for state key "'+t+'" in device "'+e+'"'),{subscriptionKey},i,o)}else console.warn("Devices-a9b3ff4f","Invalid details for listener",e,t);return null}static unsubscribe(e,t,s,n){d.dev("unsubscribe",e,t,s,n);const o=h.get(t),i=o&&o.states&&o.states[s]&&o.states[s].state;e&&i&&v.getConnection.unsubscribe(n,e,i,({err:a})=>{a&&a.message&&console.warn("Devices-147cd06a","Unsubscribe failed",n,i,e,a.message)})}static set(e,t,s,n){const o=h.get(e),i=o&&o.states&&o.states[t]&&(o.states[t].action||o.states[t].state);if(i){const r=o.id+":"+t;let a=null;if(h._states[r]&&(!o.states[t].action||o.states[t].action===o.states[t].state)){let{s:l,cb:u}=h._states[r];a=l.val,u&&(l={...l,ts:Date.now(),lc:Date.now(),val:s},h._states[r].s=l,l=h.prepareState(o.id,t,l||{}),u(null,o,t,l))}v.getConnection.setState(i,s,n!==void 0?n:!1).catch(l=>{if(console.warn("Devices-954571f6","Could not set state",s,i,e,t,l.message,l),h._states[r]&&(!o.states[t].action||o.states[t].action===o.states[t].state)){let{s:u,cb:S}=h._states[r];u={...u,val:a},h._states[r].s=u,u=h.prepareState(o.id,t,u||{}),S(l,o,t,u)}})}else o&&!i?console.warn("Devices-a6ff8c8c","Device "+(o.name||e)+" has no state to set!"):o||console.warn("Devices-752f6dcd","No valid Device with ID "+e+" ("+t+") has no state to set!")}}class m{static getUsers(){const e=v.getConnection;return new Promise((t,s)=>{e.getObjectView("system","user",null,({err:n,objects:o})=>{if(n||!o)return s(n);t(o)})})}static getUserGroups(){const e=v.getConnection;return new Promise((t,s)=>{e.getObjectView("system","group",null,({err:n,objects:o})=>{if(n||!o)return s(n);t(o)})})}static get _OPERATORS(){return["<=",">=","!=","<>","<",">","="]}static getStateVal(e){var t;return(t=m._states)==null?void 0:t[e]}static setStateVal(e,t){m._states=m._states||{},m._states[e]=t}static getBindings(e,t){d.dev("getBindings",e);let s=[];for(const n in e.config){const o=e.config[n];if(!(!["icon","iconStyle","iconSelectedStyle","label","title","state","stateStyle","bodyStyle","bodySelectedStyle","display","unit","properties"].includes(n)||typeof o!="object"))for(const i in o){const r=o[i];if((typeof i!="string"||i.indexOf("{")===-1||i.indexOf("}")===-1)&&(typeof r!="string"||r.indexOf("{")===-1||r.indexOf("}")===-1))continue;const a=RegExp("{(.+?\\.+.+?)}","g"),c=(i.match(a)||[]).concat(typeof r=="string"&&r.match(a)||[]);if(y.isPro()&&c&&c.length!==0){const l=c.map(u=>u.trim().substr(1,u.trim().length-2).trim());s=s.concat(l),t&&l.length!==0&&v.getConnection.subscribeStates(l,({err:S,state:f})=>{if(d.dev("getBindings","subscribeStates",S,f),!S){const b={name:""};m.setStateVal(f.state||f.stateId,f.val),m.hasBinding(o)&&(e[n]=m.replaceBinding(o,{state:e,device:b})),e=m.resolveBinding(n,o,e,b),t(e)}})}else!y.isPro()&&c&&c.length!==0&&(console.warn("Bindings is only available to Pro!",e,c),m.warnBinding!==!0&&(m.warnBinding=!0,y.warn("Bindings is only available to Pro!")))}}return[...new Set([...s])]}static _removeOperators(e){return m._OPERATORS.forEach(t=>{e=e.replace(t,"")}),parseFloat(e)||e}static _getOperator(e){return m._OPERATORS.find(t=>e.indexOf(t)>-1)||""}static hasBinding(e){return e&&typeof e=="string"&&e.indexOf("{")!==-1&&e.indexOf("}")!==-1}static replaceBinding(e,{state:t,device:s}){d.dev("replaceBinding",e,t,s),e=e&&typeof e!="string"?JSON.stringify(e):e,(e.match(/{[^{}]+}/g)||[]).forEach(i=>{if(i=i.trim(),i.indexOf("{val}")!==-1)e=e.replace(/'?{val}'?/g,t.value==="true"||t.value==="false"||typeof t.val=="boolean"?t.val==="true"||t.val===!0:"|'"+t.val+"'|");else if(i.indexOf("{value}")!==-1)e=e.replace(/'?{value}'?/g,t.value==="true"||t.value==="false"||typeof t.val=="boolean"?t.val==="true"||t.val===!0:"{'"+t.value+"'|");else if(i.indexOf(".")!==-1){const r=m.getStateVal(i.substr(1,i.length-2));e=r!==void 0?e.replace(RegExp("'?"+i+"'?"),r==="true"||r==="false"||typeof r=="boolean"?r==="true"||r===!0:"|'"+r+"'|"):i}else{const r=i.substr(1,i.length-2);e=e.replace(RegExp("'?"+i+"'?"),r==="true"||r==="false"||typeof r=="boolean"?r==="true"||r===!0:r)}}),e=e.replace(/([^=<>!])=([^=<>!])/g,"$1==$2"),e=e.trim();const o=RegExp(".+?\\(.*?\\).*?","g");if(e.indexOf("{")===-1&&e.indexOf("}")===-1&&(o.test(e)||e.indexOf("<")!==-1||e.indexOf(">")!==-1||e.indexOf("!=")!==-1||e.indexOf("=")!==-1)){e=e.replace(/\'\|/g,"'").replace(/\|\'/g,"'");try{return new Function("return "+e)()}catch(i){const r=s.id+":"+t.stateKey;m._notified=m._notified||{},m._notified[r]||(m._notified[r]=!0,console.warn("ioBroker-a51989c6","Incorrect callback function ("+e+") supplied to "+s.name+" ("+t.stateKey+")!",o,o.test(e),e.indexOf("<")!==-1,e.indexOf(">")!==-1,e.indexOf("!=")!==-1,e.indexOf("=")!==-1,i),M.create({type:"warning",icon:"mdi-alert",message:"Incorrect callback function ("+e+") supplied to "+s.name+" ("+t.stateKey+")!",caption:i.message||i}))}}return e=e.replace(/\'\|/g,"").replace(/\|\'/g,""),e}static resolveBinding(e,t,s,n,o=null){if(t&&typeof t=="object"){let i=Object.keys(t);if(i=i.includes("_noSort")||i.join("").indexOf("{")!==-1?i:i.sort((r,a)=>(r=m._removeOperators(r),a=m._removeOperators(a),r===a?0:r>a?1:-1)),i.includes("_noSort")){const r=i.indexOf("_noSort");i.splice(r,1)}if(i.toString().indexOf("{")!==-1||i.toString().indexOf("<")!==-1||i.toString().indexOf(">")!==-1||i.toString().indexOf("!=")!==-1||i.toString().indexOf("=")!==-1){let r=!0;for(const a of i){const c=parseFloat(s.val)||s.val,l=m.hasBinding(a);if(a==="default")continue;if(a.indexOf("{")!==-1){if(m.replaceBinding(a,{state:s,device:n})===!0){s[e]=t[a],r=!1;break}continue}const u=m._getOperator(a),S=a.substr(0,a.indexOf(u));let f=u?parseFloat(l?m.getStateVal(S):S):c;f=Number.isNaN(f)||f===void 0?c:f;const b=a.substr(a.indexOf(u)+u.length);let p=u?parseFloat(l?m.getStateVal(b):b):a;if(p=Number.isNaN(p)||p===void 0?c:p,f=f==="true"||f==="false"?f==="true":f,p=p==="true"||p==="false"?p==="true":p,(u==="!="||u==="<>")&&f!=p){s[e]=t[a],r=!1;break}else if(u==="<="&&f<=p){s[e]=t[a],r=!1;break}else if(u==="<"&&f<p){s[e]=t[a],r=!1;break}else if(u===">="&&f>=p){s[e]=t[a],r=!1;break}else if(u===">"&&f>p){s[e]=t[a],r=!1;break}else if((u===""||u==="=")&&f==p){s[e]=t[a],r=!1;break}}r&&(s[e]=t.default!==void 0?t.default:o)}else{const r=!s.val||e==="properties"?s.val:Object.keys(t).find(c=>c.toString().toLowerCase()===s.val.toString().toLowerCase());let a=!1;if(["bodyStyle","stateStyle","iconStyle"].includes(e)&&t){const c=Object.values(t);a=c&&c[0]&&typeof c[0]=="object"}s[e]=r!==void 0&&t[r]!==void 0?t[r]:t.default!==void 0?t.default:t&&["bodyStyle","stateStyle","iconStyle"].includes(e)&&a===!1||t&&["properties"].includes(e)?t:void 0}}else e!=="value"&&t&&typeof t=="function"?s[e]=t(s.val,s.stateKey,n):e!=="value"&&t&&typeof t=="string"&&(s[e]=t);return s}static getObjects(){const e=v.getConnection;return new Promise((t,s)=>{e.getObjects().then(n=>{g.set("objectsUpdated",Date.now()),g.set("objects",n),g.set("objectList",Object.keys(n).sort((o,i)=>(o=o.toLowerCase(),i=i.toLowerCase(),o===i?0:o>i?1:-1)).sort((o,i)=>n[o].type==="state"&&n[i].type==="state"?0:n[o].type==="state"&&n[i].type!=="state"?1:-1)),g.set("stateList",Object.values(n).filter(o=>o.type==="state").map(o=>o._id)),t()}).catch(n=>s(n))})}static subscribeScriptStatuses(){const e=v.getConnection,t=Y();e.subscribeSpecial("ScriptStatuses",({scripts:s,scriptList:n})=>{t.set("scripts",{val:s,ts:Date.now()}),t.set("scriptList",{val:n,ts:Date.now()})})}static subscribeAdapterInstances(){const e=v.getConnection,t=Y();e.subscribeSpecial("AdapterInstances",s=>{const n=Object.keys(s).sort();n&&Array.isArray(n)&&(t.set("instances",{val:s,ts:Date.now()}),t.set("instanceList",{val:n,ts:Date.now()}))})}static importDevices(e=Object.keys(G)){const t=v.getConnection;console.debug("ioBroker-53de87a5","Start importing devices..");const s=[];return e=Array.isArray(e)?e:[e],e.forEach(n=>{s.push(new Promise((o,i)=>{try{const r=G[n];console.debug("ioBroker-569d31bd","Request devices from adapter "+n+"..",r),t.getObjectView("system",r.deviceObjectType||"device",{startkey:r.namespace+".0",endkey:r.namespace+".99"}).then(a=>{if(console.debug("ioBroker-8e7a802b","Retrieved results from adapter "+n+":",a),r.root){let c=Promise.resolve([]);r.deviceObjectType!=="device"&&(c=new Promise(l=>{t.getObjectView("system","device",{startkey:r.namespace+".0",endkey:r.namespace+".99"}).then(l)})),r.deviceObjectType!=="folder"&&(c=new Promise(l=>{t.getObjectView("system","folder",{startkey:r.namespace+".0",endkey:r.namespace+".99"}).then(l)})),c.then(l=>{const[,u]=m._convertStructure([{status:"fulfilled",value:{type:"objects",retrieved:[...a,...l||{}]}}]);r.root(u,r).then(S=>{console.debug("ioBroker-879bfd43","Parsed devices from "+n+":",S);const f=S.map(b=>({status:"fulfilled",value:{...b,attributes:{_created:Date.now(),imported:!0,manufacturer:{name:r.default,namespace:r.namespace}}}}));o(f)}).catch(()=>o([]))}).catch(l=>{console.warn("ioBroker-9b782f48",l.message)})}else m.parseDevices(a).then(c=>{console.debug("ioBroker-aea6eac0","Parsed devices from "+n+":",c),o(c)}).catch(c=>i(c))}).catch(a=>{const c=C.global.t("Could not load any adapter devices, channels or states.");console.warn("ioBroker-9595cbe3",c+"!","error",!0,a.stack),i(new Error(c))})}catch(r){const a=C.global.t("Adapter structure not defined for adapter %adapter").replace(/%adapter/g,n);console.warn("ioBroker-610766e7",a+"!","error",!0,r.stack),i(new Error(a))}}))}),new Promise(n=>{H(s).then(o=>{let i=[];o.forEach(r=>r.value&&(i=i.concat(r.value))),n(i)})})}static importEnums(e="functions",t=[]){const s=v.getConnection,n=[];return new Promise((o,i)=>{s.getObjectView("system","enum").then(r=>{r.forEach(a=>{if(a.id.indexOf("enum.functions.control_center")===-1&&a.id.indexOf("enum."+e)>-1&&a.value&&a.value.common&&a.value.common.members&&Array.isArray(a.value.common.members)&&a.value.common.members.length>0){const c=[];a.value.common.members.forEach(l=>{const u=l.substr(0,l.indexOf("."));t.indexOf(u)>-1&&c.push({id:l})}),n.push(m.parseDevices(c,{function:a.id.indexOf("enum.functions.")>-1?a.id.replace("enum.functions.",""):null}))}}),H(n).then(a=>{let c=[];a.forEach(l=>{c=c.concat(l.value)}),o(c)})}).catch(r=>{const a=C.global.t("Enums could not be retrieved");console.warn("ioBroker-76a5c25f",a+"!","error",!0,r.stack),i(new Error(a))})})}static _convertStructure(e){const t={};let s={};return e.forEach(n=>{n.status==="fulfilled"&&n.value&&(n.value.type==="devices"||n.value.type==="channels"||n.value.type==="folder"||n.value.type==="objects")?n.value.retrieved.forEach(o=>{t[o.id]=o.value}):n.status==="fulfilled"&&n.value&&n.value.type==="states"&&(s=n.value.retrieved)}),[s,t]}static parseDevices(e,t={}){const s=C.global.locale.value||C.global.locale||Z,n=v.getConnection,o=[];for(const i of e){const r=i.id,a=r.substr(0,r.indexOf(".")),c=G[a],l={id:B(r,"4eaf6392-6a70-4802-b343-5ff1a1673f39"),name:"unknown device (state "+r+")",function:t.function||"unknown",states:{},options:{},attributes:{_created:Date.now(),imported:!0,manufacturer:{name:c.default,namespace:a}}};c.devicePattern&&RegExp("^"+c.namespace+"\\.\\d\\."+c.devicePattern+"$").test(r)===!1||o.push(new Promise((u,S)=>{H([new Promise(f=>n.getObjectView("system","device",{startkey:r,endkey:r+".\u9999"}).then(b=>f({retrieved:b,type:"devices"}))),new Promise(f=>n.getObjectView("system","channel",{startkey:r,endkey:r+".\u9999"}).then(b=>f({retrieved:b,type:"channels"}))),new Promise(f=>n.getObjectView("system","folder",{startkey:r,endkey:r+".\u9999"}).then(b=>f({retrieved:b,type:"folder"}))),new Promise(f=>n.getObjectView("system","state",{startkey:r,endkey:r+".\u9999"}).then(b=>f({retrieved:b,type:"objects"}))),new Promise(f=>n.getStates(r+".*").then(b=>f({retrieved:b,type:"states"})))]).then(f=>{const[b,p]=m._convertStructure(f),T={root:r,list:Object.keys(b),states:b,objects:p};c.parse(T,t).then(k=>{k.name=k.name&&(k.name[s.substr(0,2)]||k.name),u({...l,...k,id:k.name?k.name.toLowerCase().replace(/ /g,"")+"_"+B(r,"4eaf6392-6a70-4802-b343-5ff1a1673f39").substr(0,5):B(r,"4eaf6392-6a70-4802-b343-5ff1a1673f39")})}).catch(k=>{const V=C.global.t(k.message).replace("%state",r)+"!";console.warn("ioBroker-aa2a87f4",c.default+": "+V,"warn",!0,k.stack),S({...l,attributes:{_created:Date.now(),...l.attributes,note:V}})})}).catch(f=>{const b=C.global.t("Could not retrieve state %state").replace("%state",r);console.warn("ioBroker-e677b45a",b+"!","error",!0,f.stack),S(new Error(b))})}))}return H(o)}static getDefaultModuleHeight(e,t=[]){let s=8,n=!0;if(e.module==="AdapterStatus")n=!1;else if(e.module==="Calendar")s=10,n=!1;else if(e.module==="DateTime")s=3;else if(e.module==="StateHTML"||e.module==="iFrame"||e.module==="Weather")s=9;else if(e.module==="StateListHorizontal"||e.module==="HomeKitTile")s=2;else if(e.module==="StateList"){const o=t.filter(i=>i.type==="divider").length;s=Math.ceil(((e.hideTitle!==!0?48:0)+o*1+(t.length-o)*48)/50),s=s||100}return{height:s,scaleToFitContents:n}}}class fe extends q{constructor(e){super(),this.socket=null,this.url=null,this.client=null,this.reloaded=0,this.otherSubscriptions={},this.stateSubscriptions={},this.historySubscriptions={},this.emittedMessages={},this.timeoutMessages={}}disconnect(){this.socket&&this.socket.disconnect(),this.pingInterval&&clearInterval(this.pingInterval)}connect(e,t={}){return this.url=e,this.socket=oe(e,{...t,timeout:3e4,path:"/jarvis-socket/"}),new Promise((s,n)=>{const o=setTimeout(()=>{this.disconnect(),n(new Error("Connection attempt is delayed"))},1e4);this.socket.on("connect",()=>{if(d.log("Socket","Connected to "+e+"."),clearTimeout(o),this.client){this.reloaded++,this.emittedMessages={},this.timeoutMessages={},d.info("Socket","Re-Subscribe to states",this.stateSubscriptions);for(const i in this.stateSubscriptions)Object.values(this.stateSubscriptions[i]).forEach(r=>r&&this.send("getState",i,r));d.info("Socket","Re-Subscribe to history",this.historySubscriptions);for(const i in this.historySubscriptions)this.historySubscriptions[i].forEach(r=>r&&this.send("getHistory",[i,r.stateId,r.options],r.cb));d.info("Socket","Re-Subscribe to adapter instances"),m.subscribeAdapterInstances()}else d.log("Socket","Listen for messages.."),this.listener(),this.pinger();window.Socket=this,s({socket:this,url:e})}),this.socket.on("error",i=>{d.warn("Socket","Connecting to {url} unsuccessful.".replace("{url}",e)),this.disconnect(),n(i)}),this.socket.on("disconnect",()=>{d.warn("Socket","Connection to {url} lost!".replace("{url}",e))})})}pinger(){this.pingInterval&&clearInterval(this.pingInterval),this.pingInterval=setInterval(()=>{this.socket.emit("ping")},10*1e3)}listener(){const e={};this.socket.on("message",t=>{try{const{messageId:s,action:n,index:o,length:i,chunk:r}=t;if(e[s]=e[s]||{},e[s][o]=r,Object.keys(e[s]).length===i){const a=JSON.parse(Object.values(e[s]).join(""));this.processIncomingMessage(s,a,n),delete e[s]}}catch(s){d.warn("Socket",s.message,s)}})}processIncomingMessage(e,t,s){if(t&&t.err==="_isNull"&&(t.err=null),s==="stateChange"){const n=Object.values(this.stateSubscriptions[e]||{});Array.isArray(n)&&n.length!==0&&n.forEach(o=>{o(t,s)})}else if(Array.isArray(this.otherSubscriptions[s]))this.otherSubscriptions[s].forEach(n=>{n(t,s)});else if(this.emittedMessages[e]&&this.emittedMessages[e].callback&&typeof this.emittedMessages[e].callback=="function")clearTimeout(this.timeoutMessages[e]),this.emittedMessages[e].callback(t,s),(!s||!s.toLowerCase().startsWith("subscribe"))&&delete this.emittedMessages[e];else if(this.timeoutMessages[e]!==void 0)d.warn("Socket","MESSAGE RECEIVED FOR TIMEOUT: ",e,s,t,this.emittedMessages),clearTimeout(this.timeoutMessages[e]);else if(e&&!this.emittedMessages[e]&&!this.timeoutMessages[e])if(e==="_version"){const n=g.get("versionComparison"),o="3.1.3-beta.0";(!n||n&&n<Date.now()-60*60*1e3)&&o&&t&&o!==t&&(d.error("Reload due to version mismatch: "+o+" (Website) vs. "+t+" (Server)"),M.create({icon:"mdi-alert",type:"negative",message:"Reload due to version mismatch: "+o+" (Website) vs. "+t+" (Server)"}),g.set("versionComparison",Date.now()),setTimeout(()=>{window.location.reload()},3e3)),this.emit(e,t)}else e==="_client"?(this.client=t,this.emit("clientId",this.client.id)):this.emit(e,t);else d.warn("Socket","UNKNOWN MESSAGE REVEIVED: ",e,t,this.emittedMessages)}send(e,t,s=null,n={}){n.timeout=n.timeout===void 0?60:n.timeout;const o=P(),i={messageId:o,command:e,params:!t||Array.isArray(t)?t:[t]};s&&(this.emittedMessages[o]={...i,callback:s},n.timeout&&(this.timeoutMessages[o]=setTimeout(()=>{d.warn("Socket","MESSAGE TIMEOUT: ",o,i);const c=new Error("MESSAGE TIMEOUT ("+o+"): "+JSON.stringify(i));this.processIncomingMessage(o,{error:c,err:c})},n.timeout*1e3)));const r=JSON.stringify(i).match(/.{1,100000}/g),a=r.length;r.forEach((c,l)=>{this.socket.emit("message",{messageId:o,index:l,length:a,chunk:c})})}getLogs(e,t){if(t)this.send("getLogs",e,t);else return new Promise((s,n)=>this.getLogs(e,({err:o,logs:i})=>o?n(o):s(i)))}setObject(e,t,s){if(s)this.send("setObject",[e,t],s);else return new Promise((n,o)=>this.setObject(e,t,({err:i})=>i?o(i):n()))}getObject(e,t){if(t)this.send("getObject",e,t);else return new Promise((s,n)=>this.getObject(e,({err:o,object:i})=>o?n(o):s(i)))}getObjects(e,t){if(t)this.send("getObjects",e,t);else return new Promise((s,n)=>this.getObjects(e,({err:o,objects:i})=>o?n(o):s(i)))}getObjectView(e,t,s,n){if(typeof s=="function"&&(n=s,s=void 0),n)this.send("getObjectView",[e,t,s],n);else return new Promise((o,i)=>this.getObjectView(e,t,s,({err:r,objects:a})=>r?i(r):o(a)))}getState(e,t){if(t)this.send("getState",e,t);else return new Promise((s,n)=>this.getState(e,({err:o,state:i})=>o?n(o):s(i)))}getStates(e,t){if(t)this.send("getStates",e,t);else return new Promise((s,n)=>this.getStates(e,({err:o,states:i})=>o?n(o):s(i)))}setAdapter(e,t,s){if(s)this.send("setAdapter",[e,t],s);else return new Promise((n,o)=>this.setAdapter(e,t,({err:i,state:r})=>i?o(i):n(r)))}setScript(e,t,s){if(s)this.send("setScript",[e,t],s);else return new Promise((n,o)=>this.setScript(e,t,({err:i,state:r})=>i?o(i):n(r)))}readFile(e,t){if(t)this.send("readFile",[e],t);else return new Promise((s,n)=>this.readFile(e,({err:o,data:i})=>o?n(o):s(i)))}setState(e,t,s,n){if(typeof s=="function"&&(n=s,s=!0),n)this.send("setState",[e,t,s],n);else return new Promise((o,i)=>this.setState(e,t,s,({err:r})=>r?i(r):o()))}getSpecial(e,t,s){if(s)this.send("getSpecial",[e,t],s);else return new Promise((n,o)=>this.getSpecial(e,t,({err:i,...r})=>i?o(i):n(...r)))}subscribeSpecial(e,t,s){typeof t=="function"&&(s=t,t={}),(!this.otherSubscriptions[e]||this.otherSubscriptions[e].indexOf(s)===-1)&&(this.otherSubscriptions[e]=this.otherSubscriptions[e]||[],this.otherSubscriptions[e].push(s)),this.send("subscribeSpecial",[e,t])}subscribeStates(e,t){return e=Array.isArray(e)?e:[e],e.map(s=>this.subscribeState(s,t))}subscribeState(e,t){if(!e)return t({err:new Error("No state given for subscription!")}),!1;e=e.replace(/{clientId}/g,this.clientId),this.stateSubscriptions[e]=this.stateSubscriptions[e]||{};const s=P();return this.stateSubscriptions[e][s]=t,this.send("subscribeState",e),e+":"+s}unsubscribeStates(e){this.stateSubscriptions&&e&&Array.isArray(e)&&e.forEach(t=>{const[s,n]=t.split(":");this.stateSubscriptions[s]&&this.stateSubscriptions[s][n]&&delete this.stateSubscriptions[s][n]})}refreshSubscribedStates(e=null){for(const t in this.stateSubscriptions)t.startsWith("jarvis.")||Object.values(this.stateSubscriptions[t]).forEach(s=>{this.send("getState",t,s)})}subscribeHistory(e,t,s,n){this.historySubscriptions[e]=this.historySubscriptions[e]||[],this.historySubscriptions[e].push({cb:n,subscriptionKey:e,stateId:t,options:s}),this.historySubscriptions[e].length===1?this.send("subscribeHistory",[e,t,s],n):this.send("getHistory",[e,t,s],n)}unsubscribe(e,t,s,n){this.send("unsubscribe",[e,t,s],n),this.historySubscriptions[t]&&delete this.historySubscriptions[t]}reset(){this.stateSubscriptions={},this.historySubscriptions={}}}class v{static connect(e,t){return new Promise((s,n)=>{if(e=e||v._url,v._connection&&v._connection.socket&&v._connection.socket.connected===!0){d.log("Connection","Connection still established.",v._connection.url);const i={socket:v._connection,url:v._url};return t&&t(i),s(i)}new fe().connect(e).then(i=>{v._url=i.url,v._connection=i.socket,t&&t(i),s(i)}).catch(i=>n(i))})}static discover(e=null,t=0){const s=parseInt(g.get("instance")||0),n=g.get("params")||{};return e=e||[(window.location.protocol==="https:"||n.socketSecure==="true"?"https://":"http://")+(n.socketHost||window.location.hostname)+":"+(n.socketPort?n.socketPort:8400+s),"https://"+(n.socketHost||window.location.hostname)+":"+(8400+s),"http://"+(n.socketHost||window.location.hostname)+":"+(8400+s),"https://"+(n.socketHost||window.location.hostname)+":443","http://"+(n.socketHost||window.location.hostname)+":80"],n.socketUrl&&e.unshift(n.socketUrl),e=[...new Set(e)],d.log("Connection","Connecting to "+e[t]+" (#"+(t+1)+")..."),v.connect(e[t]).then(o=>(g.set("params",{...g.get("params")||{},socketUrl:o.url}),o)).catch(o=>(d.error("Connection","Failed connecting to "+e[t]+" (#"+(t+1)+")!"),t++,e[t]?v.discover(e,t):Promise.reject(o)))}static get getConnection(){return v._connection||null}}class j{static _detectDuplicate(e,t,s,n){const o=Array.isArray(n),i=s.id||s.i;if((o||!o&&e===i)&&t.indexOf(i)===-1)t.push(i);else{console.warn("Found duplicate entry on ID "+i),delete n[e];const r=P().substr(0,5),a=i+"_rnd-"+r;n[o?e:a]={...s,[s.id?"id":"i"]:a}}return t}static convertStyles(e){return console.debug("Received an Update for Styles."),e}static convertScripts(e){console.debug("Received an Update for Scripts.");const t=F();return t.scripts&&N(t.scripts)!==N(e.val)&&(console.warn("Received an Update for Scripts, which requires a reload of the page!"),window.location.replace(window.location.href.replace(/[&?]reload=true/gi,"")),window.location.reload()),e}static convertWidgets(e){console.debug("Received an Update for Widgets.");let t=e.val&&JSON.parse(e.val)||null;if(t&&t.version===3){const s=N(t.widgets);if(t.signature!==s){console.log("Signature changed for Widgets, thus check for duplicate IDs...");let n=[];for(const r in t.widgets){const a=t.widgets[r];n=j._detectDuplicate(r,n,a,t.widgets)}const o=v.getConnection,i=g.get("instance")||0;o.setState("jarvis."+i+".widgets",JSON.stringify({version:3,signature:N(t.widgets),widgets:t.widgets}),!0).catch(r=>console.error("App",r.message||r))}t=t.widgets||{}}else if(t){console.info("Conversion","Converting WIDGETS to v3 structure...",JSON.parse(e.val));const s=v.getConnection,n=g.get("instance")||0;console.log("Conversion","Converted WIDGETS",t),s.setState("jarvis."+n+".widgets",JSON.stringify({version:3,widgets:t}),!0).catch(o=>console.error("App",o.message||o))}return{...e,val:JSON.stringify(t)}}static useSettings(e){const t=v.getConnection;let s={};ue.forEach(o=>{o.settings.forEach(i=>{s[i.id]=i.value})});const n={...s,...e};for(const o in n){const i=n[o];if(o.startsWith("brand")){const r=o.replace("brand","").toLowerCase();ee(r,i);const a=document.getElementById("theme-color");a&&a.setAttribute("content",te(Q.isActive?"dark":"primary"))}if(o==="reload"&&i===!0&&t.reloaded===0&&t.on("_timestamp",r=>{const a=new Date(r);a.getHours()===3&&a.getMinutes()===0&&window.location.reload()}),o.startsWith("breakpoint-")){const r=o.substr(-2);se.setSizes({[r]:parseInt(n[o])})}if(o==="themeDarkMode"&&Q.set(i),o==="pageTitle"&&(document.title=i||document.title),o==="language"){const r=i||Z;C.global.locale.value=r,ne.lang.set(K[r.substr(0,2)])}if(o==="pageFavicon"&&i&&typeof i=="string"&&i.trim().substr(0,5)==="data:"){const r=i.substr(0,i.indexOf(";")).replace("data:image/",""),a=document.getElementsByClassName("favicon");for(const c of a)c.href=i.trim(),c.type="image/"+r.trim()}}return n}static convertSettings(e){console.debug("Received an Update for Settings.");let t={};try{t=JSON.parse(e.val)||{},t=j.useSettings(t)}catch(n){console.debug("Converter",n.message,n),t={}}const s=F();return{...e||{},val:JSON.stringify({...s.settings||{},...t||{}})}}static convertLayout(e){const t=e.val&&JSON.parse(e.val)||null;console.debug("Received an Update for Layout.");let s=[];const n={};if(t&&t.version===3){const o=N(t.layout);if(t.signature!==o){console.log("Signature changed for Layout, thus check for duplicate IDs...");let i=[],r=[],a=[];t.layout.forEach((u,S)=>{i=j._detectDuplicate(S,i,u,t.layout),u.tabs=u.tabs||[],u.tabs.forEach((f,b)=>{r=j._detectDuplicate(b,r,f,u.tabs),f.widgetsDesktop=f.widgetsDesktop||[],f.widgetsDesktop.forEach((p,T)=>{a=j._detectDuplicate(T,a,p,f.widgetsDesktop)}),f.widgetsSmartphone=f.widgetsSmartphone||[],f.widgetsSmartphone.forEach((p,T)=>{a=j._detectDuplicate(T,a,p,f.widgetsDesktop)})})});const c=v.getConnection,l=g.get("instance")||0;c.setState("jarvis."+l+".layout",JSON.stringify({version:3,signature:N(t.layout),layout:t.layout}),!0).catch(u=>console.error("App",u.message||u))}s=t.layout||[]}else if(t&&Array.isArray(t)){console.info("Conversion","Converting LAYOUT to v3 structure...",JSON.parse(e.val)),t.forEach((r,a)=>{s[a]={id:P(),title:r.title||C.global.t("Main Site"),type:"page",icon:"mdi-file",iconColor:"",color:"",backgroundColor:"",hideLabels:r.hideLabels!==void 0?r.hideLabels:!1,tabs:[]},r.tabs=r.tabs||[],r.tabs.forEach((c,l)=>{s[a].tabs[l]={id:c.id||P(),icon:c.icon||"mdi-tab",title:c.title,iconColor:"",color:"",backgroundColor:"",widgetConfig:{},widgetsDesktop:[],widgetsTablet:[],widgetsSmartphone:[],widgetEdges:c.widgetsEdges!==void 0?c.widgetsEdges:!1},c.columns=c.columns||[];const u=Math.floor(12/c.columns.length);let S=0;c.columns=c.columns||[],c.columns.forEach((f,b)=>{f=f||[],S=0,f.forEach((p,T)=>{if(p){const k=p.devices?p.devices.map(w=>{w.id=P();const D={};for(const O in w)if(O.endsWith("Config")){D[O]={};for(const $ in w[O]){let[R,I]=$.split("-"),U=w[O][$];D[O][R]=D[O][R]||{},O==="ButtonActionConfig"&&I==="label"&&(I="labelTurnOn",D[O][R].labelTurnOff=U),(O==="IconButtonActionConfig"||O==="ButtonActionConfig")&&I==="buttonSize"?U=U===!0?"sm":"md":(O==="IconButtonActionConfig"||O==="ButtonActionConfig")&&I==="icon"&&(I="iconTurnOn",D[O][R].iconTurnOff=U),D[O][R][I]=U}}return w={...w,...D},w.type==="group"&&(w.groupElement=w.actionElement,delete w.actionElement,delete w.bodyStateKey,delete w.bodyElement),w.type==="device"&&w.bodyElement!==null&&(w.bodyStateKey=w.bodyStateKey||w.primaryStateKey,w.bodyStateKey&&(w.bodyElement=w.bodyElement||"LastChangeBody",w.bodyElement=w.bodyElement==="LightTemperatureBody"?"LevelBody":w.bodyElement)),w}):[];p.module=p.module==="Chart"?"HistoryGraph":p.module,p.module=p.module==="CustomHTML"?"StateHTML":p.module,p.module==="StateListHorizontal"&&(p.module="StateList",p.moduleConfig={...p.moduleConfig||{},horizontal:!0,stacked:!0});const{height:V,scaleToFitContents:_}=m.getDefaultModuleHeight(p,k),W=P();p.hideTitle=p.fullscreen!==void 0?p.fullscreen:!p.title,n[W]={id:W,config:p.moduleConfig||{},icon:p.icon||"mdi:home",title:p.title||"",module:p.module,items:k||[],hideTitle:p.hideTitle,hideSeparator:!0},s[a].tabs[l].widgetsDesktop.push({x:b*u,y:S,w:u,h:V,i:P(),items:[W],scaleToFitContents:_,alignmentVertical:"top",alignmentHorizontal:"center"}),S+=V}})})})});const o=v.getConnection,i=g.get("instance")||0;console.log("Conversion","Converted LAYOUT",s),o.setState("jarvis."+i+".layout",JSON.stringify({version:3,layout:s}),!0).catch(r=>console.error("App",r.message||r)),console.log("Conversion","Converted WIDGETS",n),o.setState("jarvis."+i+".widgets",JSON.stringify({version:3,widgets:n}),!0).catch(r=>console.error("App",r.message||r))}return{...e,val:JSON.stringify(s)}}static convertDevices(e){console.debug("Received an Update for Devices.");const t=e.val&&JSON.parse(e.val)||null;let s={};if(t.version===3){const n=N(t.devices);if(t.signature!==n){console.log("Signature changed for Devices, thus check for duplicate IDs...");let o=[];for(const a in t.devices){const c=t.devices[a];o=j._detectDuplicate(a,o,c,t.devices)}const i=v.getConnection,r=g.get("instance")||0;i.setState("jarvis."+r+".devices",JSON.stringify({version:3,signature:N(t.devices),devices:t.devices}),!0).catch(a=>console.error("App",a.message||a))}s=t.devices}else if(t!==null){console.info("Conversion","Converting DEVICES to v3 structure...",t),Object.keys(t).forEach(i=>{const r=t[i],a={};for(const c in r.states){const l=r.states[c];(l.label||l.state||l.action)&&(a[c]={showState:(l.state&&l.state.node||typeof l.state=="string")&&(l.actionElement===void 0||l.actionElement===null||l.actionElement==="State"),...l,state:l.state&&l.state.node!==void 0?l.state.node:l.state||"",action:l.action&&l.action.node!==void 0?l.action.node:l.action||""},a[c].bodyElement!==null&&(a[c].bodyElement=a[c].bodyElement==="LightTemperatureBody"?"LevelBody":a[c].bodyElement))}r.suppressPopup!==void 0&&(r.options.suppressPopup=r.suppressPopup,delete r.suppressPopup),delete r.hash,r.states=a,s[i]=r});const n=v.getConnection,o=g.get("instance")||0;console.log("Conversion","Converted DEVICES",s),n.setState("jarvis."+o+".devices",JSON.stringify({version:3,devices:s}),!0).catch(i=>console.warn("Conversion",i.message||i))}return h.init(s),{...e,val:JSON.stringify(s)}}}class L{static watch(e){return window.addEventListener("hashchange",()=>{e&&e(window.location.href)},!1),L}static setPath(e){const{tabId:t}=e;return window.location.href=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+t,L}static extract(e){return L.parse(e.substr(e.lastIndexOf("/")+1)),L}static parse(e=""){let t=null;if(e.indexOf("instance=")>-1){const[s,n]=e.match(/[#|?|&]?instance=(\d)/);t=e.replace(s,""),window.location.href=window.location.href.substr(0,window.location.href.indexOf(":"+window.location.port)+(":"+window.location.port).length)+("/#/"+n+"/"+t),window.location.reload()}if(e=e.replace("?","&"),e.indexOf("=")>-1){t={};let[s,n]=[null,null];e.split("&").forEach(o=>{[s,n]=o.split("="),s&&n&&(t[s]=n)}),g.set("params",t),t.keepParams!=="true"&&g.get("params")!==void 0&&g.get("params")!==null&&(window.location.href=window.location.href.replace(e,""))}return L}}export{v as C,h as D,J as H,d as L,y as P,L as U,g as a,j as b,m as i};
