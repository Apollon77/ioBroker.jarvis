import{a as q,b as W,c as Z,d as F,e as I,f as E}from"./vendor.quasar-78ba37d9.js";import{d as z,c as X,w as x,r as V,o as b,a as K,b as k,v as j,e as B,f as T,g as _,h as u,i as m,n as ee,j as D,t as y,F as te,k as se}from"./vendor.vue-1bbf3cb4.js";import{s as R,i as oe}from"./vendor.sentry-dd682f81.js";import{a as $}from"./vendor.axios-23a4eccc.js";import{L as M,D as J,a as P,U as ie,C as Y,b as L,P as O,i as U}from"./controllers-596cf83c.js";import{u as H,a as ae,b as ne}from"./stores-22cbae97.js";import{L as re,u as ce}from"./pages-a165c1cc.js";import{u as le,a as de}from"./composables-a7e68882.js";import{F as ue}from"./functions-9f904a0e.js";import{M as me}from"./modules-9c8c454f.js";import{c as p}from"./config-f4693115.js";import{_ as pe,f as he,E as N}from"./helpers-7b53fe93.js";const fe=z({name:"App",components:{Login:re},data(){return this.homePageReturnTimer=null,{loaded:[],connected:!1,error:!1,showLog:!1,verification:!0,login:!1}},methods:{attachHomePageReturnTimerReset(){M.dev("DEBUG","App","attachHomePageReturnTimerReset()"),document.onclick=this.setHomePageReturnTimer,document.onkeydown=this.setHomePageReturnTimer},setHomePageReturnTimer(){const e=H(),c=e.settings&&parseInt(e.settings.pageHomeReturn)||0;e.settings&&e.settings.pageHome&&c>0&&(M.dev("DEBUG","App","setHomePageReturnTimer()"),clearTimeout(this.homePageReturnTimer),this.homePageReturnTimer=setTimeout(()=>{this.$route.name==="home"&&this.$router.push({name:"home",params:{...this.$route.params,tabId:e.settings.pageHome}}).catch(()=>{})},c*1e3))},setParamsFromUrl(){var g,C;const e=H(),c=e.layout,l=this.$route.params.tabId||e.settings&&e.settings.pageHome||((C=(g=c[0])==null?void 0:g.tabs[0])==null?void 0:C.id);if(window.location.href.indexOf("reload=true")!==-1)console.warn("Reload requested!"),window.location.replace(window.location.href.replace(/[&?]reload=true/gi,"")),window.location.reload();else if(this.$route.path.indexOf("/configuration")===-1&&this.$route.path.indexOf("/account")===-1&&l&&c.length>0){const h=c.find(v=>Array.isArray(v.tabs)&&v.tabs.some(s=>s.id===l));if(h){l!==this.$route.params.tabId&&this.$router.replace({params:{tabId:l}}).catch(s=>console.warn("App-22ea9d4fa3",s.message,s));const v=Y.getConnection;v.setState(p.get("ADAPTER_INSTANCE")+"clients."+v.client.ns+".setTabId",l,!0).catch(s=>console.warn("App-5b293cf4",s.message,s)),e.set({selectedPageId:h.id,selectedTabId:l})}}},load(e){const c=e.key||e;return this.loaded.includes(c)===!1&&this.loaded.push(c),c}},computed:{drawerMiniMode(){return H().drawerMiniMode},logs(){return ae().byTime},settings(){return H().settings},allLoaded(){return this.loaded.includes("modules")&&this.loaded.includes("functions")&&this.loaded.includes("layout")&&this.loaded.includes("widgets")&&this.loaded.includes("devices")&&this.loaded.includes("settings")&&this.loaded.includes("scripts")&&this.loaded.includes("styles")&&this.loaded.includes("pro")}},watch:{"$route.params":function(){this.setParamsFromUrl()}},beforeCreate(){window.addEventListener("keyup",e=>{const{instance:c}=this.$route.params;e.keyCode===112?window.open("https://github.com/Zefau/ioBroker.jarvis/wiki","_blank"):e.keyCode===113?this.$router.push({name:"Configuration",params:{instance:c}}).catch(()=>{}):e.ctrlKey===!0&&e.keyCode===119?this.$router.push({name:"StylesPage",params:{instance:c}}).catch(()=>{}):e.ctrlKey===!0&&e.keyCode===120?this.$router.push({name:"SettingsPage",params:{instance:c}}).catch(()=>{}):e.ctrlKey!==!0&&e.keyCode===119?this.$router.push({name:"DevicesPage",params:{instance:c}}).catch(()=>{}):e.ctrlKey!==!0&&e.keyCode===120&&this.$router.push({name:"LayoutPage",params:{instance:c}}).catch(()=>{})})},created(){this.format=he,this.version="3.1.3-beta.0",document.body.style.setProperty("--jarvis-version",'"v'+this.version+'"'),console.log("App","Welcome to jarvis v"+this.version);const e=Date.now(),c=X({});c.config.errorHandler=(h,v,s)=>{console.error("Global",h.message,h)},window.refreshDeviceState=J.refreshDeviceState,ue.load().then(()=>this.load("functions")),me.load().then(()=>this.load("modules"));const l=H(),g=ne(),C=ce();setTimeout(()=>{this.error=this.allLoaded?!1:"Could not connect within 60 seconds"},60*1e3),this.$router.isReady().then(()=>{const{instance:h,params:v}=this.$route.params||{};P.setNamespace("jarvis."+(h||0)+".").set("instance",h),ie.parse(v),console.log("App","using instance "+(h||0)+"."),console.debug("App","Time - Router Ready: "+(Date.now()-e).toFixed(2)+"ms"),Y.discover().then(({socket:s})=>{console.debug("App","Time - Socket connected: "+(Date.now()-e).toFixed(2)+"ms"),this.error=!1,this.connected=!0;const o=[];return o.push(l.subscribe({key:"settings",stateId:p.get("NODE_SETTINGS"),json:!0,cb:L.convertSettings}).then(t=>this.load(t))),o.push(new Promise(t=>{s.getObject("system.meta.uuid",({err:r,object:n})=>{!r&&n&&n.native&&(g.join("meta",n.native),R("ioBrokerId",n.native.uuid)),t()})})),o.push(new Promise(t=>{s.send("getSystemInformation",[],r=>{g.join("meta",{system:r}),t()})})),new Promise(t=>{Promise.allSettled(o).then(r=>{s.getState(p.get("NODE_PRO")).then(n=>n&&n.val?O.validate(n.val,g.meta.uuid,g.meta.system):!1).then(n=>{const i=O.getLicence();return i?(R("pro.invoiceId",i.invoiceId),R("pro.subscriptionId",i.subscriptionId),R("pro.name",i.subscriber.name.given_name+" "+i.subscriber.name.surname),R("pro.email",i.subscriber.email_address),!0):!1}).catch(n=>{console.error("App-lUZ53KTivl",n.message,n)}).finally(()=>{this.load("pro"),t(s)})})})}).then(s=>(console.debug("App","Time - Got Pro, Settings and ioBroker Meta: "+(Date.now()-e).toFixed(2)+"ms"),U.getUserGroups().then(o=>g.set("groups",o)).catch(o=>console.error("App-BacnhGe3wn",o.message,o)),U.getUsers().then(o=>g.set("users",o)).catch(o=>console.error("App-AmgArge1wn",o.message,o)),s)).then(s=>{console.debug("App","Time - Got Users and Groups: "+(Date.now()-e).toFixed(2)+"ms");const o=[];return o.push(l.subscribe({key:"devices",stateId:p.get("NODE_DEVICES"),json:!0,cb:L.convertDevices}).then(t=>this.load(t)).catch(t=>console.error("App-PQfG1vrOa7",t.message,t))),Promise.allSettled(o).then(()=>s)}).then(s=>{console.debug("App","Time - Got Devices: "+(Date.now()-e).toFixed(2)+"ms");const o=[];return o.push(l.subscribe({key:"widgets",stateId:p.get("NODE_WIDGETS"),json:!0,cb:L.convertWidgets}).then(t=>{Object.values(l.widgets).forEach(r=>{(r.items||[]).forEach(i=>{if(i.type==="device"&&i.deviceId){const w=[i.primaryStateKey].concat(i.secondaryStatesKeys||[]);for(const a in w)a&&J.listen(i.deviceId,a)}})}),this.load(t)}).catch(t=>console.error("App-GAcA7qDpf5",t.message,t))),o.push(l.subscribe({key:"layout",stateId:p.get("NODE_LAYOUT"),json:!0,cb:L.convertLayout}).then(t=>{const r=this.load(t);return this.setParamsFromUrl(),this.setHomePageReturnTimer(),this.attachHomePageReturnTimerReset(),r}).catch(t=>console.error("App-Ro6cAsoL86",t.message,t))),o.push(l.subscribe({key:"styles",stateId:p.get("NODE_STYLES"),cb:L.convertStyles}).then(t=>this.load(t)).catch(t=>console.error("App-McGn2K9ZAg",t.message,t))),o.push(l.subscribe({key:"scripts",stateId:p.get("NODE_SCRIPTS"),cb:L.convertScripts}).then(t=>new Promise(r=>{O.isPro()?x(()=>l.scripts,()=>{try{M.dev("DEBUG","Jarvis","watchEffect","scripts"),le("script",l.scripts,{tag:"script"}).then(n=>{de("script",n,{id:"scripts"}),r(t)})}catch(n){console.warn("Jarvis-B7cq4T4m","Error injecting custom scripts: "+n.message),console.debug("Jarvis-B7cq4T4m",l.scripts),r(t)}},{immediate:!0}):r(t)})).then(t=>this.load(t)).catch(t=>console.error("App-cXn2MZAgK7",t.message,t))),Promise.allSettled(o).then(()=>s)}).then(s=>{console.debug("App","Time - Got Devices, Layout and Widgets: "+(Date.now()-e).toFixed(2)+"ms");const o=[];return s.on("_setTabId",t=>{t&&l.selectedTabId!==t&&this.$router.push({params:{...this.$route.params,tabId:t}}).catch(()=>{})}),o.push(new Promise(t=>{s.getObject("system.config",({err:r,object:n})=>{!r&&n&&n.common&&g.join("meta",{...n.common,...n.native}),t()})})),o.push(C.subscribe().catch(t=>console.warn("Notifications",t.message,t))),o.push(U.getObjects().catch(t=>console.error("App-AmgnhGejwn",t.message,t))),U.subscribeAdapterInstances(),U.subscribeScriptStatuses(),o.push(new Promise(t=>{s.send("getConfig","",({config:r})=>{P.set("adapterConfig",r),r&&r.sendUsageData&&window.location.href.indexOf("localhost")===-1&&(console.log("App","Sentry is turned on. You may deactivate it in the adapter settings."),oe({app:c,dsn:"https://8f641a7335b04713b802646ce0c31799@o326914.ingest.sentry.io/1835985",trackComponents:!0,release:"jarvis@"+this.version,environment:p.get("IS_DEV")?"development":"production",tracesSampleRate:.4})),t()})})),Promise.allSettled(o).then(()=>s)}).then(s=>{console.debug("App","Time - Got Config, Adapter, Scripts: "+(Date.now()-e).toFixed(2)+"ms");const o=P.get("verification"),t=p.get("IS_DEV"),r=window.location.href.indexOf("/jarvis/"),n=t?"https://192.168.178.21:8082/jarvis":r!==-1?window.location.href.substr(0,r+7):window.location.href.substr(0,window.location.href.indexOf("/",window.location.href.lastIndexOf(":")));!t&&(!o||o<Date.now()-24*60*60*1e3)&&$.get(n+"/js/app.hash.json").then(i=>{if(i.status!==200||!i.data)throw new Error("Invalid response received when requesting hashes");const{["app.hash.json"]:w,...a}=i.data;if(typeof i.data!="object"||!i.data["../../jarvis.js"]||!w||!a)throw new Error("Invalid or corrupt hash file");const f=btoa(encodeURIComponent(JSON.stringify(a))).substr(0,1e5);return N.verify(f,w,p.get("PUBLIC_KEY")).then(A=>{if(!A)throw new Error("Corrupt hash file");return a})}).then(i=>{const w=[N.verify("invalid","invalid",p.get("PUBLIC_KEY"))];for(const a in i){const f=i[a];w.push(new Promise((A,S)=>{a.indexOf("/")===-1?$.get(n+"/js/"+a).then(d=>{if(d.status!==200||!d.data)throw new Error("Invalid response received when requesting hashes");const G=d.data,Q=btoa(encodeURIComponent((a.endsWith(".json")?JSON.stringify(JSON.parse(G)):G).trim())).substr(0,1e5);return N.verify(Q,f,p.get("PUBLIC_KEY"))}).then(d=>{A({file:a,verified:d})}).catch(d=>{if(d&&d.response)return console.warn("App","Verification",d.response.statusText),S({file:a,name:d.response.statusText,message:d.response.data});console.warn("App","Verification: Unknown error retrieving URL "+a,d),S({file:a,message:"Unknown error",res:d})}):s.readFile("{dirname}/"+a.substr(a.indexOf("/")+1)).then(d=>{const G=btoa(encodeURIComponent((a.endsWith(".json")?JSON.stringify(JSON.parse(d)):d).trim())).substr(0,1e5);return N.verify(G,f,p.get("PUBLIC_KEY"))}).then(d=>{A({file:a,verified:d})}).catch(d=>{console.warn("App","Verification: Unknown error reading file "+a,d),S({file:a,...d})})}))}return Promise.allSettled(w).then(a=>{console.log("Verification",w);const f=a.shift(),A=a.some(S=>S.status==="rejected"||!S.value||S.value.verified!==!0);if(this.verification=f.status==="fulfilled"&&f.value===!1&&!A,this.verification)P.set("verification",Date.now());else throw l.set({pro:!1}),new Error("Installation inconsistent")})}).catch(i=>{console.error("App-9e37f7a363",i.message,i),this.verification=!1,this.error=i.message}),O.isPro()&&$.get("https://raw.githubusercontent.com/Zefau/ioBroker.jarvis/master/www/js/app.licences.json").catch(()=>$.get(n+"/js/app.licences.json")).then(i=>{const w=i.data.signature,a=i.data.licences,f=O.getLicence();if(!f||a[f.invoiceId]&&a[f.invoiceId].licence===f.signature)throw l.set({pro:!1}),new Error("Verification of Licence failed (Licence blocked)");const A=btoa(typeof a=="string"?a:JSON.stringify(a));return N.verify(A,w,p.get("PUBLIC_KEY"))}).then(i=>{if(!i)throw l.set({pro:!1}),new Error("Verification of Licence failed (Licence blocked)")}).catch(i=>{console.error("App-088dd73e5c",i.message,i),this.verification=!1,this.error=i.message}),console.debug("App","Time - Verified installation: "+(Date.now()-e).toFixed(2)+"ms")}).catch(s=>{console.warn("App-hGejAmgnwn",s.message,s),this.error=s.message,this.connected=!1}),$.get("https://raw.githubusercontent.com/Templarian/MaterialDesign/master/meta.json").then(s=>{if(P.set("icons.mdi",[]),P.set("icons.mdi.alias",{}),s&&s.data){const o=[],t={};s.data.forEach(r=>{o.push(r.name),r.aliases.forEach(n=>{t[n]=r.name})}),P.set("icons.mdi",o),P.set("icons.mdi.alias",t)}}).catch(s=>{console.log("App-b9518e0326",s.message,s)})}).catch(h=>{console.log("App-380f6fdb74",h.message,h)})}}),ge={class:"rows"},ve={class:"col-6"},we=B("div",{class:"col-6"},null,-1),be={key:1},ye=B("div",{id:"iframes"},null,-1);function Ae(e,c,l,g,C,h){const v=V("icon"),s=V("Login"),o=V("router-view");return b(),K("div",{style:{"min-height":"100%"},class:ee({"bg-red":!e.verification||e.error!==!1,"text-white":!e.verification||e.error!==!1})},[k(B("div",null,[e.verification===!0&&e.error===!1?(b(),T(Z,{key:0,indeterminate:""})):_("",!0),B("div",ge,[B("div",ve,[u(q,null,{default:m(()=>[k(u(F,null,{default:m(()=>[u(I,{avatar:""}),u(I,null,{default:m(()=>[u(E,null,{default:m(()=>[D(y(e.$t("Error"))+": "+y(e.error||"Verification failed"),1)]),_:1})]),_:1})]),_:1},512),[[j,e.error||!e.verification]]),k(u(F,null,{default:m(()=>[u(I,{avatar:""}),u(I,null,{default:m(()=>[u(E,null,{default:m(()=>[D(y(e.connected?e.$t("Connected")+(e.version?" (v"+e.version+")":"")+". "+e.$t("Loading")+": "+e.loaded.join(", "):e.$t("Connecting")+"..."),1)]),_:1})]),_:1})]),_:1},512),[[j,!e.error&&e.verification===!0]]),k(u(F,{onClick:c[0]||(c[0]=t=>e.showLog=!e.showLog),class:"cursor-pointer"},{default:m(()=>[u(I,{avatar:""}),u(I,null,{default:m(()=>[u(E,null,{default:m(()=>[D(y(e.showLog===!0?e.$t("Hide Log"):e.$t("Show Log"))+" ("+y(e.logs.length)+")",1)]),_:1})]),_:1})]),_:1},512),[[j,!e.error]]),(b(!0),K(te,null,se(e.logs,t=>k((b(),T(F,{key:t.id},{default:m(()=>[u(I,{avatar:""},{default:m(()=>[t.criticality==="warn"||t.criticality==="error"?(b(),T(v,{key:0,name:"mdi-alert-box"})):(b(),T(v,{key:1,name:"mdi-information"}))]),_:2},1024),u(I,null,{default:m(()=>[u(E,null,{default:m(()=>[D(y(t.args.join(", ")),1)]),_:2},1024),u(E,{caption:""},{default:m(()=>[D(y(e.format(t.ts,"dd.MM.yyyy, HH:mm:ss"))+" | "+y(t.criticality.toUpperCase())+" | "+y(t.category.toUpperCase()),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)),[[j,e.error||e.showLog===!0]])),128))]),_:1})]),we])],512),[[j,e.allLoaded!==!0||!e.verification||e.error]]),e.loaded.includes("pro")&&e.settings.securePageType&&!e.login&&!(e.$route.path.indexOf("/configuration")!==-1&&e.settings.secureConfigurationType)?(b(),T(s,{key:0,ns:"securePage",onOnSuccess:c[1]||(c[1]=t=>e.login=!0)})):(b(),K("div",be,[e.verification===!0&&e.error===!1&&e.allLoaded===!0?(b(),T(W,{key:0,class:"jarvis-page-container",view:e.drawerMiniMode===!0?"lHh lpR lFf":"hHh lpR fFf"},{default:m(()=>[u(o,{name:"sidebar"}),u(o,{name:"notifications"}),u(o)]),_:1},8,["view"])):_("",!0)])),ye],2)}var Oe=pe(fe,[["render",Ae]]);export{Oe as A};
