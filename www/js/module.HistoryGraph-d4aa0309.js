import{K as useQuasar,c as QLinearProgress,j as QSpace,k as QBtn,C as ClosePopup,z as QMenu,ae as setCssVar}from"./vendor.quasar-78ba37d9.js";import{d as defineComponent,u as computed,r as resolveComponent,o as openBlock,a as createElementBlock,e as createBaseVNode,t as toDisplayString,j as createTextVNode,h as createVNode,b as withDirectives,v as vShow,p as ref,O as unref,q as onMounted,s as onUnmounted,f as createBlock,g as createCommentVNode,y as normalizeStyle,n as normalizeClass,i as withCtx,B as withModifiers}from"./vendor.vue-1bbf3cb4.js";import"./vendor.echarts-c3f5bfdf.js";import{U}from"./vendor.vue-echarts-3becd7fd.js";import{b as useIoBroker}from"./stores-22cbae97.js";import{F as Functions}from"./functions-9f904a0e.js";import{M as Modules}from"./modules-9c8c454f.js";import{u as useI18n}from"./vendor.vue-i18n-e0977824.js";import{_ as _export_sfc,f as format,z as zero}from"./helpers-7b53fe93.js";import{P as Pro,D as Devices,L as Log}from"./controllers-596cf83c.js";import{v as v4}from"./vendor.uuid-b6f2345c.js";import{k as differenceInDays}from"./vendor.date-fns-448d10fa.js";var de={"HistoryGraph#description":"Stellt historische Werte (z.B. aus ioBroker.history) grafisch als Chart mittels Echarts dar.",second:"Sekunde",seconds:"Sekunden",minute:"Minute",minutes:"Minuten",hour:"Stunde",hours:"Stunden",day:"Tag",days:"Tage",week:"Woche",weeks:"Wochen",month:"Monat",months:"Monate",Second:"Sekunde",Seconds:"Sekunden",Minute:"Minute",Minutes:"Minuten",Hour:"Stunde",Hours:"Stunden",Day:"Tag",Days:"Tage",Week:"Woche",Weeks:"Wochen",Month:"Monat",Months:"Monate","config#HistoryGraph#chartType#label":"Chart Typ","config#HistoryGraph#maxEntries#label":"Maximale Eintr\xE4ge","config#HistoryGraph#maxEntries#description":"Maximale Eintr\xE4ge, die im Chart dargestellt werden sollen (zu viele Eintr\xE4ge verlangsamen die Seite).","config#HistoryGraph#legend#label":"Legende","config#HistoryGraph#legend#options#top":"oben","config#HistoryGraph#legend#options#bottom":"unten","config#HistoryGraph#legend#options#off":"aus","config#HistoryGraph#zoom#label":"Zoom-Buttons anzeigen","config#HistoryGraph#dataZoom#label":"Daten-Zoom Slider","config#HistoryGraph#dataZoom#description":"Daten-Zoom in Prozent von 0 (ausblenden) bzw. 1 bis 100.","config#HistoryGraph#showSymbol#label":"Markierungen / Symbole in Chart-Linie zeigen","config#HistoryGraph#timeType#label":"Modus","config#HistoryGraph#timeTimelineDate#label":"Zeitleiste mit festen Datumsangaben","config#HistoryGraph#timeReviewValue#label":"Standard-Zeit des historischen R\xFCckblicks","config#HistoryGraph#timeReviewUnit#label":"Standard-Einheit des historischen R\xFCckblicks","config#HistoryGraph#timeConfigurable#label":"Konfigurierbar im Frontend","config#HistoryGraph#timeRefresh#label":"Aktualisierungsintervall (in Minuten)","config#HistoryGraph#xAxis#label":"Konfiguration der x-Achse","config#HistoryGraph#xAxis#info":"\xF6ffne Konfigurationsoptionen","config#HistoryGraph#yAxis#label":"Konfiguration der y-Achse","config#HistoryGraph#yAxis#info":"\xF6ffne Konfigurationsoptionen","config#HistoryGraph#dateFormat#label":"Datumsformat der x-Achse","config#HistoryGraph#callback#label":"Callback","config#HistoryGraph#callback#info":"Mittels Callback-Funktion (Parameter Wert, Zeitstempel und Index) den Wert ver\xE4ndert","config#HistoryGraph#series#label":"Konfiguration der Serie","config#HistoryGraph#series#info":"\xF6ffne Konfigurationsoptionen","config#HistoryGraph#ack#select#both":"beide (true und false)","config#HistoryGraph#ack#select#true":"best\xE4tigt (nur true)","config#HistoryGraph#ack#select#false":"nicht best\xE4tigt (nur false)",Timeline:"Zeitleiste",Review:"R\xFCckblick"},__glob_8_90=Object.freeze(Object.defineProperty({__proto__:null,default:de},Symbol.toStringTag,{value:"Module"})),en={"HistoryGraph#description":"Displays the historical values (e.g. from ioBroker.history) as a chart using Echarts.","config#HistoryGraph#chartType#label":"Type of Chart","config#HistoryGraph#maxEntries#label":"Max. Entries","config#HistoryGraph#maxEntries#description":"Maximum numbers of entries to show (too many entries slow down the page).","config#HistoryGraph#legend#label":"Legend","config#HistoryGraph#legend#options#top":"top","config#HistoryGraph#legend#options#bottom":"bottom","config#HistoryGraph#legend#options#off":"off","config#HistoryGraph#zoom#label":"Show Zoom buttons","config#HistoryGraph#dataZoom#label":"Data-Zoom Slider","config#HistoryGraph#dataZoom#info":"Data-Zoom as Percentage from 0 (hide) respectively 1 to 100.","config#HistoryGraph#showSymbol#label":"Show Markers in Chart-Lines","config#HistoryGraph#timeType#label":"Mode","config#HistoryGraph#timeTimelineDate#label":"Time Range with fixed dates","config#HistoryGraph#timeReviewValue#label":"Default time looking back","config#HistoryGraph#timeReviewUnit#label":"Default unit looking back","config#HistoryGraph#timeConfigurable#label":"Configurable in Frontend","config#HistoryGraph#timeRefresh#label":"Refresh-Interval (in minutes)","config#HistoryGraph#xAxis#label":"Configuration of x axis","config#HistoryGraph#xAxis#info":"open configuration options","config#HistoryGraph#yAxis#label":"Configuration of y axis","config#HistoryGraph#yAxis#info":"open configuration options","config#HistoryGraph#dateFormat#label":"Date format of x axis","config#HistoryGraph#callback#label":"Callback","config#HistoryGraph#callback#info":"Modify the value using a callback function with the parameter value, timestamp and index","config#HistoryGraph#series#label":"Configuration of the serie","config#HistoryGraph#series#info":"open configuration options","config#HistoryGraph#ack#select#both":"both (true and false)","config#HistoryGraph#ack#select#true":"acknowledged (only true)","config#HistoryGraph#ack#select#false":"not acknowledged (only false)"},__glob_8_91=Object.freeze(Object.defineProperty({__proto__:null,default:en},Symbol.toStringTag,{value:"Module"})),ru={"HistoryGraph#description":"\u041E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0438\u0441\u0442\u043E\u0440\u0438\u0447\u0435\u0441\u043A\u0438\u0445 \u0434\u0430\u043D\u043D\u044B\u0445 (\u0438\u0437 ioBroker.history) \u0432 \u0432\u0438\u0434\u0435 \u0433\u0440\u0430\u0444\u0438\u043A\u0430 \u0441 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435\u043C Echarts.",second:"",seconds:"",minute:"",minutes:"",hour:"",hours:"",day:"",days:"",week:"",weeks:"",month:"",months:"",Second:"",Seconds:"",Minute:"",Minutes:"",Hour:"",Hours:"",Day:"",Days:"",Week:"",Weeks:"",Month:"",Months:"","config#HistoryGraph#chartType#label":"\u0422\u0438\u043F \u0433\u0440\u0430\u0444\u0438\u043A\u0430","config#HistoryGraph#maxEntries#label":"\u041C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u043E\u0435 \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u0434\u0430\u043D\u043D\u044B\u0445","config#HistoryGraph#maxEntries#description":"\u041C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u043E\u0435 \u043A\u043E\u043B\u0442\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F (\u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0435 \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u0434\u0430\u043D\u043D\u044B\u0445 \u0437\u0430\u043C\u0435\u0434\u043B\u0438\u0442 \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B)","config#HistoryGraph#legend#label":"\u041B\u0435\u0433\u0435\u043D\u0434\u0430","config#HistoryGraph#legend#options#top":"\u0441\u0432\u0435\u0440\u0445\u0443","config#HistoryGraph#legend#options#bottom":"\u0441\u043D\u0438\u0437\u0443","config#HistoryGraph#legend#options#off":"\u041E\u0442\u043A\u043B\u044E\u0447\u0435\u043D\u0430","config#HistoryGraph#zoom#label":"\u041E\u0442\u043E\u0431\u0440\u0430\u0436\u0430\u0442\u044C \u043A\u043D\u043E\u043F\u043A\u0438 \u043C\u0430\u0441\u0448\u0442\u0430\u0431\u0430","config#HistoryGraph#dataZoom#label":"\u0421\u043B\u0430\u0439\u0434\u0435\u0440 \u043C\u0430\u0441\u0448\u0442\u0430\u0431\u0430","config#HistoryGraph#dataZoom#description":"","config#HistoryGraph#showSymbol#label":"\u041E\u0442\u043E\u0431\u0440\u0430\u0436\u0430\u0442\u044C \u043C\u0430\u0440\u043A\u0435\u0440\u044B \u043D\u0430 \u0433\u0440\u0430\u0444\u0438\u043A\u0435","config#HistoryGraph#timeType#label":"\u0420\u0435\u0436\u0438\u043C","config#HistoryGraph#timeTimelineDate#label":"\u0418\u043D\u0442\u0435\u0440\u0432\u0430\u043B \u0434\u0430\u0442 \u0441 \u0444\u0438\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u043C\u0438 \u0434\u0430\u0442\u0430\u043C\u0438","config#HistoryGraph#timeReviewValue#label":"\u0413\u043B\u0443\u0431\u0438\u043D\u0430 \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E","config#HistoryGraph#timeReviewUnit#label":"\u0420\u0430\u0437\u043C\u0435\u0440\u043D\u043E\u0441\u0442\u044C \u0433\u043B\u0443\u0431\u0438\u043D\u044B \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u043F\u043E \u0443\u043C\u043E\u0442\u0447\u0435\u043D\u0438\u044E","config#HistoryGraph#timeConfigurable#label":"\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u043C","config#HistoryGraph#timeRefresh#label":"","config#HistoryGraph#xAxis#label":"\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430 \u043E\u0441\u0438 x","config#HistoryGraph#xAxis#info":"\u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u043F\u0446\u0438\u0438 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438","config#HistoryGraph#yAxis#label":"\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430 \u043E\u0441\u0438 y","config#HistoryGraph#yAxis#info":"\u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u043F\u0446\u0438\u0438 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438","config#HistoryGraph#dateFormat#label":"\u0424\u043E\u0440\u043C\u0430\u0442 \u0434\u0430\u0442\u044B \u043E\u0441\u0438 x","config#HistoryGraph#callback#label":"","config#HistoryGraph#callback#info":"","config#HistoryGraph#series#label":"","config#HistoryGraph#series#info":"","config#HistoryGraph#ack#select#both":"\u043E\u0431\u0430 (true \u0438 false)","config#HistoryGraph#ack#select#true":"\u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D (true)","config#HistoryGraph#ack#select#false":"\u043D\u0435 \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D (false)",Timeline:"\u0412\u0440\u0435\u043C\u0435\u043D\u043D\u0430\u044F \u0448\u043A\u0430\u043B\u0430",Review:"\u041E\u0431\u0437\u043E\u0440"},__glob_8_92=Object.freeze(Object.defineProperty({__proto__:null,default:ru},Symbol.toStringTag,{value:"Module"}));const _sfc_main$2=defineComponent({name:"ModuleHistoryGraphCustomBody",props:["item","device","ModuleConfigValues"],emits:["onChange"],setup(e,{emit:g}){const C=useI18n(),k=computed(()=>e.item.label||e.device.label||e.device.name),v=computed(()=>{let d=[];try{d=JSON.parse(e.ModuleConfigValues.yAxis)||[],d=Array.isArray(d)?d:[d]}catch{d=[]}return d.map((p,l)=>({value:l,label:(p.name?p.name:"("+C.t("No Name defined")+")")+" ("+l+")"}))}),H=computed(()=>v.value[e.item.moduleConfig&&Number.isInteger(e.item.moduleConfig.yaxis)?e.item.moduleConfig.yaxis:0]||{});return{onChange:d=>g("onChange",d),deviceLabel:k,yAxis:v,yAxisSelected:H}}}),_hoisted_1$2={class:"row items-center"},_hoisted_2$1={class:"row items-center"};function _sfc_render$2(e,g,C,k,v,H){const n=resolveComponent("inputs");return openBlock(),createElementBlock("div",null,[createBaseVNode("div",_hoisted_1$2,[createBaseVNode("span",null,[createBaseVNode("strong",null,toDisplayString(e.device.name),1),createTextVNode(" ("+toDisplayString(e.device.function+", #"+e.item.deviceId)+")",1)])]),createBaseVNode("div",_hoisted_2$1,[createVNode(n,{dense:"",style:{width:"170px"},onOnChange:e.onChange,label:"Label",itemId:e.item.id,id:"label",value:e.deviceLabel},null,8,["onOnChange","itemId","value"]),createVNode(n,{dense:"",type:"color",onOnChange:e.onChange,label:"Chart Line Color",itemId:e.item.id,id:"moduleConfig.color",value:e.item.moduleConfig&&e.item.moduleConfig.color||""},null,8,["onOnChange","itemId","value"]),withDirectives(createVNode(n,{dense:"",type:"select",onOnSelect:e.onChange,label:"Y Axis",itemId:e.item.id,id:"moduleConfig.yaxis",value:e.yAxisSelected,options:e.yAxis},null,8,["onOnSelect","itemId","value","options"]),[[vShow,e.yAxis.length>1]])])])}var customBodySection=_export_sfc(_sfc_main$2,[["render",_sfc_render$2]]),HistoryGraph_config_customBodySection=Object.freeze(Object.defineProperty({__proto__:null,default:customBodySection},Symbol.toStringTag,{value:"Module"}));const _sfc_main$1=defineComponent({name:"ModuleHistoryGraphCustomAction",props:["item","device"],emits:["onChange"],setup(e,{emit:g}){const C=useIoBroker(),k=[{value:"both",translate:"config#HistoryGraph#ack#select#both"},{value:"true",translate:"config#HistoryGraph#ack#select#true"},{value:"false",translate:"config#HistoryGraph#ack#select#false"}],v=computed(()=>e.device.states[e.item.primaryStateKey].properties&&e.device.states[e.item.primaryStateKey].properties.value!==void 0&&e.device.states[e.item.primaryStateKey].properties.value!==null),H=computed(()=>{var l;return((l=C.instanceList)==null?void 0:l.val)||[]}),n=computed(()=>H.value.filter(l=>["history","sql","influxdb"].includes(l.substr(0,l.indexOf(".")))).map(l=>({label:l,value:l})));!e.item.historyAdapter&&n.value[0]&&n.value[0].value&&g("onChange",{itemId:e.item.id,id:"historyAdapter",value:n.value[0].value});const d=computed(()=>Object.keys(e.device.states).map(l=>({label:l,value:l})));return{onChange:l=>g("onChange",l),deviceCallback:v,optionsAck:k,optionsDeviceStatesOptions:d,optionsHistoryAdapters:n}}}),_hoisted_1$1={class:"row"};function _sfc_render$1(e,g,C,k,v,H){const n=resolveComponent("inputs");return openBlock(),createElementBlock("div",_hoisted_1$1,[createVNode(n,{dense:"",onOnSelect:e.onChange,label:"Action State",itemId:e.item.id,id:"primaryStateKey",value:e.item.primaryStateKey,type:"select",options:e.optionsDeviceStatesOptions},null,8,["onOnSelect","itemId","value","options"]),createVNode(n,{dense:"",onOnSelect:e.onChange,label:"History Adapter",itemId:e.item.id,id:"historyAdapter",value:e.item.historyAdapter,type:"select",options:e.optionsHistoryAdapters},null,8,["onOnSelect","itemId","value","options"]),createVNode(n,{dense:"",onOnSelect:e.onChange,label:"Ack",itemId:e.item.id,id:"moduleConfig.ack",value:e.item.moduleConfig&&e.item.moduleConfig.ack!==void 0?e.item.moduleConfig.ack:"both",info:"config#Chart#ack",type:"select",options:e.optionsAck,style:{width:"240px"}},null,8,["onOnSelect","itemId","value","options"]),withDirectives(createVNode(n,{dense:"",style:{width:"150px"},type:"switch",onOnChange:e.onChange,label:"Use Device Value Function",itemId:e.item.id,id:"moduleConfig.deviceCallback",value:e.item.moduleConfig&&e.item.moduleConfig.deviceCallback!==void 0?e.item.moduleConfig.deviceCallback:!1},null,8,["onOnChange","itemId","value"]),[[vShow,e.deviceCallback]])])}var customActionSection=_export_sfc(_sfc_main$1,[["render",_sfc_render$1]]),HistoryGraph_config_customActionSection=Object.freeze(Object.defineProperty({__proto__:null,default:customActionSection},Symbol.toStringTag,{value:"Module"}));const Settings={addGroup:!1,addDivider:!1,addDevice:!0,customBodySection,customActionSection};var ConfigFile=[{columns:2,parameter:"chartType",label:"config#HistoryGraph#chartType#label",type:"Select",value:"line",options:[{value:"line",translate:"Line-Chart (normal)"},{value:"stepped",translate:"Line-Chart (stepped)"},{value:"smooth",translate:"Line-Chart (smooth)"},{value:"bar",translate:"Bar-Chart"}]},{columns:2,parameter:"maxEntries",label:"config#HistoryGraph#maxEntries#label",info:"config#HistoryGraph#maxEntries#description",type:"Number",value:500,min:1},{columns:2,parameter:"legend",label:"config#HistoryGraph#legend#label",type:"Select",options:[{value:"top",translate:"config#HistoryGraph#legend#options#top"},{value:"bottom",translate:"config#HistoryGraph#legend#options#bottom"},{value:"off",translate:"config#HistoryGraph#legend#options#off"}],value:"top"},{columns:2,parameter:"showSymbol",label:"config#HistoryGraph#showSymbol#label",type:"Switch",value:!0},{columns:2,parameter:"zoom",label:"config#HistoryGraph#zoom#label",type:"Switch",value:!0},{columns:2,parameter:"dataZoom",label:"config#HistoryGraph#dataZoom#label",info:"config#HistoryGraph#dataZoom#description",type:"Number",value:80,max:100,min:0},{columns:3,parameter:"timeType",label:"config#HistoryGraph#timeType#label",type:"Select",value:"review",options:[{value:"timeline",translate:"Timeline"},{value:"review",translate:"Review"}]},{columns:7,type:"Placeholder",dependencies:{timeType:[void 0,null]}},{columns:7,parameter:"timeTimelineDate",label:"config#HistoryGraph#timeTimelineDate#label",type:"Date",dependencies:{timeType:"timeline"}},{columns:2,parameter:"timeReviewValue",label:"config#HistoryGraph#timeReviewValue#label",type:"Number",value:7,min:0,dependencies:{timeType:"review"}},{columns:3,parameter:"timeReviewUnit",label:"config#HistoryGraph#timeReviewUnit#label",type:"Select",value:"days",options:[{value:"seconds",translate:"Seconds"},{value:"minutes",translate:"Minutes"},{value:"hours",translate:"Hours"},{value:"days",translate:"Days"},{value:"weeks",translate:"Weeks"},{value:"months",translate:"Months"}],dependencies:{timeType:"review"}},{columns:2,parameter:"timeRefresh",label:"config#HistoryGraph#timeRefresh#label",type:"Number",placeholder:"auto",dependencies:{timeType:"review"}},{columns:2,parameter:"timeConfigurable",label:"config#HistoryGraph#timeConfigurable#label",type:"Switch",value:!0},{columns:6,isPro:!0,parameter:"yAxis",label:"config#HistoryGraph#yAxis#label",info:"config#HistoryGraph#yAxis#info",link:"https://echarts.apache.org/en/option.html#yAxis",placeholder:"{}",json:!0},{columns:4,isPro:!0,parameter:"xAxis",label:"config#HistoryGraph#xAxis#label",info:"config#HistoryGraph#yAxis#info",link:"https://echarts.apache.org/en/option.html#xAxis",placeholder:"{}",json:!0},{columns:2,parameter:"dateFormat",label:"config#HistoryGraph#dateFormat#label",placeholder:"{HH}:{mm}\\n{dd}.{MM}."},{columns:6,isPro:!0,parameter:"series",label:"config#HistoryGraph#series#label",info:"config#HistoryGraph#series#info",link:"https://echarts.apache.org/en/option.html#series-line",placeholder:"{}",json:!0},{columns:6,isPro:!0,parameter:"callback",label:"config#HistoryGraph#callback#label",info:"config#HistoryGraph#callback#info",placeholder:"(val, ts, index) => val"}],__glob_2_6=Object.freeze(Object.defineProperty({__proto__:null,Settings,default:ConfigFile},Symbol.toStringTag,{value:"Module"}));const _sfc_main=defineComponent({name:"ModuleHistoryGraph",props:["_containerSize","_widgetSize","widget"],provide:{[U]:"dark"},setup(props){var e,g,C,k,v,H,n,d,p,l,M,T,D,_,O,L,I,B,V,P,N;const iobroker=useIoBroker(),$q=useQuasar(),config=computed(()=>props.widget.config),instanceList=((e=iobroker.instanceList)==null?void 0:e.val)||[],from=new Date(new Date().getTime()-7*24*3600*1e3),to=new Date,moduleConfig=computed(()=>({...Modules.joinConfig(config.value,ConfigFile),defaultHistoryAdapter:instanceList.find(o=>["history","sql","influxdb"].includes(o.substr(0,o.indexOf(".")))),stepLineChart:!1,timeTimelineDate:{from:{year:from.getFullYear(),month:from.getMonth()+1,day:from.getDate()},to:{year:to.getFullYear(),month:to.getMonth()+1,day:to.getDate()},...config.value.timeTimelineDate||{}}}));if(Pro.isPro()){if(moduleConfig.value.callback)try{moduleConfig.value.chartCallback=eval(moduleConfig.value.callback);const test=moduleConfig.value.chartCallback&&moduleConfig.value.chartCallback(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.chartCallback,moduleConfig.value.callback,o),moduleConfig.value.chartCallback=null}if(((g=moduleConfig.value.xAxis)==null?void 0:g.min)&&((C=moduleConfig.value.xAxis)==null?void 0:C.min.indexOf("("))!==-1&&((k=moduleConfig.value.xAxis)==null?void 0:k.min.indexOf(")"))!==-1)try{moduleConfig.value.xMin=eval(moduleConfig.value.xAxis.min);const test=moduleConfig.value.xMin&&moduleConfig.value.xMin(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.xMin,moduleConfig.value.callback,o),moduleConfig.value.xMin=null}if(((v=moduleConfig.value.xAxis)==null?void 0:v.max)&&((H=moduleConfig.value.xAxis)==null?void 0:H.max.indexOf("("))!==-1&&((n=moduleConfig.value.xAxis)==null?void 0:n.max.indexOf(")"))!==-1)try{moduleConfig.value.xMax=eval(moduleConfig.value.xAxis.max);const test=moduleConfig.value.xMax&&moduleConfig.value.xMax(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.xMax,moduleConfig.value.callback,o),moduleConfig.value.xMax=null}if(((p=(d=moduleConfig.value.xAxis)==null?void 0:d.axisLabel)==null?void 0:p.formatter)&&((M=(l=moduleConfig.value.xAxis)==null?void 0:l.axisLabel)==null?void 0:M.formatter.indexOf("("))!==-1&&((D=(T=moduleConfig.value.xAxis)==null?void 0:T.axisLabel)==null?void 0:D.formatter.indexOf(")"))!==-1)try{moduleConfig.value.xCallback=eval((O=(_=moduleConfig.value.xAxis)==null?void 0:_.axisLabel)==null?void 0:O.formatter);const test=moduleConfig.value.xCallback&&moduleConfig.value.xCallback(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.xCallback,(I=(L=moduleConfig.value.xAxis)==null?void 0:L.axisLabel)==null?void 0:I.formatter,o),moduleConfig.value.xCallback=null}else(V=(B=moduleConfig.value.xAxis)==null?void 0:B.axisLabel)!=null&&V.formatter&&(moduleConfig.value.xCallback=(N=(P=moduleConfig.value.xAxis)==null?void 0:P.axisLabel)==null?void 0:N.formatter);const yAxes=!moduleConfig.value.yAxis||Array.isArray(moduleConfig.value.yAxis)?moduleConfig.value.yAxis||[]:[moduleConfig.value.yAxis];yAxes.forEach((yAxis,i)=>{var o,t,r,m,y,h,c,f;if(moduleConfig.value.yCallbacks=moduleConfig.value.yCallbacks||[],((o=yAxis.axisLabel)==null?void 0:o.formatter)&&((t=yAxis.axisLabel)==null?void 0:t.formatter.indexOf("("))!==-1&&((r=yAxis.axisLabel)==null?void 0:r.formatter.indexOf(")"))!==-1)try{moduleConfig.value.yCallbacks[i]=eval((m=yAxis.axisLabel)==null?void 0:m.formatter);const test=moduleConfig.value.yCallbacks[i]&&moduleConfig.value.yCallbacks[i](1)}catch(b){console.warn("HistoryGraph",moduleConfig.value.yCallbacks[i],(h=(y=moduleConfig.value.yAxis)==null?void 0:y.axisLabel)==null?void 0:h.formatter,b),moduleConfig.value.yCallbacks[i]=null}else(c=yAxis.axisLabel)!=null&&c.formatter&&(moduleConfig.value.yCallbacks[i]=(f=yAxis.axisLabel)==null?void 0:f.formatter)})}const userConfig=ref(moduleConfig.value),tempConfig=ref(moduleConfig.value),optionsTimeType=ConfigFile.find(o=>o.parameter==="timeType").options,optionsTimeReviewUnits=ConfigFile.find(o=>o.parameter==="timeReviewUnit").options,loaded=ref(!1),errors=ref({}),key=ref(v4()),chartSeries=ref([]);let chartLabels={};const addSerieToChart=(history,config,state,device)=>{var o,t;Log.dev("Add Serie to Chart",history,config,state,device);let label=config&&config.label||device&&device.name||device&&device.label||"???",data={};config.moduleConfig&&config.moduleConfig.color&&setCssVar("history-graph--"+label.toLowerCase().replace(/ /g,"-").replace(/\./g,"-"),config.moduleConfig.color);let iterations=0;for(;Object.values(chartLabels).includes(label);)iterations++,label=label+" ("+iterations+")";chartLabels[device.id+":"+state.stateKey]=label;const maxEntries=parseInt(moduleConfig.value.maxEntries)||500,drop=history.length>maxEntries?Math.ceil(history.length/maxEntries):null;if(history.forEach(({ts,ack,val},i)=>{var r,m;if(ts=Math.round(ts/1e3)*1e3,ack=ack!=null?ack:"both",(!config.moduleConfig||config.moduleConfig.ack===void 0||config.moduleConfig.ack===null||config.moduleConfig.ack==="both"||config.moduleConfig.ack.toString()===ack.toString()||ack.toString()==="both")&&(drop===null||i%drop===0)){if(typeof val=="boolean"&&(moduleConfig.value.stepLineChart=!0,val=val===!0?1:0),val=parseFloat(val)||val,Pro.isPro()&&config.moduleConfig&&config.moduleConfig.deviceCallback===!0&&((r=state.properties)==null?void 0:r.value))try{const cb=eval((m=state.properties)==null?void 0:m.value);val=cb(val,ts,i)}catch(y){console.warn("HistoryGraph",y.message)}else Pro.isPro()&&moduleConfig.value.chartCallback&&(val=moduleConfig.value.chartCallback(val,ts,i));(!moduleConfig.value.yAxis||moduleConfig.value.yAxis.type!=="log"||moduleConfig.value.yAxis.type==="log"&&val!==0)&&(data[ts]=data[ts]&&data[ts][1]!==null?data[ts]:[ts,val,state.unit||Functions._defaults&&Functions._defaults[config.primaryStateKey]&&Functions._defaults[config.primaryStateKey].unit||""])}}),moduleConfig.value.timeType==="review"&&history.length>0){const r=moduleConfig.value.timeReviewUnit,m=Date.now(),y=(m-history[history.length-1].ts)/1e3,h=Math.floor(y/60),c=Math.floor(h/60),f=Math.floor(c/24),b=Math.floor(f/7),S=Math.floor(f/30);let s=null,u=1;if(r==="months"&&S>1?(s=S,u=30*24*60*60):r==="weeks"&&b>1?(s=b,u=7*24*60*60):r==="days"&&f>1?(s=f,u=24*60*60):r==="hours"&&c>1?(s=c,u=60*60):r==="minutes"&&h>1?(s=h,u=60):r==="seconds"&&y>1&&(s=y,u=1),s)for(let a=history[history.length-1].ts/1e3;a<=Math.floor(m/1e3);a+=u)data[a]=[a*1e3,history[history.length-1].val,state.unit||Functions._defaults&&Functions._defaults[config.primaryStateKey]&&Functions._defaults[config.primaryStateKey].unit||""]}data=Object.values(data);const color=config.moduleConfig&&config.moduleConfig.color?getComputedStyle(document.documentElement).getPropertyValue(config.moduleConfig.color.substr(0,config.moduleConfig.color.length-1).replace("var(",""))||config.moduleConfig.color:void 0,chartSerie={name:label,step:moduleConfig.value.stepLineChart||(moduleConfig.value.chartType==="stepped"?"start":void 0),smooth:moduleConfig.value.chartType==="smooth",showSymbol:moduleConfig.value.showSymbol!==void 0?moduleConfig.value.showSymbol:!1,emphasis:{lineStyle:{width:2}},connectNulls:!0,symbol:"roundRect",...moduleConfig.value.series||{},lineStyle:{width:2,color,...((o=moduleConfig.value.series)==null?void 0:o.lineStyle)||{}},itemStyle:{width:2,color,...((t=moduleConfig.value.series)==null?void 0:t.itemStyle)||{}},type:moduleConfig.value.chartType==="bar"?"bar":"line",yAxisIndex:Pro.isPro()&&moduleConfig.value.yAxis&&Array.isArray(moduleConfig.value.yAxis)&&moduleConfig.value.yAxis.length>1&&config.moduleConfig&&Number.isInteger(config.moduleConfig.yaxis)?config.moduleConfig.yaxis:0,deviceId:config.deviceId,stateKey:config.primaryStateKey,data},findSerieIndex=chartSeries.value.findIndex(r=>r.deviceId===config.deviceId&&r.stateKey===config.primaryStateKey);chartSeries.value[findSerieIndex]=chartSerie,key.value=v4()},subscriptionKeys=[],subscribe=()=>{const o={...moduleConfig.value,...userConfig.value,count:999999,aggregate:"none"};if(o.timeType==="timeline")o.start=new Date(o.timeTimelineDate.from.year,o.timeTimelineDate.from.month-1,o.timeTimelineDate.from.day).getTime(),o.end=new Date(o.timeTimelineDate.to.year,o.timeTimelineDate.to.month-1,o.timeTimelineDate.to.day).getTime(),o.count=differenceInDays(o.end,o.start)*200;else{let t=(o.timeReviewValue||7)*1e3;switch(o.timeReviewUnit){case"seconds":break;case"minutes":t=t*60;break;case"hours":t=t*60*60;break;case"weeks":t=t*60*60*24*7;break;case"months":t=t*60*60*24*31;break;case"days":default:t=t*60*60*24;break}o.review=t}chartLabels={},!props.widget.items||props.widget.items.length===0?(loaded.value=!0,errors.value.noDevices="No devices defined for HistoryGraph!"):(delete errors.value.noDevices,props.widget.items.forEach(t=>{if(t.type==="device"){chartSeries.value.some(a=>a.deviceId===t.deviceId&&a.stateKey===t.primaryStateKey)||chartSeries.value.push({deviceId:t.deviceId,stateKey:t.primaryStateKey,type:moduleConfig.value.chartType==="bar"?"bar":"line",data:[]});const r=(a,{subscriptionKey:A,history:w},G,x)=>{if(Log.dev("Got history data",A,x.id,w&&w.label||x&&x.name||x&&x.label,G,G.stateKey),loaded.value=!0,a||!w){const z=a&&a.message||"Invalid History Data";return errors.value[A]=G.stateKey+": "+z+"!",errors.value}delete errors.value[A],delete chartLabels[x.id+":"+G.stateKey],addSerieToChart(w,t,G,x)},{start:m,end:y,review:h,step:c,count:f,ack:b,ignoreNull:S,aggregate:s}=o,u=Devices.history(t.deviceId,t.primaryStateKey,{timeRefresh:o.timeRefresh,timeReviewUnit:o.timeReviewUnit,start:m,end:y,review:h,step:c,count:f,ack:b,ignoreNull:S,aggregate:s,instance:t.historyAdapter||moduleConfig.value.defaultHistoryAdapter},r);subscriptionKeys.push({subscriptionKey:u,deviceId:t.deviceId,stateKey:t.primaryStateKey})}}))},chartOptions=computed(()=>{var h;const o=Pro.isPro()&&moduleConfig.value.yAxis?moduleConfig.value.yAxis:null;!Pro.isPro()&&(moduleConfig.value.xAxis||moduleConfig.value.yAxis)&&Pro.warn("HistoryGraph: Axis Configuration is only available to Pro!");let t=7;const r=2;let m=90;return moduleConfig.value.zoom&&(t+=10,m-=10),moduleConfig.value.dataZoom&&(m-=17),moduleConfig.value.legend==="top"&&(t+=10,m-=10),moduleConfig.value.legend==="bottom"&&(m-=10),{key:unref(key),backgroundColor:"transparent",tooltip:{trigger:"axis",position:(c,f,b,S,s)=>{const u=c[0],a=s.viewSize[0];return u>a/2?{left:u-s.contentSize[0],top:"10%"}:{left:u,top:"10%"}},formatter:c=>{const f=Array.isArray(c)?c:[],b={};f.forEach(s=>{let[,u,a]=s.data||[];a=typeof a=="object"?a[u]||a.default:a,b[s.seriesId]=""+s.marker+'<span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">'+s.seriesName+'</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">'+(typeof u=="number"?u.toFixed(2):"-")+(a?" "+a:"")+"</span>"});const S=f.find(s=>s.axisType==="xAxis.time");return S?format(S.axisValueLabel,"dd.MM.yyyy, HH:mm:ss")+"<br />"+Object.values(b).join("<br />"):null}},legend:{show:moduleConfig.value.legend!=="off",bottom:moduleConfig.value.legend==="bottom"?moduleConfig.value.dataZoom?50:0:"auto",padding:[10,10,0,10],textStyle:{color:$q.dark.isActive?"#fff":"#666"}},grid:{top:t+"%",left:"2%",right:"2%",bottom:r+"%",containLabel:!0,height:m+"%"},toolbox:{feature:{dataZoom:{show:moduleConfig.value.zoom,yAxisIndex:"none"}}},xAxis:{...Pro.isPro()&&moduleConfig.value.xAxis||{},min:moduleConfig.value.xMin,max:moduleConfig.value.xMax,axisLabel:{fontSize:10,...Pro.isPro()&&((h=moduleConfig.value.xAxis)==null?void 0:h.axisLabel)||{},formatter:Pro.isPro()&&moduleConfig.value.xCallback?moduleConfig.value.xCallback:moduleConfig.value.dateFormat?moduleConfig.value.dateFormat.replace("HH:mm|dd.MM.","{HH}:{mm}|{dd}.{MM}.").replace(/\|/g,`
`):{year:"{yyyy}",month:"{MMM}",day:`
{dd}.{MM}.`,hour:`{HH}:{mm}
{dd}.{MM}.`,minute:"{HH}:{mm}",second:"{HH}:{mm}:{ss}",millisecond:"{hh}:{mm}:{ss} {SSS}",none:"{yyyy}-{MM}-{dd} {hh}:{mm}:{ss} {SSS}"}},type:"time"},yAxis:o&&Array.isArray(o)&&o.length>0?o.map((c,f)=>({axisPointer:{show:!0},splitLine:{lineStyle:{color:"#ccc"}},type:"value",...c||{},axisLabel:{...(c==null?void 0:c.axisLabel)||{},formatter:moduleConfig.value.yCallbacks&&moduleConfig.value.yCallbacks[f]}})):[{axisPointer:{show:!0},splitLine:{lineStyle:{color:"#ccc"}},type:"value",...o||{},axisLabel:{...(o==null?void 0:o.axisLabel)||{},formatter:moduleConfig.value.yCallbacks&&moduleConfig.value.yCallbacks[0]}}],dataZoom:moduleConfig.value.dataZoom&&[{start:100-(moduleConfig.value.dataZoom===1?100:parseInt(moduleConfig.value.dataZoom)||100),end:100}],series:chartSeries.value}}),onApply=()=>{userConfig.value=tempConfig.value,loaded.value=!1,subscribe()},onCancel=()=>{tempConfig.value=userConfig.value},onChange=o=>{tempConfig.value[o.id]=o.value};return onMounted(()=>subscribe()),onUnmounted(()=>{subscriptionKeys.forEach(o=>{Devices.unsubscribe(o.subscriptionKey,o.deviceId,o.stateKey,"history")})}),{zero,loaded,errors,moduleConfig,userConfig,tempConfig,chartOptions,onApply,onCancel,onChange,optionsTimeType,optionsTimeReviewUnits}}}),_hoisted_1={key:0},_hoisted_2={key:1},_hoisted_3={class:"row no-wrap q-pa-sm items-center bg-primary text-white"};function _sfc_render(e,g,C,k,v,H){const n=resolveComponent("alert"),d=resolveComponent("v-chart"),p=resolveComponent("inputs");return openBlock(),createElementBlock("div",{class:"jarvis-HistoryGraph-Container",style:{"min-width":"1px","min-height":"1px"},onTouchstart:g[0]||(g[0]=withModifiers(()=>{},["stop"]))},[withDirectives(createVNode(QLinearProgress,{indeterminate:""},null,512),[[vShow,!e.loaded]]),Object.values(e.errors).length>0?(openBlock(),createBlock(n,{key:0,title:Object.values(e.errors).join("<br />")},null,8,["title"])):createCommentVNode("",!0),e.loaded?(openBlock(),createElementBlock("div",{key:1,class:"jarvis-HistoryGraph",style:normalizeStyle({"min-width":"100%","min-height":"100%",width:(e._widgetSize.width||e._containerSize.width)+"px",height:e._containerSize.height-25+"px"})},[createVNode(d,{autoresize:"",option:e.chartOptions},null,8,["option"])],4)):createCommentVNode("",!0),e.moduleConfig.timeConfigurable?withDirectives((openBlock(),createElementBlock("a",{key:2,class:normalizeClass(["jarvis-HistoryGraph-Configuration","jarvis-HistoryGraph-Configuration-"+e.widget.id])},[e.userConfig.timeType==="timeline"?(openBlock(),createElementBlock("span",_hoisted_1,toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.from.year)+" - "+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.to.year),1)):(openBlock(),createElementBlock("span",_hoisted_2,toDisplayString(e.userConfig.timeReviewValue)+" "+toDisplayString(e.$t(e.userConfig.timeReviewUnit)),1)),e.moduleConfig.timeConfigurable?(openBlock(),createBlock(QMenu,{key:2,fit:"",cover:"",class:"jarvis-HistoryGraph-Menu",target:".jarvis-HistoryGraph-Configuration-"+e.widget.id,onHide:e.onCancel},{default:withCtx(()=>[createBaseVNode("div",_hoisted_3,[createVNode(p,{class:"text-white",id:"timeType",type:"Select",dense:"",value:e.tempConfig.timeType,onOnSelect:e.onChange,options:e.optionsTimeType},null,8,["value","onOnSelect","options"]),withDirectives(createVNode(p,{id:"timeTimelineDate",type:"Date",dense:"",value:e.tempConfig.timeTimelineDate,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="timeline"]]),withDirectives(createVNode(p,{id:"timeReviewValue",type:"Number",dense:"",value:e.tempConfig.timeReviewValue,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="review"]]),withDirectives(createVNode(p,{id:"timeReviewUnit",type:"Select",dense:"",value:e.tempConfig.timeReviewUnit,options:e.optionsTimeReviewUnits,onOnSelect:e.onChange},null,8,["value","options","onOnSelect"]),[[vShow,e.tempConfig.timeType==="review"]]),createVNode(QSpace),withDirectives(createVNode(QBtn,{flat:"",label:e.$t("Apply"),onClick:e.onApply},null,8,["label","onClick"]),[[ClosePopup]])])]),_:1},8,["target","onHide"])):createCommentVNode("",!0)],2)),[[vShow,e.loaded]]):createCommentVNode("",!0)],32)}var HistoryGraph=_export_sfc(_sfc_main,[["render",_sfc_render]]),HistoryGraph$1=Object.freeze(Object.defineProperty({__proto__:null,default:HistoryGraph},Symbol.toStringTag,{value:"Module"}));export{HistoryGraph_config_customBodySection as H,__glob_8_90 as _,__glob_8_91 as a,__glob_8_92 as b,__glob_2_6 as c,HistoryGraph_config_customActionSection as d,HistoryGraph$1 as e};
