import{dz as x,dK as q,dA as B,_ as oe,q as ne,dg as se,ci as re,az as le,d7 as me,dL as R,a2 as A,c as de,j as P,o as w,d as H,J as T,a1 as k,k as h,a as E,g as j,n as ue,f as pe,t as v,w as ye,I as fe,m as ge,dq as ce,c$ as he,e as ve,ab as Ce,O as we,K as be,dd as I,a3 as V}from"./index-80522cd8.js";import"./index-b8f873e3.js";import{eT as Se}from"./components-f4b977ce.js";import{s as Q}from"./index-f6a75a40.js";import"./_commonjsHelpers-45ea234c.js";import"./vue.runtime.esm-bundler-8a4aefb4.js";import"./QTooltip-839cbf20.js";import"./json-editor-c8a8a34c.js";var De=864e5;function Te(e,n){x(2,arguments);var s=Q(e),p=Q(n),t=s.getTime()-q(s),y=p.getTime()-q(p);return Math.round((t-y)/De)}function Y(e,n){var s=e.getFullYear()-n.getFullYear()||e.getMonth()-n.getMonth()||e.getDate()-n.getDate()||e.getHours()-n.getHours()||e.getMinutes()-n.getMinutes()||e.getSeconds()-n.getSeconds()||e.getMilliseconds()-n.getMilliseconds();return s<0?-1:s>0?1:s}function Me(e,n){x(2,arguments);var s=B(e),p=B(n),t=Y(s,p),y=Math.abs(Te(s,p));s.setDate(s.getDate()-t*y);var C=Number(Y(s,p)===-t),b=t*(y-C);return b===0?0:b}const Ae=ne({name:"ModuleHistoryGraph",props:["_containerSize","_widgetSize","widget"],provide:{[Se]:"dark"},setup(e){var U;const n=se(),s=re(),p=le(e.widget,"config"),t=me.joinConfig(p.value,R);t.stepLineChart=!1;const y=new Date(new Date().getTime()-7*24*3600*1e3),C=new Date;t.timeTimelineDate={from:{year:y.getFullYear(),month:y.getMonth()+1,day:y.getDate()},to:{year:C.getFullYear(),month:C.getMonth()+1,day:C.getDate()},...t.timeTimelineDate||{}};const b=((U=n.instanceList)==null?void 0:U.val)||[];t.defaultHistoryAdapter=b.find(i=>["history","sql","influxdb"].includes(i.substr(0,i.indexOf("."))));const f=A(t),z=A(t),J=R.find(i=>i.parameter==="timeType").options,W=R.find(i=>i.parameter==="timeReviewUnit").options,O=A(!1),S=A({}),M=A([]);let L={};const X=(i,a,o,r)=>{let l=a.label||r&&r.name||r&&r.label||"???",D=0;for(;Object.values(L).includes(l);)D++,l=l+" ("+D+")";L[r.id+":"+o.stateKey]=l;const g=parseInt(t.maxEntries)||500,c=i.length>g?Math.ceil(i.length/g):null;let m=[];i.forEach(({ts:d,val:u},K)=>{(c===null||K%c===0)&&(typeof u=="boolean"&&(t.stepLineChart=!0,u=u===!0?1:0),u=parseFloat(u)||u,m.push([d,u,o.unit||V._defaults&&V._defaults[a.primaryStateKey]&&V._defaults[a.primaryStateKey].unit||""]))});const N={deviceId:a.deviceId,stateKey:a.primaryStateKey,name:l,type:t.chartType==="bar"?"bar":"line",yAxisIndex:I.isPro()&&t.yAxis&&Array.isArray(t.yAxis)&&t.yAxis.length>1&&a.moduleConfig&&a.moduleConfig.yaxis||0,step:t.stepLineChart||(t.chartType==="stepped"?"start":void 0),smooth:t.chartType==="smooth",showSymbol:t.showSymbol!==void 0?t.showSymbol:!1,lineStyle:{width:2,color:a.moduleConfig&&a.moduleConfig.color},itemStyle:{width:2,color:a.moduleConfig&&a.moduleConfig.color},emphasis:{lineStyle:{width:2}},connectNulls:!0,symbol:"roundRect",data:m},F=M.value.findIndex(d=>d.deviceId===a.deviceId&&d.stateKey===a.primaryStateKey);M.value[F]=N},$=()=>{const i={...t,...f.value,count:9999999,aggregate:"none"};if(i.timeType==="timeline")i.start=new Date(i.timeTimelineDate.from.year,i.timeTimelineDate.from.month-1,i.timeTimelineDate.from.day).getTime(),i.end=new Date(i.timeTimelineDate.to.year,i.timeTimelineDate.to.month-1,i.timeTimelineDate.to.day).getTime(),i.count=Me(i.end,i.start)*200,i.step=i.count*10*60*60;else{let a=(i.timeReviewValue||7)*1e3,o=100;switch(i.timeReviewUnit){case"seconds":break;case"minutes":a=a*60,o=o*10;break;case"hours":a=a*60*60,o=o*60*10;break;case"weeks":a=a*60*60*24*7,o=o*60*60*24*10;break;case"months":a=a*60*60*24*31,o=o*60*60*24*10;break;case"days":default:a=a*60*60*24,o=o*60*60*10;break}i.step=o/1e3,i.review=a}L={},!e.widget.items||e.widget.items.length===0?(O.value=!0,S.value.noDevices="No devices defined for HistoryGraph!"):(delete S.value.noDevices,e.widget.items.forEach(a=>{if(a.type==="device"){M.value.some(d=>d.deviceId===a.deviceId&&d.stateKey===a.primaryStateKey)||M.value.push({deviceId:a.deviceId,stateKey:a.primaryStateKey,type:t.chartType==="bar"?"bar":"line",data:[]});const o=(d,{subscriptionKey:u,history:K},G,Z)=>{if(O.value=!0,d||!K){const ae=d&&d.message||"Invalid History Data";return S.value[u]=G.stateKey+": "+ae+"!",S.value}delete S.value[u],delete L[Z.id+":"+G.stateKey],X(K,a,G,Z)},{start:r,end:l,review:D,step:g,count:c,ack:m,ignoreNull:N,aggregate:F}=i;ce.history(a.deviceId,a.primaryStateKey,{start:r,end:l,review:D,step:g,count:c,ack:m,ignoreNull:N,aggregate:F,instance:a.historyAdapter||t.defaultHistoryAdapter},o)}}))},_=de(()=>{const i=I.isPro()&&t.yAxis?t.yAxis:null;!I.isPro()&&(t.xAxis||t.yAxis)&&I.warn("HistoryGraph: Axis Configuration is only available to Pro!");let a=7;const o=2;let r=90;return t.zoom&&(a+=10,r-=10),t.dataZoom&&(r-=17),t.legend==="top"&&(a+=10,r-=10),t.legend==="bottom"&&(r-=10),{backgroundColor:"transparent",tooltip:{trigger:"axis",formatter:l=>{const D=l.map(g=>{let[,c,m]=g.data||[];return m=typeof m=="object"?m[c]||m.default:m,""+g.marker+'<span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">'+g.seriesName+'</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">'+(typeof c=="number"?c.toFixed(2):"-")+(m?" "+m:"")+"</span>"});return l[0].axisValueLabel.replace(" 00:00:00","")+"<br />"+D.join("<br />")}},legend:{show:t.legend!=="off",bottom:t.legend==="bottom"?t.dataZoom?50:0:"auto",padding:[10,10,0,10],textStyle:{color:s.dark.isActive?"#fff":"#666"}},grid:{top:a+"%",left:"2%",right:"2%",bottom:o+"%",containLabel:!0,height:r+"%"},toolbox:{feature:{dataZoom:{show:t.zoom,yAxisIndex:"none"}}},xAxis:{axisLabel:{fontSize:10,formatter:t.dateFormat?t.dateFormat.replace("HH:mm|dd.MM.","{HH}:{mm}|{dd}.{MM}.").replace(/\|/g,`
`):{year:"{yyyy}",month:"{MMM}",day:`
{dd}.{MM}.`,hour:`{HH}:{mm}
{dd}.{MM}.`,minute:"{HH}:{mm}",second:"{HH}:{mm}:{ss}",millisecond:"{hh}:{mm}:{ss} {SSS}",none:"{yyyy}-{MM}-{dd} {hh}:{mm}:{ss} {SSS}"}},...I.isPro()&&t.xAxis||{},type:"time"},yAxis:i&&Array.isArray(i)&&i.length>0?i.map(l=>({splitLine:{lineStyle:{color:"#ccc"}},...l})):{splitLine:{lineStyle:{color:"#ccc"}},...i||{},type:"value",show:!t.stepLineChart},dataZoom:t.dataZoom&&[{start:100-(t.dataZoom===1?100:parseInt(t.dataZoom)||100),end:100}],series:M.value}}),ee=()=>{f.value=z.value,O.value=!1,$()},te=()=>{z.value=f.value},ie=i=>{z.value[i.id]=i.value};return $(),{loaded:O,errors:S,moduleConfig:t,userConfig:f,tempConfig:z,chartOptions:_,onApply:ee,onCancel:te,onChange:ie,optionsTimeType:J,optionsTimeReviewUnits:W}}}),He={key:0},ke={key:1},Ie={class:"row no-wrap q-pa-sm items-center bg-primary text-white"};function ze(e,n,s,p,t,y){const C=P("alert"),b=P("v-chart"),f=P("inputs");return w(),H("div",{class:"jarvis-HistoryGraph-Container",style:{"min-width":"1px","min-height":"1px"},onTouchstart:n[0]||(n[0]=ge(()=>{},["stop"]))},[T(h(he,{indeterminate:""},null,512),[[k,!e.loaded]]),Object.values(e.errors).length>0?(w(),E(C,{key:0,title:Object.values(e.errors).join("<br />")},null,8,["title"])):j("",!0),e.loaded?(w(),H("div",{key:1,class:"jarvis-HistoryGraph",style:ue({"min-width":"100%","min-height":"100%",width:(e._widgetSize.width||e._containerSize.width)+"px",height:e._containerSize.height-25+"px"})},[h(b,{autoresize:"",ref:"vchart",option:e.chartOptions},null,8,["option"])],4)):j("",!0),e.moduleConfig.timeConfigurable?T((w(),H("a",{key:2,class:pe(["jarvis-HistoryGraph-Configuration","jarvis-HistoryGraph-Configuration-"+e.widget.id])},[e.userConfig.timeType==="timeline"?(w(),H("span",He,v(e.zero(e.userConfig.timeTimelineDate.from.day))+"."+v(e.zero(e.userConfig.timeTimelineDate.from.month))+"."+v(e.userConfig.timeTimelineDate.from.year)+" - "+v(e.zero(e.userConfig.timeTimelineDate.to.day))+"."+v(e.zero(e.userConfig.timeTimelineDate.to.month))+"."+v(e.userConfig.timeTimelineDate.to.year),1)):(w(),H("span",ke,v(e.userConfig.timeReviewValue)+" "+v(e.$t(e.userConfig.timeReviewUnit)),1)),e.moduleConfig.timeConfigurable?(w(),E(fe,{key:2,fit:"",cover:"",class:"jarvis-HistoryGraph-Menu",target:".jarvis-HistoryGraph-Configuration-"+e.widget.id,onHide:e.onCancel},{default:ye(()=>[ve("div",Ie,[h(f,{class:"text-white",id:"timeType",type:"Select",dense:"",value:e.tempConfig.timeType,onOnSelect:e.onChange,options:e.optionsTimeType},null,8,["value","onOnSelect","options"]),T(h(f,{id:"timeTimelineDate",type:"Date",dense:"",value:e.tempConfig.timeTimelineDate,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[k,e.tempConfig.timeType==="timeline"]]),T(h(f,{id:"timeReviewValue",type:"Number",dense:"",value:e.tempConfig.timeReviewValue,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[k,e.tempConfig.timeType==="review"]]),T(h(f,{id:"timeReviewUnit",type:"Select",dense:"",value:e.tempConfig.timeReviewUnit,options:e.optionsTimeReviewUnits,onOnSelect:e.onChange},null,8,["value","options","onOnSelect"]),[[k,e.tempConfig.timeType==="review"]]),h(Ce),T(h(we,{flat:"",label:e.$t("Apply"),onClick:e.onApply},null,8,["label","onClick"]),[[be]])])]),_:1},8,["target","onHide"])):j("",!0)],2)),[[k,e.loaded]]):j("",!0)],32)}var Pe=oe(Ae,[["render",ze]]);export{Pe as default};
