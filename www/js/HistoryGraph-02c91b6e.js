import{dH as requiredArgs,dS as getTimezoneOffsetInMilliseconds,dI as toDate,bt as _export_sfc,a4 as defineComponent,bN as useIoBroker,co as useQuasar,Q as computed,dc as Modules,dT as ConfigFile,dk as Pro,k as ref,d8 as v4,x as unref,cI as format,as as onMounted,aw as onUnmounted,dz as Devices,bJ as zero,aG as resolveComponent,ay as openBlock,W as createElementBlock,b3 as withDirectives,bn as vShow,a2 as createVNode,d3 as QLinearProgress,U as createBlock,V as createCommentVNode,C as normalizeStyle,A as normalizeClass,D as toDisplayString,b1 as withCtx,X as createBaseVNode,bD as QSpace,bB as QBtn,bE as ClosePopup,by as QMenu,bp as withModifiers,cq as Log,dM as setCssVar,bR as Functions}from"./index-309ef695.js";import"./index-bc443b04.js";import{eW as w}from"./components-5e54cea4.js";import{s as startOfDay}from"./index-b5e8f024.js";import"./_commonjsHelpers-55d1ff45.js";import"./QTooltip-653ede57.js";import"./json-editor-fc6a97bf.js";var MILLISECONDS_IN_DAY=864e5;function differenceInCalendarDays(e,r){requiredArgs(2,arguments);var d=startOfDay(e),v=startOfDay(r),y=d.getTime()-getTimezoneOffsetInMilliseconds(d),p=v.getTime()-getTimezoneOffsetInMilliseconds(v);return Math.round((y-p)/MILLISECONDS_IN_DAY)}function compareLocalAsc(e,r){var d=e.getFullYear()-r.getFullYear()||e.getMonth()-r.getMonth()||e.getDate()-r.getDate()||e.getHours()-r.getHours()||e.getMinutes()-r.getMinutes()||e.getSeconds()-r.getSeconds()||e.getMilliseconds()-r.getMilliseconds();return d<0?-1:d>0?1:d}function differenceInDays(e,r){requiredArgs(2,arguments);var d=toDate(e),v=toDate(r),y=compareLocalAsc(d,v),p=Math.abs(differenceInCalendarDays(d,v));d.setDate(d.getDate()-y*p);var S=Number(compareLocalAsc(d,v)===-y),b=y*(p-S);return b===0?0:b}var HistoryGraph_vue_vue_type_style_index_0_lang="";const _sfc_main=defineComponent({name:"ModuleHistoryGraph",props:["_containerSize","_widgetSize","widget"],provide:{[w]:"dark"},setup(props){var e,r,d,v,y,p,S,b,x,T,L,H,I,O,N,P,z,V,B,K,F;const iobroker=useIoBroker(),$q=useQuasar(),config=computed(()=>props.widget.config),instanceList=((e=iobroker.instanceList)==null?void 0:e.val)||[],from=new Date(new Date().getTime()-7*24*3600*1e3),to=new Date,moduleConfig=computed(()=>({...Modules.joinConfig(config.value,ConfigFile),defaultHistoryAdapter:instanceList.find(o=>["history","sql","influxdb"].includes(o.substr(0,o.indexOf(".")))),stepLineChart:!1,timeTimelineDate:{from:{year:from.getFullYear(),month:from.getMonth()+1,day:from.getDate()},to:{year:to.getFullYear(),month:to.getMonth()+1,day:to.getDate()},...config.value.timeTimelineDate||{}}}));if(Pro.isPro()){if(moduleConfig.value.callback)try{moduleConfig.value.chartCallback=eval(moduleConfig.value.callback);const test=moduleConfig.value.chartCallback&&moduleConfig.value.chartCallback(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.chartCallback,moduleConfig.value.callback,o),moduleConfig.value.chartCallback=null}if(((r=moduleConfig.value.xAxis)==null?void 0:r.min)&&((d=moduleConfig.value.xAxis)==null?void 0:d.min.indexOf("("))!==-1&&((v=moduleConfig.value.xAxis)==null?void 0:v.min.indexOf(")"))!==-1)try{moduleConfig.value.xMin=eval(moduleConfig.value.xAxis.min);const test=moduleConfig.value.xMin&&moduleConfig.value.xMin(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.xMin,moduleConfig.value.callback,o),moduleConfig.value.xMin=null}if(((y=moduleConfig.value.xAxis)==null?void 0:y.max)&&((p=moduleConfig.value.xAxis)==null?void 0:p.max.indexOf("("))!==-1&&((S=moduleConfig.value.xAxis)==null?void 0:S.max.indexOf(")"))!==-1)try{moduleConfig.value.xMax=eval(moduleConfig.value.xAxis.max);const test=moduleConfig.value.xMax&&moduleConfig.value.xMax(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.xMax,moduleConfig.value.callback,o),moduleConfig.value.xMax=null}if(((x=(b=moduleConfig.value.xAxis)==null?void 0:b.axisLabel)==null?void 0:x.formatter)&&((L=(T=moduleConfig.value.xAxis)==null?void 0:T.axisLabel)==null?void 0:L.formatter.indexOf("("))!==-1&&((I=(H=moduleConfig.value.xAxis)==null?void 0:H.axisLabel)==null?void 0:I.formatter.indexOf(")"))!==-1)try{moduleConfig.value.xCallback=eval((N=(O=moduleConfig.value.xAxis)==null?void 0:O.axisLabel)==null?void 0:N.formatter);const test=moduleConfig.value.xCallback&&moduleConfig.value.xCallback(1)}catch(o){console.warn("HistoryGraph",moduleConfig.value.xCallback,(z=(P=moduleConfig.value.xAxis)==null?void 0:P.axisLabel)==null?void 0:z.formatter,o),moduleConfig.value.xCallback=null}else(B=(V=moduleConfig.value.xAxis)==null?void 0:V.axisLabel)!=null&&B.formatter&&(moduleConfig.value.xCallback=(F=(K=moduleConfig.value.xAxis)==null?void 0:K.axisLabel)==null?void 0:F.formatter);const yAxes=!moduleConfig.value.yAxis||Array.isArray(moduleConfig.value.yAxis)?moduleConfig.value.yAxis||[]:[moduleConfig.value.yAxis];yAxes.forEach((yAxis,i)=>{var o,a,n,m,c,g,s,f;if(moduleConfig.value.yCallbacks=moduleConfig.value.yCallbacks||[],((o=yAxis.axisLabel)==null?void 0:o.formatter)&&((a=yAxis.axisLabel)==null?void 0:a.formatter.indexOf("("))!==-1&&((n=yAxis.axisLabel)==null?void 0:n.formatter.indexOf(")"))!==-1)try{moduleConfig.value.yCallbacks[i]=eval((m=yAxis.axisLabel)==null?void 0:m.formatter);const test=moduleConfig.value.yCallbacks[i]&&moduleConfig.value.yCallbacks[i](1)}catch(C){console.warn("HistoryGraph",moduleConfig.value.yCallbacks[i],(g=(c=moduleConfig.value.yAxis)==null?void 0:c.axisLabel)==null?void 0:g.formatter,C),moduleConfig.value.yCallbacks[i]=null}else(s=yAxis.axisLabel)!=null&&s.formatter&&(moduleConfig.value.yCallbacks[i]=(f=yAxis.axisLabel)==null?void 0:f.formatter)})}const userConfig=ref(moduleConfig.value),tempConfig=ref(moduleConfig.value),optionsTimeType=ConfigFile.find(o=>o.parameter==="timeType").options,optionsTimeReviewUnits=ConfigFile.find(o=>o.parameter==="timeReviewUnit").options,loaded=ref(!1),errors=ref({}),key=ref(v4()),chartSeries=ref([]);let chartLabels={};const addSerieToChart=(history,config,state,device)=>{var o,a;Log.dev("Add Serie to Chart",history,config,state,device);let label=config&&config.label||device&&device.name||device&&device.label||"???",data={};config.moduleConfig&&config.moduleConfig.color&&setCssVar("history-graph--"+label.toLowerCase().replace(/ /g,"-").replace(/\./g,"-"),config.moduleConfig.color);let iterations=0;for(;Object.values(chartLabels).includes(label);)iterations++,label=label+" ("+iterations+")";chartLabels[device.id+":"+state.stateKey]=label;const maxEntries=parseInt(moduleConfig.value.maxEntries)||500,drop=history.length>maxEntries?Math.ceil(history.length/maxEntries):null;if(history.forEach(({ts,ack,val},i)=>{var n,m;if(ts=Math.round(ts/1e3)*1e3,ack=ack!=null?ack:"both",(!config.moduleConfig||config.moduleConfig.ack===void 0||config.moduleConfig.ack===null||config.moduleConfig.ack==="both"||config.moduleConfig.ack.toString()===ack.toString()||ack.toString()==="both")&&(drop===null||i%drop===0)){if(typeof val=="boolean"&&(moduleConfig.value.stepLineChart=!0,val=val===!0?1:0),val=parseFloat(val)||val,Pro.isPro()&&config.moduleConfig&&config.moduleConfig.deviceCallback===!0&&((n=state.properties)==null?void 0:n.value))try{const cb=eval((m=state.properties)==null?void 0:m.value);val=cb(val,ts,i)}catch(c){console.warn("HistoryGraph",c.message)}else Pro.isPro()&&moduleConfig.value.chartCallback&&(val=moduleConfig.value.chartCallback(val,ts,i));(!moduleConfig.value.yAxis||moduleConfig.value.yAxis.type!=="log"||moduleConfig.value.yAxis.type==="log"&&val!==0)&&(data[ts]=data[ts]&&data[ts][1]!==null?data[ts]:[ts,val,state.unit||Functions._defaults&&Functions._defaults[config.primaryStateKey]&&Functions._defaults[config.primaryStateKey].unit||""])}}),moduleConfig.value.timeType==="review"&&history.length>0){const n=moduleConfig.value.timeReviewUnit,m=Date.now(),c=(m-history[history.length-1].ts)/1e3,g=Math.floor(c/60),s=Math.floor(g/60),f=Math.floor(s/24),C=Math.floor(f/7),h=Math.floor(f/30);let l=null,u=1;if(n==="months"&&h>1?(l=h,u=30*24*60*60):n==="weeks"&&C>1?(l=C,u=7*24*60*60):n==="days"&&f>1?(l=f,u=24*60*60):n==="hours"&&s>1?(l=s,u=60*60):n==="minutes"&&g>1?(l=g,u=60):n==="seconds"&&c>1&&(l=c,u=1),l)for(let t=history[history.length-1].ts/1e3;t<=Math.floor(m/1e3);t+=u)data[t]=[t*1e3,history[history.length-1].val,state.unit||Functions._defaults&&Functions._defaults[config.primaryStateKey]&&Functions._defaults[config.primaryStateKey].unit||""]}data=Object.values(data);const color=config.moduleConfig&&config.moduleConfig.color?getComputedStyle(document.documentElement).getPropertyValue(config.moduleConfig.color.substr(0,config.moduleConfig.color.length-1).replace("var(",""))||config.moduleConfig.color:void 0,chartSerie={name:label,step:moduleConfig.value.stepLineChart||(moduleConfig.value.chartType==="stepped"?"start":void 0),smooth:moduleConfig.value.chartType==="smooth",showSymbol:moduleConfig.value.showSymbol!==void 0?moduleConfig.value.showSymbol:!1,emphasis:{lineStyle:{width:2}},connectNulls:!0,symbol:"roundRect",...moduleConfig.value.series||{},lineStyle:{width:2,color,...((o=moduleConfig.value.series)==null?void 0:o.lineStyle)||{}},itemStyle:{width:2,color,...((a=moduleConfig.value.series)==null?void 0:a.itemStyle)||{}},type:moduleConfig.value.chartType==="bar"?"bar":"line",yAxisIndex:Pro.isPro()&&moduleConfig.value.yAxis&&Array.isArray(moduleConfig.value.yAxis)&&moduleConfig.value.yAxis.length>1&&config.moduleConfig&&Number.isInteger(config.moduleConfig.yaxis)?config.moduleConfig.yaxis:0,deviceId:config.deviceId,stateKey:config.primaryStateKey,data},findSerieIndex=chartSeries.value.findIndex(n=>n.deviceId===config.deviceId&&n.stateKey===config.primaryStateKey);chartSeries.value[findSerieIndex]=chartSerie,key.value=v4()},subscriptionKeys=[],subscribe=()=>{const o={...moduleConfig.value,...userConfig.value,count:999999,aggregate:"none"};if(o.timeType==="timeline")o.start=new Date(o.timeTimelineDate.from.year,o.timeTimelineDate.from.month-1,o.timeTimelineDate.from.day).getTime(),o.end=new Date(o.timeTimelineDate.to.year,o.timeTimelineDate.to.month-1,o.timeTimelineDate.to.day).getTime(),o.count=differenceInDays(o.end,o.start)*200;else{let a=(o.timeReviewValue||7)*1e3;switch(o.timeReviewUnit){case"seconds":break;case"minutes":a=a*60;break;case"hours":a=a*60*60;break;case"weeks":a=a*60*60*24*7;break;case"months":a=a*60*60*24*31;break;case"days":default:a=a*60*60*24;break}o.review=a}chartLabels={},!props.widget.items||props.widget.items.length===0?(loaded.value=!0,errors.value.noDevices="No devices defined for HistoryGraph!"):(delete errors.value.noDevices,props.widget.items.forEach(a=>{if(a.type==="device"){chartSeries.value.some(t=>t.deviceId===a.deviceId&&t.stateKey===a.primaryStateKey)||chartSeries.value.push({deviceId:a.deviceId,stateKey:a.primaryStateKey,type:moduleConfig.value.chartType==="bar"?"bar":"line",data:[]});const n=(t,{subscriptionKey:M,history:D},A,k)=>{if(Log.dev("Got history data",M,k.id,D&&D.label||k&&k.name||k&&k.label,A,A.stateKey),loaded.value=!0,t||!D){const G=t&&t.message||"Invalid History Data";return errors.value[M]=A.stateKey+": "+G+"!",errors.value}delete errors.value[M],delete chartLabels[k.id+":"+A.stateKey],addSerieToChart(D,a,A,k)},{start:m,end:c,review:g,step:s,count:f,ack:C,ignoreNull:h,aggregate:l}=o,u=Devices.history(a.deviceId,a.primaryStateKey,{timeRefresh:o.timeRefresh,timeReviewUnit:o.timeReviewUnit,start:m,end:c,review:g,step:s,count:f,ack:C,ignoreNull:h,aggregate:l,instance:a.historyAdapter||moduleConfig.value.defaultHistoryAdapter},n);subscriptionKeys.push({subscriptionKey:u,deviceId:a.deviceId,stateKey:a.primaryStateKey})}}))},chartOptions=computed(()=>{var g;const o=Pro.isPro()&&moduleConfig.value.yAxis?moduleConfig.value.yAxis:null;!Pro.isPro()&&(moduleConfig.value.xAxis||moduleConfig.value.yAxis)&&Pro.warn("HistoryGraph: Axis Configuration is only available to Pro!");let a=7;const n=2;let m=90;return moduleConfig.value.zoom&&(a+=10,m-=10),moduleConfig.value.dataZoom&&(m-=17),moduleConfig.value.legend==="top"&&(a+=10,m-=10),moduleConfig.value.legend==="bottom"&&(m-=10),{key:unref(key),backgroundColor:"transparent",tooltip:{trigger:"axis",position:(s,f,C,h,l)=>{const u=s[0],t=l.viewSize[0];return u>t/2?{left:u-l.contentSize[0],top:"10%"}:{left:u,top:"10%"}},formatter:s=>{const f=Array.isArray(s)?s:[],C={};f.forEach(l=>{let[,u,t]=l.data||[];t=typeof t=="object"?t[u]||t.default:t,C[l.seriesId]=""+l.marker+'<span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">'+l.seriesName+'</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">'+(typeof u=="number"?u.toFixed(2):"-")+(t?" "+t:"")+"</span>"});const h=f.find(l=>l.axisType==="xAxis.time");return h?format(h.axisValueLabel,"dd.MM.yyyy, HH:mm:ss")+"<br />"+Object.values(C).join("<br />"):null}},legend:{show:moduleConfig.value.legend!=="off",bottom:moduleConfig.value.legend==="bottom"?moduleConfig.value.dataZoom?50:0:"auto",padding:[10,10,0,10],textStyle:{color:$q.dark.isActive?"#fff":"#666"}},grid:{top:a+"%",left:"2%",right:"2%",bottom:n+"%",containLabel:!0,height:m+"%"},toolbox:{feature:{dataZoom:{show:moduleConfig.value.zoom,yAxisIndex:"none"}}},xAxis:{...Pro.isPro()&&moduleConfig.value.xAxis||{},min:moduleConfig.value.xMin,max:moduleConfig.value.xMax,axisLabel:{fontSize:10,...Pro.isPro()&&((g=moduleConfig.value.xAxis)==null?void 0:g.axisLabel)||{},formatter:Pro.isPro()&&moduleConfig.value.xCallback?moduleConfig.value.xCallback:moduleConfig.value.dateFormat?moduleConfig.value.dateFormat.replace("HH:mm|dd.MM.","{HH}:{mm}|{dd}.{MM}.").replace(/\|/g,`
`):{year:"{yyyy}",month:"{MMM}",day:`
{dd}.{MM}.`,hour:`{HH}:{mm}
{dd}.{MM}.`,minute:"{HH}:{mm}",second:"{HH}:{mm}:{ss}",millisecond:"{hh}:{mm}:{ss} {SSS}",none:"{yyyy}-{MM}-{dd} {hh}:{mm}:{ss} {SSS}"}},type:"time"},yAxis:o&&Array.isArray(o)&&o.length>0?o.map((s,f)=>({axisPointer:{show:!0},splitLine:{lineStyle:{color:"#ccc"}},type:"value",...s||{},axisLabel:{...(s==null?void 0:s.axisLabel)||{},formatter:moduleConfig.value.yCallbacks&&moduleConfig.value.yCallbacks[f]}})):[{axisPointer:{show:!0},splitLine:{lineStyle:{color:"#ccc"}},type:"value",...o||{},axisLabel:{...(o==null?void 0:o.axisLabel)||{},formatter:moduleConfig.value.yCallbacks&&moduleConfig.value.yCallbacks[0]}}],dataZoom:moduleConfig.value.dataZoom&&[{start:100-(moduleConfig.value.dataZoom===1?100:parseInt(moduleConfig.value.dataZoom)||100),end:100}],series:chartSeries.value}}),onApply=()=>{userConfig.value=tempConfig.value,loaded.value=!1,subscribe()},onCancel=()=>{tempConfig.value=userConfig.value},onChange=o=>{tempConfig.value[o.id]=o.value};return onMounted(()=>subscribe()),onUnmounted(()=>{subscriptionKeys.forEach(o=>{Devices.unsubscribe(o.subscriptionKey,o.deviceId,o.stateKey,"history")})}),{zero,loaded,errors,moduleConfig,userConfig,tempConfig,chartOptions,onApply,onCancel,onChange,optionsTimeType,optionsTimeReviewUnits}}}),_hoisted_1={key:0},_hoisted_2={key:1},_hoisted_3={class:"row no-wrap q-pa-sm items-center bg-primary text-white"};function _sfc_render(e,r,d,v,y,p){const S=resolveComponent("alert"),b=resolveComponent("v-chart"),x=resolveComponent("inputs");return openBlock(),createElementBlock("div",{class:"jarvis-HistoryGraph-Container",style:{"min-width":"1px","min-height":"1px"},onTouchstart:r[0]||(r[0]=withModifiers(()=>{},["stop"]))},[withDirectives(createVNode(QLinearProgress,{indeterminate:""},null,512),[[vShow,!e.loaded]]),Object.values(e.errors).length>0?(openBlock(),createBlock(S,{key:0,title:Object.values(e.errors).join("<br />")},null,8,["title"])):createCommentVNode("",!0),e.loaded?(openBlock(),createElementBlock("div",{key:1,class:"jarvis-HistoryGraph",style:normalizeStyle({"min-width":"100%","min-height":"100%",width:(e._widgetSize.width||e._containerSize.width)+"px",height:e._containerSize.height-25+"px"})},[createVNode(b,{autoresize:"",option:e.chartOptions},null,8,["option"])],4)):createCommentVNode("",!0),e.moduleConfig.timeConfigurable?withDirectives((openBlock(),createElementBlock("a",{key:2,class:normalizeClass(["jarvis-HistoryGraph-Configuration","jarvis-HistoryGraph-Configuration-"+e.widget.id])},[e.userConfig.timeType==="timeline"?(openBlock(),createElementBlock("span",_hoisted_1,toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.from.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.from.year)+" - "+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.day))+"."+toDisplayString(e.zero(e.userConfig.timeTimelineDate.to.month))+"."+toDisplayString(e.userConfig.timeTimelineDate.to.year),1)):(openBlock(),createElementBlock("span",_hoisted_2,toDisplayString(e.userConfig.timeReviewValue)+" "+toDisplayString(e.$t(e.userConfig.timeReviewUnit)),1)),e.moduleConfig.timeConfigurable?(openBlock(),createBlock(QMenu,{key:2,fit:"",cover:"",class:"jarvis-HistoryGraph-Menu",target:".jarvis-HistoryGraph-Configuration-"+e.widget.id,onHide:e.onCancel},{default:withCtx(()=>[createBaseVNode("div",_hoisted_3,[createVNode(x,{class:"text-white",id:"timeType",type:"Select",dense:"",value:e.tempConfig.timeType,onOnSelect:e.onChange,options:e.optionsTimeType},null,8,["value","onOnSelect","options"]),withDirectives(createVNode(x,{id:"timeTimelineDate",type:"Date",dense:"",value:e.tempConfig.timeTimelineDate,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="timeline"]]),withDirectives(createVNode(x,{id:"timeReviewValue",type:"Number",dense:"",value:e.tempConfig.timeReviewValue,onOnChange:e.onChange},null,8,["value","onOnChange"]),[[vShow,e.tempConfig.timeType==="review"]]),withDirectives(createVNode(x,{id:"timeReviewUnit",type:"Select",dense:"",value:e.tempConfig.timeReviewUnit,options:e.optionsTimeReviewUnits,onOnSelect:e.onChange},null,8,["value","options","onOnSelect"]),[[vShow,e.tempConfig.timeType==="review"]]),createVNode(QSpace),withDirectives(createVNode(QBtn,{flat:"",label:e.$t("Apply"),onClick:e.onApply},null,8,["label","onClick"]),[[ClosePopup]])])]),_:1},8,["target","onHide"])):createCommentVNode("",!0)],2)),[[vShow,e.loaded]]):createCommentVNode("",!0)],32)}var HistoryGraph=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{HistoryGraph as default};
